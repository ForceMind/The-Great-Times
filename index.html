<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>大时代｜The Great Times</title>
<style>
  :root{--bg:#0f1220;--card:#171a2b;--muted:#8fa0ff;--text:#e6e9ff;--ok:#1bd97b;--bad:#ff5d73;--warn:#ffb547;--btn:#3040ff;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0d1020,#0b0e19);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
  header{padding:12px 16px;border-bottom:1px solid #222846;background:#0c1020;position:sticky;top:0;z-index:2;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  header h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
  header small{color:#aeb6ff;opacity:.9}
  .wrap{display:grid;grid-template-columns:380px 1fr 360px;gap:14px;padding:14px}
  .card{background:var(--card);border:1px solid #262a45;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .section{padding:14px 16px}
  .title{font-size:14px;color:#c9d1ff;letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px}
  .grid{display:grid;gap:10px}
  .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .stat{background:#12152a;border:1px solid #272c4e;border-radius:12px;padding:10px}
  .stat b{display:block;font-size:18px;margin-bottom:2px}
  .muted{color:#a7b1ff}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button,select,input{background:#131736;border:1px solid #2a3161;color:var(--text);border-radius:10px;padding:10px 12px;font-size:14px}
  button.primary{background:var(--btn);border-color:#2937e6}
  button.good{background:rgba(27,217,123,.1);border-color:#1bd97b}
  button.danger{background:rgba(255,93,115,.08);border-color:#ff5d73}
  button.warn{background:rgba(255,181,71,.1);border-color:#ffb547}
  button:disabled{opacity:.5}
  .list{display:grid;gap:8px}
  .item{padding:10px;border:1px solid #29305c;background:#10132a;border-radius:10px}
  .log{max-height:70vh;overflow:auto;padding:0;margin:0;list-style:none}
  .log li{padding:10px 12px;border-bottom:1px solid #262b52}
  .log .good{color:var(--ok)} .log .bad{color:var(--bad)} .log .warn{color:var(--warn)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1440;border:1px solid #2a326a;margin-left:6px;color:#b9c1ff;font-size:12px}
  .role-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .role{padding:10px;border:1px solid #2a3161;border-radius:12px;background:#11142a;cursor:pointer}
  .role.active{outline:2px solid var(--muted);border-color:#5564ff}
  .footnote{opacity:.7;font-size:12px;margin-top:8px}
  .hr{height:1px;background:#262b52;margin:10px 0}
  #roleSection[hidden]{display:none !important}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
</style>
</head>
<body>
  <header>
    <h1>《大时代｜The Great Times》 <small class="pill">文字模拟经营 · 回合制</small></h1>
    <button id="btnSave" class="good">💾 存档</button>
    <button id="btnLoad" class="warn">📂 读档</button>
    <button id="btnReset" class="danger">🗑 新开局</button>
    <span id="saveTip" class="pill">未存档</span>
  </header>

  <div class="wrap">
    <!-- 左：控制与行动 -->
    <div class="card">
      <div class="section">
        <div class="title">回合 & 行动</div>
        <div class="grid">
          <div class="row">
            <button id="btnNext" class="primary">▶ 下一回合</button>
            <button id="btnRest">休整 +恢复健康</button>
            <span id="apInfo" class="pill">AP 0/0</span>
          </div>

          <div class="title">行动（消耗 AP）</div>
          <div class="list">
            <div class="item">
              <div class="row">
                <input id="bizAmt" type="number" min="0" step="100" placeholder="投入金额(做生意)">
                <button id="btnBiz" class="good">做生意</button>
              </div>
              <div class="footnote">预期收益：-20% ~ +60%，与声望、人脉略相关</div>
            </div>

            <div class="item">
              <div class="row">
                <input id="stockAmt" type="number" min="0" step="100" placeholder="买入金额(炒股)">
                <button id="btnStock" class="warn">炒股</button>
              </div>
              <div class="footnote">波动：-40% ~ +80%，受宏观情绪影响</div>
            </div>

            <div class="item">
              <div class="row">
                <input id="gambleAmt" type="number" min="0" step="100" placeholder="赌注(赌博)">
                <button id="btnGamble" class="danger">赌博</button>
              </div>
              <div class="footnote">胜率基础 45%，黑道有加成</div>
            </div>

            <div class="item">
              <div class="row">
                <select id="landType">
                  <option value="郊区地块|8000">郊区地块（¥8,000）</option>
                  <option value="市区地块|20000">市区地块（¥20,000）</option>
                </select>
                <button id="btnBuyLand">买地皮</button>
                <button id="btnSellAsset">卖资产</button>
              </div>
              <div class="footnote">地产在事件中可能暴涨；卖出按当前估值</div>
            </div>

            <div class="item">
              <div class="row">
                <button id="btnStudy">进修/考试</button>
                <button id="btnSocial">人脉活动</button>
                <button id="btnPolitics">从政努力</button>
              </div>
              <div class="footnote">学生/律师/公务员/科学家有额外收益</div>
            </div>

            <!-- 事业体系统 -->
            <div class="item">
              <div class="row">
                <select id="ventureCatalog"></select>
                <button id="btnStartVenture" class="good">开办事业</button>
              </div>
              <div class="row">
                <select id="ownedVenture"></select>
                <button id="btnUpgradeVenture" class="warn">升级事业</button>
              </div>
              <div class="footnote">事业体每回合产出现金流；有维护费与小概率事故；职业有协同加成</div>
            </div>

            <div class="item">
              <div class="row">
                <select id="loanSrc">
                  <option value="bank">银行(年息5%)</option>
                  <option value="private">民间(年息12%)</option>
                  <option value="mafia">黑道(年息20%)</option>
                </select>
                <input id="loanAmt" type="number" min="0" step="100" placeholder="借款金额">
                <button id="btnBorrow">借款(需抵押)</button>
                <button id="btnRepay">还贷</button>
              </div>
              <div class="footnote">抵押优先选择地产/古董/工厂；逾期高风险</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 中：状态面板 -->
    <div class="card">
      <div class="section">
        <div class="title">玩家状态</div>
        <div id="basic" class="grid">
          <div><b>年份：</b><span id="year">—</span>　<b>回合：</b><span id="turn">—</span> <span id="era" class="pill">—</span></div>
          <div class="stats">
            <div class="stat"><b id="funds">¥0</b><span class="muted">资金</span></div>
            <div class="stat"><b id="contacts">0</b><span class="muted">人脉</span></div>
            <div class="stat"><b id="rep">0</b><span class="muted">声望</span></div>
            <div class="stat"><b id="hp">0</b><span class="muted">健康</span></div>
          </div>
          <div class="hr"></div>
          <div class="grid">
            <div><b>身份：</b><span id="roleName">—</span> <span id="roleSkill" class="pill">—</span></div>
            <div><b>目标：</b><span id="roleGoal">—</span></div>
            <div><b>资产：</b><span id="assetList">—</span></div>
            <div><b>负债：</b><span id="debtList">—</span></div>
            <div><b>事业体：</b><span id="ventureList" class="mono">—</span></div>
            <div><b>胜利判定：</b><span id="vict">—</span></div>
          </div>
        </div>
      </div>

      <div class="section" id="roleSection">
        <div class="title">角色选择（12）</div>
        <div class="role-grid" id="roleGrid"></div>
        <div class="row" style="margin-top:8px;">
          <button id="btnStart" class="primary">开始游戏</button>
          <span class="footnote">提示：先选中一个身份，再点击开始</span>
        </div>
      </div>
    </div>

    <!-- 右：事件日志 -->
    <div class="card">
      <div class="section">
        <div class="title">事件日志</div>
        <ul id="log" class="log"></ul>
      </div>
    </div>
  </div>

<script>
// ====== 通用工具 ======
const rnd = (min, max)=>Math.random()*(max-min)+min;
const rndi = (min,max)=>Math.floor(rnd(min,max+1));
const pick = arr => arr[rndi(0,arr.length-1)];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const sum = arr => arr.reduce((a,b)=>a+b,0);

// ====== 角色（12）======
const roles = [
  {name:"学生", funds:1000, contacts:10, assets:[], skill:"学习效率+20%", goal:"考上名校/入科研", tag:"student"},
  {name:"外贸商人", funds:12000, contacts:30, assets:["进出口渠道"], skill:"进出口成本-10%", goal:"年出口额>1000万(缩放)", tag:"trader"},
  {name:"黑道大哥", funds:6000, contacts:50, assets:[], skill:"恐吓成功率+30%", goal:"控制全城地下势力", tag:"mafia"},
  {name:"地产商", funds:20000, contacts:25, assets:["旧厂房"], skill:"土地收购价-15%", goal:"垄断市中心商圈", tag:"realty"},
  {name:"唱歌明星", funds:9000, contacts:20, assets:["录音棚"], skill:"演唱会收入+20%", goal:"国内销量冠军+出海巡演", tag:"idol"},
  {name:"武术家", funds:3000, contacts:15, assets:[], skill:"格斗事件成功率+40%", goal:"国际武馆连锁", tag:"martial"},
  {name:"公务员", funds:5000, contacts:35, assets:[], skill:"政策信息提前获知", goal:"晋升为市长", tag:"official"},
  {name:"厂长", funds:16000, contacts:30, assets:["中型工厂"], skill:"生产成本-10%", goal:"全国最大工业企业", tag:"factory"},
  {name:"律师", funds:8000, contacts:20, assets:["律所"], skill:"打官司胜率+25%", goal:"全国知名大律师", tag:"lawyer"},
  {name:"科学家", funds:4500, contacts:15, assets:["实验室"], skill:"研发速度+20%", goal:"突破性发明", tag:"scientist"},
  {name:"演员", funds:6000, contacts:25, assets:["剧组关系"], skill:"片酬+15%", goal:"国际影帝/后", tag:"actor"},
  {name:"走私商", funds:9000, contacts:40, assets:[], skill:"走私成功率+20%", goal:"控制沿海走私", tag:"smuggler"},
];

// ====== 事业体目录 ======
/*
  字段：
  id, name, cost(首期), upkeep(维护费/回合), baseIncome(基础产出/回合), risk(事故概率), synergy(职业tag加成), desc
  升级：level从1起，upgradeCost = cost*0.6*level，收入=(baseIncome * (1+0.5*(level-1))) * (1+synergyBoost)
*/
const ventureCatalog = [
  {id:"trade",  name:"贸易公司",   cost:8000,  upkeep:500,  baseIncome:2500, risk:0.06, synergy:["trader"],   desc:"接外贸单，受人脉影响"},
  {id:"factory",name:"小型工厂",   cost:12000, upkeep:900,  baseIncome:3200, risk:0.05, synergy:["factory"],  desc:"代工/承包，稳定现金流"},
  {id:"club",   name:"夜总会",     cost:10000, upkeep:1200, baseIncome:3800, risk:0.10, synergy:["mafia"],    desc:"高收益高风险，易被临检"},
  {id:"media",  name:"媒体工作室", cost:7000,  upkeep:400,  baseIncome:2000, risk:0.05, synergy:["actor","idol"], desc:"广告/宣传/经纪"},
  {id:"law",    name:"律所扩张部", cost:9000,  upkeep:600,  baseIncome:2600, risk:0.04, synergy:["lawyer"],  desc:"接案量提升"},
  {id:"dev",    name:"地产开发部", cost:15000, upkeep:1100, baseIncome:4200, risk:0.07, synergy:["realty"],  desc:"滚动拿地/旧改"},
  {id:"lab",    name:"科研工作室", cost:6000,  upkeep:500,  baseIncome:1800, risk:0.05, synergy:["scientist","student"], desc:"技术转化/专利"},
  {id:"event",  name:"演出经纪部", cost:9000,  upkeep:500,  baseIncome:3000, risk:0.08, synergy:["idol","actor"], desc:"巡演/商演"},
];

const synergyBoost = 0.20;

// ====== 年代段（影响事件池）======
function currentEra(year){
  if(year<=1989) return {key:"80s", label:"80年代"};
  if(year<=1997) return {key:"90s", label:"90年代前期"};
  return {key:"late90s", label:"90年代后期"};
}

// ====== 事件池（宏观/行业/个人，外加年代事件）======
const macroEvents = [
  {desc:"国家宣布开放沿海港口，外贸机会大增", condition:null, effect:p=>{p.contacts+=5;}},
  {desc:"股市迎来第一轮牛市，股票普涨", condition:null, effect:p=>{p.funds*=1.25;}},
  {desc:"股市暴跌，投资者损失惨重", condition:null, effect:p=>{p.funds*=0.82;}},
  {desc:"人民币汇率调整，出口企业受益", condition:p=>p.role.tag==="trader", effect:p=>{p.funds+=6000;}},
  {desc:"房地产试点拍卖启动", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("市区地块");}},
  {desc:"基建投资加码，承包商订单涌入", condition:p=>p.role.tag==="factory", effect:p=>{p.funds+=6000;}},
  {desc:"法律制度改革，律师需求激增", condition:p=>p.role.tag==="lawyer", effect:p=>{p.funds+=5000;}},
  {desc:"科研经费提高，重点项目立项", condition:p=>["scientist","student"].includes(p.role.tag), effect:p=>{p.funds+=3000;}},
  {desc:"严打黑社会，夜场巡查频繁", condition:p=>p.role.tag==="mafia", effect:p=>{p.contacts-=10;p.funds-=3000;p.reputation-=5;}},
  {desc:"电影市场复苏，文娱回暖", condition:p=>["actor","idol"].includes(p.role.tag), effect:p=>{p.funds+=3500;}},
  {desc:"港澳资本涌入，社会融资更易", condition:null, effect:p=>{p.contacts+=3;}},
  {desc:"国际油价大涨，运输成本上升", condition:null, effect:p=>{p.funds-=1800;}},
  {desc:"国际金价暴涨，避险情绪升温", condition:null, effect:p=>{p.funds+=2500;}},
  {desc:"城市更新试点，旧改机会出现", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("旧城区改造指标");}},
  {desc:"教育扩招试点，高校名额增加", condition:p=>p.role.tag==="student", effect:p=>{p.reputation+=5;}},
  {desc:"贸易伙伴加征关税，外贸承压", condition:p=>p.role.tag==="trader", effect:p=>{p.funds-=4000;}},
  {desc:"文化审查趋严，演出审批放缓", condition:p=>p.role.tag==="idol", effect:p=>{p.funds-=2000;}},
  {desc:"科技下乡，科研转化政策推出", condition:p=>p.role.tag==="scientist", effect:p=>{p.contacts+=5;p.reputation+=4;}},
  {desc:"地方招商引资，民企税收优惠", condition:null, effect:p=>{p.funds+=1500;p.contacts+=2;}},
  {desc:"治安恶化，夜间经营风险增", condition:null, effect:p=>{p.funds-=1000;}},
  {desc:"农村包产到户深化，个体经济活跃", condition:null, effect:p=>{p.funds+=1200;}},
  {desc:"城市户籍试点改革，人才流动性提高", condition:null, effect:p=>{p.contacts+=2;}},
  {desc:"知识分子地位提升，媒体正向宣传", condition:p=>["scientist","student","lawyer"].includes(p.role.tag), effect:p=>{p.reputation+=6;}},
  {desc:"外汇管制调整，结汇更便利", condition:p=>p.role.tag==="trader", effect:p=>{p.contacts+=3;}},
  {desc:"港口整治，走私通道被严查", condition:p=>p.role.tag==="smuggler", effect:p=>{p.funds-=5000;p.reputation-=4;}},
];

const industryEvents = [
  {desc:"你的工厂获港商投资", condition:p=>p.role.tag==="factory"||p.assets.includes("中型工厂"), effect:p=>{p.funds+=12000;p.contacts+=5;}},
  {desc:"一批进口货被海关扣押", condition:p=>p.role.tag==="trader", effect:p=>{p.funds-=5000;}},
  {desc:"外贸订单暴增，连夜赶工", condition:p=>p.role.tag==="trader", effect:p=>{p.funds+=9000;p.health-=8;}},
  {desc:"承包工程质量过硬，追加合同", condition:p=>p.assets.includes("中型工厂"), effect:p=>{p.funds+=7000;p.reputation+=3;}},
  {desc:"演唱会爆满，票房破纪录", condition:p=>p.role.tag==="idol", effect:p=>{p.funds+=12000;p.reputation+=6;}},
  {desc:"拍摄的电影获奖，片酬上调", condition:p=>p.role.tag==="actor", effect:p=>{p.funds+=8000;p.reputation+=5;}},
  {desc:"影片票房惨败，投资亏损", condition:p=>p.role.tag==="actor", effect:p=>{p.funds-=6000;p.reputation-=3;}},
  {desc:"夜总会遭临检，收入锐减", condition:p=>p.role.tag==="mafia"||hasVenture("club"), effect:p=>{p.funds-=4000;}},
  {desc:"码头关系疏通，走私顺利", condition:p=>p.role.tag==="smuggler", effect:p=>{p.funds+=10000;}},
  {desc:"沿街门面涨租，成本上升", condition:null, effect:p=>{p.funds-=1500;}},
  {desc:"市区地块周边通地铁，地价上扬", condition:p=>p.assets.some(a=>a.includes("市区地块")), effect:p=>{p.funds+=7000;}},
  {desc:"郊区地块被征收，补偿到账", condition:p=>p.assets.some(a=>a.includes("郊区地块")), effect:p=>{p.funds+=6000;}},
  {desc:"拍到一宗优质旧改指标", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("旧改项目指标");}},
  {desc:"律所打赢大案，口碑爆升", condition:p=>p.role.tag==="lawyer"||hasVenture("law"), effect:p=>{p.funds+=11000;p.reputation+=8;}},
  {desc:"官司失利，客户解约", condition:p=>p.role.tag==="lawyer"||hasVenture("law"), effect:p=>{p.funds-=5000;p.reputation-=4;}},
  {desc:"科研成果获国际专利", condition:p=>p.role.tag==="scientist"||hasVenture("lab"), effect:p=>{p.funds+=16000;p.reputation+=8;}},
  {desc:"实验失败，设备报废", condition:p=>p.role.tag==="scientist"||hasVenture("lab"), effect:p=>{p.funds-=7000;}},
  {desc:"学术会议报告成功，结识合作方", condition:p=>["scientist","student"].includes(p.role.tag), effect:p=>{p.contacts+=8;}},
  {desc:"政务考核优秀，调任要职", condition:p=>p.role.tag==="official", effect:p=>{p.contacts+=10;p.reputation+=6;}},
  {desc:"同僚内斗，被边缘化", condition:p=>p.role.tag==="official", effect:p=>{p.contacts-=6;p.reputation-=4;}},
  {desc:"工厂机器故障，维修昂贵", condition:p=>p.assets.includes("中型工厂")||hasVenture("factory"), effect:p=>{p.funds-=4000;}},
  {desc:"购入的地块被曝纠纷，陷入诉讼", condition:p=>p.role.tag==="realty", effect:p=>{p.funds-=5000;p.reputation-=3;}},
  {desc:"歌手商业代言到手", condition:p=>p.role.tag==="idol"||hasVenture("event"), effect:p=>{p.funds+=6000;p.contacts+=3;}},
  {desc:"演出黄牛扰乱秩序，被罚整改", condition:p=>p.role.tag==="idol"||hasVenture("event"), effect:p=>{p.funds-=2000;}},
  {desc:"夜场纠纷升级，黑白两道都来问话", condition:p=>p.role.tag==="mafia"||hasVenture("club"), effect:p=>{p.reputation-=6;}},
];

const personalEvents = [
  {desc:"亲戚求助，需要一笔钱", condition:null, effect:p=>{p.funds-=2000;}},
  {desc:"拾金不昧被报道，人缘上升", condition:null, effect:p=>{p.contacts+=5;p.reputation+=3;}},
  {desc:"意外受伤，行动力下降", condition:null, effect:p=>{p.health-=15;}},
  {desc:"朋友介绍你认识一位官员", condition:null, effect:p=>{p.contacts+=5;}},
  {desc:"孩子出生，生活开销增加", condition:null, effect:p=>{p.funds-=1200;}},
  {desc:"获得一笔遗产", condition:null, effect:p=>{p.funds+=6000;}},
  {desc:"家中失窃", condition:null, effect:p=>{p.funds-=2000;}},
  {desc:"被小偷偷走钱包", condition:null, effect:p=>{p.funds-=800;}},
  {desc:"重感冒，需要休息", condition:null, effect:p=>{p.health-=10;}},
  {desc:"中了福利彩票", condition:null, effect:p=>{p.funds+=4000;}},
  {desc:"投资朋友项目失败", condition:null, effect:p=>{p.funds-=4500;}},
  {desc:"朋友归还旧欠款", condition:null, effect:p=>{p.funds+=2500;}},
  {desc:"街头救人再上新闻", condition:null, effect:p=>{p.contacts+=3;p.reputation+=5;}},
  {desc:"醉酒闹事被抓", condition:null, effect:p=>{p.funds-=1500;p.reputation-=5;}},
  {desc:"赌场手气不错", condition:null, effect:p=>{p.funds+=2500;}},
  {desc:"赌场手气很差", condition:null, effect:p=>{p.funds-=2500;}},
  {desc:"淘到古董，可能升值", condition:null, effect:p=>{p.assets.push("古董");}},
  {desc:"误买赝品，亏损惨重", condition:null, effect:p=>{p.funds-=1800;}},
  {desc:"体检发现旧疾，长期调养", condition:null, effect:p=>{p.health-=8;p.reputation+=1;}},
  {desc:"志愿活动获好评，结识社会贤达", condition:null, effect:p=>{p.contacts+=4;p.reputation+=4;}},
  {desc:"被同行诬告，清白终还但耗费心力", condition:null, effect:p=>{p.funds-=1200;p.health-=5;p.reputation+=2;}},
  {desc:"邻里矛盾调解成功", condition:null, effect:p=>{p.reputation+=3;}},
  {desc:"被卷入民间借贷担保，压力山大", condition:null, effect:p=>{p.funds-=2000;p.reputation-=2;}},
  {desc:"一夜暴富的传言让你被围堵借钱", condition:null, effect:p=>{p.contacts-=3;p.reputation-=2;}},
  {desc:"老友回城，带来商机线索", condition:null, effect:p=>{p.contacts+=6;}},
];

// 年代事件
const eraEventPools = {
  "80s":[
    {desc:"乡镇企业潮兴起，代工机会涌现", effect:p=>{p.funds+=2000;}},
    {desc:"个体户牌照更易申请", effect:p=>{p.contacts+=2;}},
    {desc:"电视机普及，广告行业起步", effect:p=>{if(hasVenture("media")) p.funds+=1500;}},
  ],
  "90s":[
    {desc:"股份制改革讨论热烈，市场预期膨胀", effect:p=>{p.funds+=2500;}},
    {desc:"南方特区吸引力上升，迁移成本下降", effect:p=>{p.contacts+=3;}},
    {desc:"房地产开发热度升温", effect:p=>{if(hasVenture("dev")) p.funds+=3000;}},
  ],
  "late90s":[
    {desc:"互联网概念抬头，媒体流量爆发", effect:p=>{if(hasVenture("media")) p.funds+=4000;p.reputation+=2;}},
    {desc:"演出市场商业化，票务体系成型", effect:p=>{if(hasVenture("event")) p.funds+=3500;}},
    {desc:"监管趋严，夜场经营门槛提高", effect:p=>{if(hasVenture("club")) p.funds-=2000;}},
  ]
};

// ====== 游戏状态 ======
const SAVE_KEY="tgt_save_v1";
const game = {turn:1, year:1980, isOver:false, mood:0};
const player = {role:null,funds:0,contacts:0,reputation:10,health:100,assets:[],debt:[],apMax:2,ap:2, ventures:[]};

// ====== DOM & UI ======
const el = sel => document.querySelector(sel);
const logBox = el("#log");
function log(text, cls=""){ const li=document.createElement("li"); li.innerHTML=text; if(cls) li.classList.add(cls); logBox.prepend(li); const children = logBox.querySelectorAll("li"); if(children.length>20) children[children.length-1].remove(); }
function fmtMoney(v){ return "¥"+Math.round(v).toLocaleString(); }

function refreshVentureUI(){
  // 事业目录
  const cat = el("#ventureCatalog");
  cat.innerHTML = ventureCatalog.map(v=>`<option value="${v.id}">${v.name}（首期${fmtMoney(v.cost)}｜维护${fmtMoney(v.upkeep)}｜基产${fmtMoney(v.baseIncome)}）</option>`).join("");
  // 已有事业
  const own = el("#ownedVenture");
  if(player.ventures.length===0){ own.innerHTML = `<option value="">无可升级的事业</option>`; }
  else{
    own.innerHTML = player.ventures.map((v,i)=>`<option value="${i}">${v.name} Lv.${v.level}（维护${fmtMoney(v.upkeep)}）</option>`).join("");
  }
}

function refresh(){
  const eraObj = currentEra(game.year);
  el("#year").textContent = game.year;
  el("#turn").textContent = game.turn;
  el("#era").textContent = eraObj.label;
  el("#funds").textContent = fmtMoney(player.funds);
  el("#contacts").textContent = Math.round(player.contacts);
  el("#rep").textContent = Math.round(player.reputation);
  el("#hp").textContent = Math.round(player.health);
  el("#roleName").textContent = player.role?player.role.name:"—";
  el("#roleSkill").textContent = player.role?player.role.skill:"—";
  el("#roleGoal").textContent = player.role?player.role.goal:"—";
  el("#assetList").textContent = player.assets.length?player.assets.join("，"):"—";
  el("#debtList").textContent = player.debt.length?player.debt.map((d,i)=>`${i+1}.${d.source}@${Math.round(d.interest*100)}%:${fmtMoney(d.amount)}(回合${d.turn})`).join("；"):"—";
  el("#apInfo").textContent = `AP ${player.ap}/${player.apMax}`;
  el("#ventureList").textContent = player.ventures.length
    ? player.ventures.map(v=>`${v.name} Lv.${v.level} ↑${fmtMoney(ventureIncomePreview(v))}/回`).join("； ")
    : "—";
  el("#vict").textContent = victoryHint();
  el("#btnNext").disabled = !player.role || game.isOver;
  refreshVentureUI();
}
function needAP(n=1){ if(player.ap<n){ log("行动力不足，本回合无法再行动","warn"); return false;} player.ap-=n; refresh(); return true;}

function hasVenture(id){ return player.ventures.some(v=>v.id===id); }

// ====== 初始角色 UI ======
const roleGrid = el("#roleGrid");
let chosenIndex = null;
function renderRoles(){
  roleGrid.innerHTML = "";
  roles.forEach((r,idx)=>{
    const div = document.createElement("div");
    div.className="role";
    div.innerHTML = `<b>${r.name}</b><div class="footnote">${r.skill}</div><div class="footnote">目标：${r.goal}</div>`;
    div.onclick = ()=>{
      chosenIndex = idx;
      [...roleGrid.children].forEach(c=>c.classList.remove("active"));
      div.classList.add("active");
    };
    roleGrid.appendChild(div);
  });
}
renderRoles();

// ====== 存档/读档/新开局 ======
function snapshot(){
  return JSON.stringify({game, player, chosenIndex});
}
function loadFrom(obj){
  Object.assign(game, obj.game);
  Object.assign(player, obj.player);
  chosenIndex = obj.chosenIndex ?? null;
}
function save(){
  localStorage.setItem(SAVE_KEY, snapshot());
  el("#saveTip").textContent = `已存档：回合${game.turn}`;
  log("存档成功","good");
}
function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw){ log("没有找到存档","warn"); return; }
  try{
    const data = JSON.parse(raw);
    loadFrom(data);
    el("#roleSection").hidden = !!player.role; // 若已在游戏中，保持隐藏
    log("读档成功","good");
    refresh();
  }catch(e){ log("读档失败","bad"); }
}
function resetGame(){
  localStorage.removeItem(SAVE_KEY);
  // 软重置到选角
  Object.assign(game,{turn:1,year:1980,isOver:false,mood:0});
  Object.assign(player,{role:null,funds:0,contacts:0,reputation:10,health:100,assets:[],debt:[],apMax:2,ap:2,ventures:[]});
  chosenIndex = null;
  el("#roleSection").hidden = false;
  el("#saveTip").textContent = "未存档";
  log("已重置为新开局","warn");
  refresh();
}
el("#btnSave").onclick = save;
el("#btnLoad").onclick = load;
el("#btnReset").onclick = resetGame;

// ====== 开始游戏（选完身份面板消失）======
el("#btnStart").onclick = ()=>{
  if(chosenIndex==null){ log("请先选择一个身份","warn"); return; }
  const r = roles[chosenIndex];
  player.role = r;
  player.funds = r.funds;
  player.contacts = r.contacts;
  player.assets = [...r.assets];
  player.reputation = 10;
  player.health = 100;
  player.debt = [];
  player.ventures = [];
  game.turn = 1; game.year = 1980; game.isOver=false; player.apMax=2; player.ap=player.apMax; game.mood=0;
  log(`你选择了【${r.name}】。技能：${r.skill}，目标：${r.goal}`,"good");
  el("#roleSection").hidden = true;
  refresh();
};

// ====== 回合推进 ======
function ventureIncomePreview(v){
  const syn = v.synergy.includes(player.role?.tag) ? (1+synergyBoost) : 1;
  const scale = 1 + 0.5*(v.level-1);
  // 人脉/声望的小幅影响
  const soft = 1 + clamp(player.contacts*0.001 + player.reputation*0.0005, -0.2, 0.4);
  return Math.max(0, Math.round(v.baseIncome*scale*syn*soft) - v.upkeep);
}

function settleVentures(){
  if(player.ventures.length===0) return 0;
  let total = 0;
  player.ventures.forEach(v=>{
    // 基础产出
    const income = ventureIncomePreview(v);
    // 事故判定
    if(Math.random()<v.risk){
      const loss = rndi(800, 4000);
      total += (income - loss);
      log(`事业事故：${v.name} 遭遇突发情况，损失 ${fmtMoney(loss)}`,"bad");
    }else{
      total += income;
    }
  });
  player.funds += total;
  if(total!==0) log(`事业体结算：本回合净收益 ${fmtMoney(total)}`, total>=0?"good":"bad");
  return total;
}

function triggerEvents(){
  const pools = [macroEvents, industryEvents, personalEvents];
  pools.forEach(pool=>{
    let candidates = pool.filter(e=>!e.condition || e.condition(player));
    if(candidates.length===0) candidates = pool;
    const ev = pick(candidates);
    ev.effect(player);
    log(`事件：${ev.desc}`);
  });
  // 年代事件额外+1
  const eraKey = currentEra(game.year).key;
  const eraPool = eraEventPools[eraKey];
  if(eraPool && eraPool.length){
    const e = pick(eraPool);
    e.effect(player);
    log(`【年代】${e.desc}`,"warn");
  }
  // 情绪（影响股市波动中枢）
  game.mood = clamp(game.mood + rndi(-1,1), -2, 2);
}

function endTurnCheck(){
  player.health = clamp(player.health, 0, 120);
  if(player.health<=0){ game.isOver=true; log("你因健康问题去世，游戏结束","bad"); }
  if(player.funds< -5000 && player.assets.length===0){ game.isOver=true; log("你资不抵债且无资产，破产 Game Over","bad"); }
  // 债务利息（每回合计息一次）
  player.debt.forEach(d=>{ const age = game.turn - d.turn; if(age>=1){ d.amount = Math.round(d.amount*(1+d.interest)); d.turn=game.turn; }});
  if(checkVictory()){ game.isOver=true; log("你已达成身份目标！恭喜通关《大时代》","good"); }
}

function nextTurn(){
  if(!player.role){ log("请先选择身份并开始游戏","warn"); return; }
  if(game.isOver){ log("游戏已结束，请刷新/新开局","warn"); return; }
  game.turn++; game.year++;
  player.ap = player.apMax; // 恢复行动点
  // 先结算事业体
  settleVentures();
  // 回合随机事件
  triggerEvents();
  // 自然恢复
  player.health = clamp(player.health + 3 + (player.role.tag==="scientist"?1:0), 0, 120);
  endTurnCheck();
  refresh();
}
el("#btnNext").onclick = nextTurn;

// ====== 胜利条件（简化版）======
function checkVictory(){
  const f = player.funds, c = player.contacts, r = player.reputation;
  const has = name => player.assets.some(a=>a.includes(name));
  switch(player.role.tag){
    case "student": return r>=30 && c>=20 && (has("实验室")||f>=50000);
    case "trader":  return f>=1000000/10 || hasVenture("trade") && player.ventures.find(v=>v.id==="trade")?.level>=3;
    case "mafia":   return c>=120 && r>=25 && (hasVenture("club")||player.assets.some(a=>/夜/.test(a)));
    case "realty":  return player.assets.filter(a=>a.includes("地块")).length>=4 && f>=300000/10 || hasVenture("dev")&&player.ventures.find(v=>v.id==="dev")?.level>=3;
    case "idol":    return c>=80 && r>=60 && (hasVenture("event")||hasVenture("media"));
    case "martial": return c>=70 && r>=50;
    case "official":return r>=70 && c>=90;
    case "factory": return f>=500000/10 && (has("中型工厂")||hasVenture("factory"));
    case "lawyer":  return f>=300000/10 && r>=60 && (hasVenture("law"));
    case "scientist":return r>=75 && (f>=200000/10 || hasVenture("lab"));
    case "actor":   return r>=70 && c>=80 && (hasVenture("media")||hasVenture("event"));
    case "smuggler":return f>=500000/10 && c>=80;
  }
  return false;
}
function victoryHint(){
  if(!player.role) return "—";
  return checkVictory() ? "✅ 已满足" : "⏳ 尚未满足，继续努力";
}

// ====== 行动实现 ======
function consumeHealth(base=2){ player.health = clamp(player.health - base, 0, 120); }

el("#btnRest").onclick = ()=>{
  if(!needAP(1)) return;
  const gain = 10 + (player.role.tag==="scientist"?2:0);
  player.health = clamp(player.health + gain, 0, 120);
  log(`休整恢复健康 +${gain}`,"good");
  refresh();
};

// 做生意
el("#btnBiz").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#bizAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("做生意投入金额非法或不足","warn"); return; }
  player.funds -= amt;
  const boost = (player.reputation*0.002 + player.contacts*0.001);
  let roi = rnd(-0.2, 0.6 + boost);
  if(player.role.tag==="factory") roi += 0.05;
  const profit = Math.round(amt * roi);
  player.funds += amt + profit;
  player.reputation += profit>0 ? 2 : -1;
  consumeHealth(3);
  log(`做生意${profit>=0?"盈利":"亏损"}：${profit>=0?"+":""}${fmtMoney(profit)}（ROI ${(roi*100).toFixed(1)}%）`, profit>=0?"good":"bad");
  refresh();
};

// 炒股
el("#btnStock").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#stockAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("炒股金额非法或不足","warn"); return; }
  player.funds -= amt;
  let base = { "-2":[-0.5,0.3], "-1":[-0.45,0.5], "0":[-0.4,0.6], "1":[-0.3,0.7], "2":[-0.2,0.8] }[String(game.mood)];
  let roi = rnd(base[0], base[1]);
  const profit = Math.round(amt*roi);
  player.funds += amt + profit;
  player.reputation += profit>0 ? 1 : 0;
  consumeHealth(2);
  log(`炒股${profit>=0?"盈利":"亏损"}：${profit>=0?"+":""}${fmtMoney(profit)}（市场情绪 ${game.mood>=0?"+":""}${game.mood}）`, profit>=0?"good":"bad");
  refresh();
};

// 赌博
el("#btnGamble").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#gambleAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("赌注非法或不足","warn"); return; }
  let winRate = 0.45;
  if(player.role.tag==="mafia") winRate += 0.1;
  const win = Math.random()<winRate;
  const mult = win ? rnd(0.5,1.5) : -rnd(0.3,1.0);
  const delta = Math.round(amt*mult);
  player.funds += delta;
  player.reputation += win?1:-2;
  consumeHealth(4);
  log(`赌博${win?"赢了":"输了"}：${delta>=0?"+":""}${fmtMoney(delta)}（胜率≈${Math.round(winRate*100)}%）`, delta>=0?"good":"bad");
  refresh();
};

// 买地皮
el("#btnBuyLand").onclick = ()=>{
  if(!needAP(1)) return;
  const [name,priceStr] = el("#landType").value.split("|");
  const price = +priceStr;
  const final = Math.round(price * (player.role.tag==="realty"?0.85:1));
  if(player.funds<final){ log("资金不足，无法买地皮","warn"); return; }
  player.funds -= final;
  player.assets.push(name);
  player.reputation += 1;
  log(`购入资产：${name}（花费 ${fmtMoney(final)}）`,"good");
  refresh();
};

// 卖资产
el("#btnSellAsset").onclick = ()=>{
  if(!needAP(1)) return;
  if(player.assets.length===0){ log("没有可出售的资产","warn"); return; }
  const priceOf = name=>{
    if(name.includes("市区地块")) return rndi(18000,30000);
    if(name.includes("郊区地块")) return rndi(6000,15000);
    if(name.includes("中型工厂")) return rndi(20000,40000);
    if(name.includes("古董")) return rndi(3000,12000);
    return rndi(2000,8000);
  };
  const asset = player.assets.pop();
  const val = priceOf(asset);
  player.funds += val;
  log(`出售资产：${asset}，获得 ${fmtMoney(val)}`,"good");
  refresh();
};

// 进修/考试
el("#btnStudy").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 800;
  if(player.funds<cost){ log("进修需要资金不足","warn"); return; }
  player.funds -= cost;
  let repGain = 4, contGain = 2;
  if(["student","scientist","lawyer"].includes(player.role.tag)) repGain += 2;
  player.reputation += repGain;
  player.contacts += contGain;
  consumeHealth(2);
  log(`进修/考试：声望 +${repGain}，人脉 +${contGain}（学费 ${fmtMoney(cost)}）`,"good");
  refresh();
};

// 人脉活动
el("#btnSocial").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 600;
  if(player.funds<cost){ log("请客送礼需要资金不足","warn"); return; }
  player.funds -= cost;
  let contGain = rndi(3,8);
  if(player.role.tag==="official") contGain+=3;
  player.contacts += contGain;
  player.reputation += 1;
  consumeHealth(2);
  log(`人脉活动：人脉 +${contGain}（花费 ${fmtMoney(cost)}）`,"good");
  refresh();
};

// 从政
el("#btnPolitics").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 1000;
  if(player.funds<cost){ log("从政需要经费不足","warn"); return; }
  player.funds -= cost;
  let rep = rndi(2,6), cont = rndi(2,6);
  if(player.role.tag==="official"){ rep+=3; cont+=3; }
  player.reputation += rep; player.contacts += cont;
  consumeHealth(3);
  log(`从政努力：声望 +${rep}，人脉 +${cont}（费用 ${fmtMoney(cost)}）`,"good");
  refresh();
};

// 借款（需抵押）
el("#btnBorrow").onclick = ()=>{
  if(!needAP(1)) return;
  const src = el("#loanSrc").value;
  const amt = +el("#loanAmt").value||0;
  if(amt<=0){ log("借款金额需大于 0","warn"); return; }
  if(player.assets.length===0){ log("缺少抵押资产，无法借款","warn"); return; }
  const rate = src==="bank"?0.05:src==="private"?0.12:0.20;
  player.funds += amt;
  player.debt.push({amount:amt,interest:rate,source:src,turn:game.turn,collateral:player.assets[0]});
  log(`借款成功：来源 ${src}，金额 ${fmtMoney(amt)}，年息 ${Math.round(rate*100)}%（抵押：${player.assets[0]}）`,"warn");
  refresh();
};

// 还贷（优先最早一笔）
el("#btnRepay").onclick = ()=>{
  if(player.debt.length===0){ log("当前无负债","warn"); return; }
  const d = player.debt[0];
  const total = Math.round(d.amount*(1));
  if(player.funds<total){ log(`资金不足以偿还首笔债务：需 ${fmtMoney(total)}`,"warn"); return; }
  player.funds -= total;
  player.debt.shift();
  log(`已归还债务 ${fmtMoney(total)}（来源 ${d.source}）`,"good");
  refresh();
};

// ====== 事业体：开办与升级 ======
el("#btnStartVenture").onclick = ()=>{
  if(!needAP(1)) return;
  const id = el("#ventureCatalog").value;
  const tpl = ventureCatalog.find(v=>v.id===id);
  if(!tpl) return;
  if(player.funds<tpl.cost){ log("资金不足，无法开办该事业","warn"); return; }
  if(player.ventures.some(v=>v.id===id)){ log("该事业已拥有，可考虑升级","warn"); return; }
  player.funds -= tpl.cost;
  player.ventures.push({id:tpl.id,name:tpl.name,level:1,baseIncome:tpl.baseIncome,upkeep:tpl.upkeep,risk:tpl.risk,synergy:tpl.synergy});
  log(`开办事业：${tpl.name}（首期 ${fmtMoney(tpl.cost)}）`,"good");
  refresh();
};

el("#btnUpgradeVenture").onclick = ()=>{
  if(!needAP(1)) return;
  if(player.ventures.length===0){ log("暂无可升级事业","warn"); return; }
  const idx = +el("#ownedVenture").value;
  if(isNaN(idx) || idx<0 || idx>=player.ventures.length){ log("请选择要升级的事业","warn"); return; }
  const v = player.ventures[idx];
  const baseCost = ventureCatalog.find(t=>t.id===v.id)?.cost || 8000;
  const upgCost = Math.round(baseCost*0.6*v.level);
  if(player.funds<upgCost){ log(`资金不足，升级需要 ${fmtMoney(upgCost)}`,"warn"); return; }
  player.funds -= upgCost;
  v.level += 1;
  // 升级同时略增维护费
  v.upkeep = Math.round(v.upkeep*(1+0.15));
  log(`升级事业：${v.name} → Lv.${v.level}（花费 ${fmtMoney(upgCost)}）`,"good");
  refresh();
};

// ====== 初始化 ======
function init(){
  refresh();
  refreshVentureUI();
}
init();
</script>
</body>
</html>
