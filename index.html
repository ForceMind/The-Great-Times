<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>大时代｜The Great Times</title>
<style>
  :root{--bg:#0f1220;--card:#171a2b;--muted:#8fa0ff;--text:#e6e9ff;--ok:#1bd97b;--bad:#ff5d73;--warn:#ffb547;--btn:#3040ff;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0d1020,#0b0e19);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
  header{padding:12px 16px;border-bottom:1px solid #222846;background:#0c1020;position:sticky;top:0;z-index:2;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  header h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
  header small{color:#aeb6ff;opacity:.9}
  .wrap{display:grid;grid-template-columns:430px 1fr 380px;gap:14px;padding:14px}
  .card{background:var(--card);border:1px solid #262a45;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .section{padding:14px 16px}
  .title{font-size:14px;color:#c9d1ff;letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px}
  .grid{display:grid;gap:10px}
  .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .stat{background:#12152a;border:1px solid #272c4e;border-radius:12px;padding:10px}
  .stat b{display:block;font-size:18px;margin-bottom:2px}
  .muted{color:#a7b1ff}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button,select,input{background:#131736;border:1px solid #2a3161;color:var(--text);border-radius:10px;padding:10px 12px;font-size:14px}
  button.primary{background:var(--btn);border-color:#2937e6}
  button.good{background:rgba(27,217,123,.1);border-color:#1bd97b}
  button.danger{background:rgba(255,93,115,.08);border-color:#ff5d73}
  button.warn{background:rgba(255,181,71,.1);border-color:#ffb547}
  button:disabled{opacity:.5}
  .list{display:grid;gap:8px}
  .item{padding:10px;border:1px solid #29305c;background:#10132a;border-radius:10px}
  .log{max-height:70vh;overflow:auto;padding:0;margin:0;list-style:none}
  .log li{padding:10px 12px;border-bottom:1px solid #262b52}
  .log .good{color:var(--ok)} .log .bad{color:var(--bad)} .log .warn{color:var(--warn)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1440;border:1px solid #2a326a;margin-left:6px;color:#b9c1ff;font-size:12px}
  .role-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .role{padding:10px;border:1px solid #2a3161;border-radius:12px;background:#11142a;cursor:pointer}
  .role.active{outline:2px solid var(--muted);border-color:#5564ff}
  .footnote{opacity:.7;font-size:12px;margin-top:8px}
  .hr{height:1px;background:#262b52;margin:10px 0}
  #roleSection[hidden]{display:none !important}
  #eventChoices{display:none}
  #eventChoices.active{display:block}
  .choice{border:1px dashed #3a4284;border-radius:12px;padding:10px;cursor:pointer;background:#0f1230}
  .choice:hover{border-color:#6a75ff}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}
  .tag{font-size:12px;opacity:.9;margin-left:6px}
</style>
</head>
<body>
  <header>
    <h1>《大时代｜The Great Times》 <small class="pill">文字模拟经营 · 月度回合</small></h1>
    <button id="btnSave" class="good">💾 存档</button>
    <button id="btnLoad" class="warn">📂 读档</button>
    <button id="btnReset" class="danger">🗑 新开局</button>
    <span id="saveTip" class="pill">未存档</span>
  </header>

  <div class="wrap">
    <!-- 左：控制与行动 -->
    <div class="card">
      <div class="section">
        <div class="title">回合 & 行动</div>
        <div class="grid">
          <div class="row">
            <button id="btnNext" class="primary">▶ 进入下月</button>
            <button id="btnRest">休整 +恢复健康</button>
            <span id="apInfo" class="pill">AP 0/0</span>
          </div>

          <div class="title">行动（消耗 AP）</div>
          <div class="list">
            <div class="item">
              <div class="row">
                <input id="bizAmt" type="number" min="0" step="100" placeholder="投入金额(做生意)">
                <button id="btnBiz" class="good">做生意</button>
              </div>
              <div class="footnote">月度收益：约 -8% ~ +20%，与声望、人脉略相关</div>
            </div>

            <div class="item">
              <div class="row">
                <input id="stockAmt" type="number" min="0" step="100" placeholder="买入金额(炒股)">
                <button id="btnStock" class="warn">炒股</button>
              </div>
              <div class="footnote">月度波动：约 -10% ~ +15%，受市场情绪影响</div>
            </div>

            <div class="item">
              <div class="row">
                <input id="gambleAmt" type="number" min="0" step="100" placeholder="赌注(赌博)">
                <button id="btnGamble" class="danger">赌博</button>
              </div>
              <div class="footnote">胜率基础 45%，黑道有加成</div>
            </div>

            <div class="item">
              <div class="row">
                <select id="landType">
                  <option value="郊区地块|6000">郊区地块（¥6,000）</option>
                  <option value="市区地块|15000">市区地块（¥15,000）</option>
                </select>
                <button id="btnBuyLand">买地皮</button>
                <button id="btnSellAsset">卖资产</button>
              </div>
              <div class="footnote">按月度尺度估值；事件/年代会影响地价</div>
            </div>

            <div class="item">
              <div class="row">
                <button id="btnStudy">进修/考试</button>
                <button id="btnSocial">人脉活动</button>
                <button id="btnPolitics">从政努力</button>
              </div>
              <div class="footnote">学生/律师/公务员/科学家职业协同更强</div>
            </div>

            <!-- 事业体系统 -->
            <div class="item">
              <div class="row">
                <select id="ventureCatalog"></select>
                <button id="btnStartVenture" class="good">开办事业</button>
              </div>
              <div class="row">
                <select id="ownedVenture"></select>
                <button id="btnUpgradeVenture" class="warn">升级</button>
                <button id="btnToggleVenture">暂停/恢复</button>
                <button id="btnSellVenture" class="danger">转让</button>
              </div>
              <div class="footnote">事业体每月结算；可暂停(不产出也不维护)，可一次性转让回款</div>
            </div>

            <div class="item">
              <div class="row">
                <select id="loanSrc">
                  <option value="bank">银行(年息5%)</option>
                  <option value="private">民间(年息12%)</option>
                  <option value="mafia">黑道(年息20%)</option>
                </select>
                <input id="loanAmt" type="number" min="0" step="100" placeholder="借款金额">
                <button id="btnBorrow">借款(需抵押)</button>
                <button id="btnRepay">还贷</button>
              </div>
              <div class="footnote">按月计息：年化/12；抵押优先地产/古董/工厂</div>
            </div>
          </div>
        </div>
      </div>

      <!-- 月度事件抉择 -->
      <div class="section" id="eventChoices">
        <div class="title">本月情境（从 3 选 1）</div>
        <div id="choicesWrap" class="grid"></div>
        <div class="footnote">选中即结算；每月仅一次</div>
      </div>
    </div>

    <!-- 中：状态面板 -->
    <div class="card">
      <div class="section">
        <div class="title">玩家状态</div>
        <div id="basic" class="grid">
          <div>
            <b>时间：</b><span id="ym">—</span>
            <span id="era" class="pill">—</span>
            <span id="difficulty" class="pill">—</span>
          </div>
          <div class="stats">
            <div class="stat"><b id="funds">¥0</b><span class="muted">资金</span></div>
            <div class="stat"><b id="contacts">0</b><span class="muted">人脉</span></div>
            <div class="stat"><b id="rep">0</b><span class="muted">声望</span></div>
            <div class="stat"><b id="hp">0</b><span class="muted">健康</span></div>
          </div>
          <div class="hr"></div>
          <div class="grid">
            <div><b>身份：</b><span id="roleName">—</span> <span id="roleSkill" class="pill">—</span></div>
            <div><b>目标：</b><span id="roleGoal">—</span></div>
            <div><b>资产：</b><span id="assetList">—</span></div>
            <div><b>负债：</b><span id="debtList">—</span></div>
            <div><b>事业体：</b><span id="ventureList" class="mono">—</span></div>
            <div><b>胜利判定：</b><span id="vict">—</span></div>
          </div>
        </div>
      </div>

      <div class="section" id="roleSection">
        <div class="title">开局设置</div>
        <div class="grid">
          <div>
            <b>难度：</b>
            <select id="diffSelect">
              <option value="easy">宽信用（低利率、市场更友好）</option>
              <option value="normal" selected>正常</option>
              <option value="hard">紧信用（高利率、市场更冷）</option>
            </select>
          </div>
        </div>
        <div class="hr"></div>
        <div class="title">角色选择（12）</div>
        <div class="role-grid" id="roleGrid"></div>
        <div class="row" style="margin-top:8px;">
          <button id="btnStart" class="primary">开始游戏</button>
          <span class="footnote">提示：选择身份 + 难度，再开始</span>
        </div>
      </div>
    </div>

    <!-- 右：事件日志 -->
    <div class="card">
      <div class="section">
        <div class="title">事件日志</div>
        <ul id="log" class="log"></ul>
      </div>
    </div>
  </div>

<script>
// ====== 工具 ======
const rnd = (min, max)=>Math.random()*(max-min)+min;
const rndi = (min,max)=>Math.floor(rnd(min,max+1));
const pick = arr => arr[rndi(0,arr.length-1)];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const sum = arr => arr.reduce((a,b)=>a+b,0);

// ====== 角色（12）======
const roles = [
  {name:"学生", funds:1200, contacts:10, assets:[], skill:"学习效率+20%", goal:"考上名校/入科研", tag:"student"},
  {name:"外贸商人", funds:14000, contacts:30, assets:["进出口渠道"], skill:"进出口成本-10%", goal:"年出口额>1000万(缩放)", tag:"trader"},
  {name:"黑道大哥", funds:7000, contacts:50, assets:[], skill:"恐吓成功率+30%", goal:"控制全城地下势力", tag:"mafia"},
  {name:"地产商", funds:22000, contacts:25, assets:["旧厂房"], skill:"土地收购价-15%", goal:"垄断市中心商圈", tag:"realty"},
  {name:"唱歌明星", funds:10000, contacts:20, assets:["录音棚"], skill:"演唱会收入+20%", goal:"国内销量冠军+出海巡演", tag:"idol"},
  {name:"武术家", funds:3500, contacts:15, assets:[], skill:"格斗事件成功率+40%", goal:"国际武馆连锁", tag:"martial"},
  {name:"公务员", funds:6000, contacts:35, assets:[], skill:"政策信息提前获知", goal:"晋升为市长", tag:"official"},
  {name:"厂长", funds:17000, contacts:30, assets:["中型工厂"], skill:"生产成本-10%", goal:"全国最大工业企业", tag:"factory"},
  {name:"律师", funds:9000, contacts:20, assets:["律所"], skill:"打官司胜率+25%", goal:"全国知名大律师", tag:"lawyer"},
  {name:"科学家", funds:5000, contacts:15, assets:["实验室"], skill:"研发速度+20%", goal:"突破性发明", tag:"scientist"},
  {name:"演员", funds:7000, contacts:25, assets:["剧组关系"], skill:"片酬+15%", goal:"国际影帝/后", tag:"actor"},
  {name:"走私商", funds:10000, contacts:40, assets:[], skill:"走私成功率+20%", goal:"控制沿海走私", tag:"smuggler"},
];

// ====== 难度（影响利率/市场/事件）======
const difficultyProfiles = {
  easy:   { stockShift:+0.02, bizShift:+0.02, rateMul:0.8, badEventBias:-0.05 },
  normal: { stockShift:+0.00, bizShift:+0.00, rateMul:1.0, badEventBias:+0.00 },
  hard:   { stockShift:-0.02, bizShift:-0.02, rateMul:1.25, badEventBias:+0.06 },
};

// ====== 事业体目录（按月）======
const ventureCatalog = [
  {id:"trade",  name:"贸易公司",   cost:7000,  upkeep:450,  baseIncome:1100, risk:0.05, synergy:["trader"],   desc:"接外贸单，受人脉影响"},
  {id:"factory",name:"小型工厂",   cost:11000, upkeep:800,  baseIncome:1400, risk:0.045, synergy:["factory"],  desc:"代工/承包，稳定现金流"},
  {id:"club",   name:"夜总会",     cost:9000,  upkeep:1000, baseIncome:1700, risk:0.09, synergy:["mafia"],    desc:"高收益高风险，易被临检"},
  {id:"media",  name:"媒体工作室", cost:6500,  upkeep:380,  baseIncome:900,  risk:0.05, synergy:["actor","idol"], desc:"广告/宣传/经纪"},
  {id:"law",    name:"律所扩张部", cost:8000,  upkeep:520,  baseIncome:1200, risk:0.04, synergy:["lawyer"],  desc:"接案量提升"},
  {id:"dev",    name:"地产开发部", cost:13000, upkeep:1000, baseIncome:1800, risk:0.06, synergy:["realty"],  desc:"滚动拿地/旧改"},
  {id:"lab",    name:"科研工作室", cost:5500,  upkeep:420,  baseIncome:800,  risk:0.045, synergy:["scientist","student"], desc:"技术转化/专利"},
  {id:"event",  name:"演出经纪部", cost:8000,  upkeep:450,  baseIncome:1300, risk:0.07, synergy:["idol","actor"], desc:"巡演/商演"},
];
const synergyBoost = 0.20;

// ====== 年代段（按年判断）======
function currentEra(year){
  if(year<=1989) return {key:"80s", label:"80年代"};
  if(year<=1997) return {key:"90s", label:"90年代前期"};
  return {key:"late90s", label:"90年代后期"};
}

// ====== 事件池（改为月度尺度，金额缩小）======
const macroEvents = [
  {desc:"沿海港口开放红利继续释放", condition:null, effect:p=>{p.contacts+=2;}},
  {desc:"股市人气回暖", condition:null, effect:p=>{p.funds*=1.03;}},
  {desc:"股市情绪低迷", condition:null, effect:p=>{p.funds*=0.98;}},
  {desc:"汇率调整利好出口", condition:p=>p.role.tag==="trader", effect:p=>{p.funds+=1200;}},
  {desc:"房地产试点推进", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("城区小地块");}},
  {desc:"基建小幅加码", condition:p=>p.role.tag==="factory", effect:p=>{p.funds+=1000;}},
  {desc:"法律服务需求提升", condition:p=>p.role.tag==="lawyer", effect:p=>{p.funds+=1200;}},
  {desc:"科研经费微增", condition:p=>["scientist","student"].includes(p.role.tag), effect:p=>{p.funds+=800;}},
  {desc:"严打风声趋紧", condition:p=>p.role.tag==="mafia", effect:p=>{p.contacts-=3;p.funds-=800;p.reputation-=2;}},
  {desc:"文娱市场小旺季", condition:p=>["actor","idol"].includes(p.role.tag), effect:p=>{p.funds+=1200;}},
  {desc:"资金面偏松", condition:null, effect:p=>{p.contacts+=1;}},
  {desc:"油价上涨传导", condition:null, effect:p=>{p.funds-=600;}},
  {desc:"金价走强", condition:null, effect:p=>{p.funds+=700;}},
  {desc:"旧改窗口开启", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("旧改指标(小)");}},
  {desc:"高校扩招试点", condition:p=>p.role.tag==="student", effect:p=>{p.reputation+=2;}},
  {desc:"贸易摩擦升温", condition:p=>p.role.tag==="trader", effect:p=>{p.funds-=1000;}},
  {desc:"演出审批趋严", condition:p=>p.role.tag==="idol", effect:p=>{p.funds-=700;}},
  {desc:"科技下乡试点", condition:p=>p.role.tag==="scientist", effect:p=>{p.contacts+=2;p.reputation+=2;}},
  {desc:"税收优惠试点", condition:null, effect:p=>{p.funds+=600;p.contacts+=1;}},
  {desc:"夜间治安不稳", condition:null, effect:p=>{p.funds-=500;}},
  {desc:"个体经济活跃", condition:null, effect:p=>{p.funds+=500;}},
  {desc:"人口流动性提升", condition:null, effect:p=>{p.contacts+=1;}},
  {desc:"知识分子受重视", condition:p=>["scientist","student","lawyer"].includes(p.role.tag), effect:p=>{p.reputation+=2;}},
  {desc:"结汇便利度提升", condition:p=>p.role.tag==="trader", effect:p=>{p.contacts+=1;}},
  {desc:"港口整治趋严", condition:p=>p.role.tag==="smuggler", effect:p=>{p.funds-=1200;p.reputation-=2;}},
];

const industryEvents = [
  {desc:"工厂获小额外来投资", condition:p=>p.role.tag==="factory"||p.assets.includes("中型工厂"), effect:p=>{p.funds+=2500;p.contacts+=2;}},
  {desc:"进口货临检延误", condition:p=>p.role.tag==="trader", effect:p=>{p.funds-=1200;}},
  {desc:"外贸订单增长", condition:p=>p.role.tag==="trader", effect:p=>{p.funds+=2200;p.health-=3;}},
  {desc:"工程质量过硬获追单", condition:p=>p.assets.includes("中型工厂"), effect:p=>{p.funds+=1800;p.reputation+=1;}},
  {desc:"演唱会爆满", condition:p=>p.role.tag==="idol", effect:p=>{p.funds+=3000;p.reputation+=3;}},
  {desc:"电影获奖涨片酬", condition:p=>p.role.tag==="actor", effect:p=>{p.funds+=2200;p.reputation+=2;}},
  {desc:"影片扑街", condition:p=>p.role.tag==="actor", effect:p=>{p.funds-=1800;p.reputation-=1;}},
  {desc:"夜场临检", condition:p=>p.role.tag==="mafia"||hasVenture("club"), effect:p=>{p.funds-=1500;}},
  {desc:"走私通道顺畅", condition:p=>p.role.tag==="smuggler", effect:p=>{p.funds+=2500;}},
  {desc:"门面涨租", condition:null, effect:p=>{p.funds-=600;}},
  {desc:"地铁规划利好市区地块", condition:p=>p.assets.some(a=>a.includes("市区")), effect:p=>{p.funds+=2000;}},
  {desc:"郊区地块被征收补偿", condition:p=>p.assets.some(a=>a.includes("郊区")), effect:p=>{p.funds+=1800;}},
  {desc:"拿下小旧改指标", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("旧改指标(小)");}},
  {desc:"律所大案赢面", condition:p=>p.role.tag==="lawyer"||hasVenture("law"), effect:p=>{p.funds+=2700;p.reputation+=3;}},
  {desc:"官司失利", condition:p=>p.role.tag==="lawyer"||hasVenture("law"), effect:p=>{p.funds-=1800;p.reputation-=2;}},
  {desc:"专利授权落地", condition:p=>p.role.tag==="scientist"||hasVenture("lab"), effect:p=>{p.funds+=3200;p.reputation+=3;}},
  {desc:"实验设备损坏", condition:p=>p.role.tag==="scientist"||hasVenture("lab"), effect:p=>{p.funds-=2200;}},
  {desc:"学术会议拓展合作", condition:p=>["scientist","student"].includes(p.role.tag), effect:p=>{p.contacts+=3;}},
  {desc:"政务考核优秀", condition:p=>p.role.tag==="official", effect:p=>{p.contacts+=4;p.reputation+=3;}},
  {desc:"同僚内斗受挤压", condition:p=>p.role.tag==="official", effect:p=>{p.contacts-=2;p.reputation-=2;}},
  {desc:"机器故障", condition:p=>p.assets.includes("中型工厂")||hasVenture("factory"), effect:p=>{p.funds-=1500;}},
  {desc:"地块纠纷诉讼", condition:p=>p.role.tag==="realty", effect:p=>{p.funds-=1800;p.reputation-=1;}},
  {desc:"商业代言到手", condition:p=>p.role.tag==="idol"||hasVenture("event"), effect:p=>{p.funds+=1600;p.contacts+=1;}},
  {desc:"演出秩序受扰", condition:p=>p.role.tag==="idol"||hasVenture("event"), effect:p=>{p.funds-=900;}},
  {desc:"夜场纠纷发酵", condition:p=>p.role.tag==="mafia"||hasVenture("club"), effect:p=>{p.reputation-=2;}},
];

const personalEvents = [
  {desc:"亲戚借款", condition:null, effect:p=>{p.funds-=600;}},
  {desc:"拾金不昧上报", condition:null, effect:p=>{p.contacts+=1;p.reputation+=1;}},
  {desc:"意外受伤", condition:null, effect:p=>{p.health-=5;}},
  {desc:"介绍认识官员", condition:null, effect:p=>{p.contacts+=2;}},
  {desc:"添置婴儿用品", condition:null, effect:p=>{p.funds-=500;}},
  {desc:"小额遗产到账", condition:null, effect:p=>{p.funds+=1000;}},
  {desc:"家中失窃", condition:null, effect:p=>{p.funds-=800;}},
  {desc:"被偷钱包", condition:null, effect:p=>{p.funds-=300;}},
  {desc:"重感冒", condition:null, effect:p=>{p.health-=3;}},
  {desc:"小奖彩票", condition:null, effect:p=>{p.funds+=900;}},
  {desc:"朋友项目失利", condition:null, effect:p=>{p.funds-=900;}},
  {desc:"朋友还钱", condition:null, effect:p=>{p.funds+=700;}},
  {desc:"街头救人", condition:null, effect:p=>{p.contacts+=1;p.reputation+=2;}},
  {desc:"醉酒风波", condition:null, effect:p=>{p.funds-=500;p.reputation-=2;}},
  {desc:"赌场小赢", condition:null, effect:p=>{p.funds+=700;}},
  {desc:"赌场小输", condition:null, effect:p=>{p.funds-=700;}},
  {desc:"淘到古董", condition:null, effect:p=>{p.assets.push("古董");}},
  {desc:"误买赝品", condition:null, effect:p=>{p.funds-=700;}},
  {desc:"旧疾复发", condition:null, effect:p=>{p.health-=3;}},
  {desc:"志愿活动", condition:null, effect:p=>{p.contacts+=1;p.reputation+=2;}},
  {desc:"被诬告终澄清", condition:null, effect:p=>{p.funds-=400;p.health-=2;p.reputation+=1;}},
  {desc:"邻里调解", condition:null, effect:p=>{p.reputation+=1;}},
  {desc:"为他人担保", condition:null, effect:p=>{p.funds-=800;p.reputation-=1;}},
  {desc:"富贵传言缠身", condition:null, effect:p=>{p.contacts-=1;p.reputation-=1;}},
  {desc:"老友带来商机", condition:null, effect:p=>{p.contacts+=2;}},
];

// 年代事件
const eraEventPools = {
  "80s":[
    {desc:"乡镇企业热潮升温", effect:p=>{p.funds+=600;}},
    {desc:"个体户牌照更易", effect:p=>{p.contacts+=1;}},
    {desc:"电视广告起步", effect:p=>{if(hasVenture("media")) p.funds+=500;}},
  ],
  "90s":[
    {desc:"股份制改革讨论升温", effect:p=>{p.funds+=700;}},
    {desc:"特区吸引力上升", effect:p=>{p.contacts+=2;}},
    {desc:"地产开发升温", effect:p=>{if(hasVenture("dev")) p.funds+=900;}},
  ],
  "late90s":[
    {desc:"互联网概念冒头", effect:p=>{if(hasVenture("media")) p.funds+=1000;p.reputation+=1;}},
    {desc:"演出市场商业化", effect:p=>{if(hasVenture("event")) p.funds+=900;}},
    {desc:"夜场门槛提高", effect:p=>{if(hasVenture("club")) p.funds-=600;}},
  ]
};

// ====== 游戏状态 ======
const SAVE_KEY="tgt_save_v2_monthly";
const game = {turn:1, year:1980, month:1, isOver:false, mood:0, chosenEventDone:false, diff:"normal"};
const player = {role:null,funds:0,contacts:0,reputation:10,health:100,assets:[],debt:[],apMax:2,ap:2, ventures:[]};

// ====== DOM & UI ======
const el = sel => document.querySelector(sel);
const logBox = el("#log");
function log(text, cls=""){ const li=document.createElement("li"); li.innerHTML=text; if(cls) li.classList.add(cls); logBox.prepend(li); const children = logBox.querySelectorAll("li"); if(children.length>30) children[children.length-1].remove(); }
function fmtMoney(v){ return "¥"+Math.round(v).toLocaleString(); }
function ymStr(){ return `${game.year}-${String(game.month).padStart(2,'0')}`; }

function refreshVentureUI(){
  const cat = el("#ventureCatalog");
  cat.innerHTML = ventureCatalog.map(v=>`<option value="${v.id}">${v.name}（首期${fmtMoney(v.cost)}｜维护${fmtMoney(v.upkeep)}｜基产${fmtMoney(v.baseIncome)}）</option>`).join("");
  const own = el("#ownedVenture");
  if(player.ventures.length===0){ own.innerHTML = `<option value="">无事业</option>`; }
  else{
    own.innerHTML = player.ventures.map((v,i)=>`<option value="${i}">${v.name} Lv.${v.level}${v.paused?"（暂停）":""}</option>`).join("");
  }
}
function refresh(){
  const eraObj = currentEra(game.year);
  const diffName = {easy:"宽信用",normal:"正常",hard:"紧信用"}[game.diff];
  el("#ym").textContent = ymStr();
  el("#era").textContent = eraObj.label;
  el("#difficulty").textContent = `难度：${diffName}`;
  el("#funds").textContent = fmtMoney(player.funds);
  el("#contacts").textContent = Math.round(player.contacts);
  el("#rep").textContent = Math.round(player.reputation);
  el("#hp").textContent = Math.round(player.health);
  el("#roleName").textContent = player.role?player.role.name:"—";
  el("#roleSkill").textContent = player.role?player.role.skill:"—";
  el("#roleGoal").textContent = player.role?player.role.goal:"—";
  el("#assetList").textContent = player.assets.length?player.assets.join("，"):"—";
  el("#debtList").textContent = player.debt.length?player.debt.map((d,i)=>`${i+1}.${d.source}@${Math.round(d.annual*100)}%年化:${fmtMoney(d.amount)}(起${d.startY}-${String(d.startM).padStart(2,'0')})`).join("；"):"—";
  el("#apInfo").textContent = `AP ${player.ap}/${player.apMax}`;
  el("#ventureList").textContent = player.ventures.length
    ? player.ventures.map(v=>`${v.name} Lv.${v.level}${v.paused?"(停)":""} ↑${fmtMoney(ventureIncomePreview(v))}/月`).join("； ")
    : "—";
  el("#vict").textContent = victoryHint();
  el("#btnNext").disabled = !player.role || game.isOver || !game.chosenEventDone;
  refreshVentureUI();
  // 事件抉择区可见性
  el("#eventChoices").classList.toggle("active", !game.chosenEventDone && !!player.role && !game.isOver);
}
function needAP(n=1){ if(player.ap<n){ log("行动力不足，本月无法再行动","warn"); return false;} player.ap-=n; refresh(); return true;}
function hasVenture(id){ return player.ventures.some(v=>v.id===id); }

// ====== 初始角色 UI ======
const roleGrid = el("#roleGrid");
let chosenIndex = null;
function renderRoles(){
  roleGrid.innerHTML = "";
  roles.forEach((r,idx)=>{
    const div = document.createElement("div");
    div.className="role";
    div.innerHTML = `<b>${r.name}</b><span class="tag pill">${r.tag}</span><div class="footnote">${r.skill}</div><div class="footnote">目标：${r.goal}</div>`;
    div.onclick = ()=>{
      chosenIndex = idx;
      [...roleGrid.children].forEach(c=>c.classList.remove("active"));
      div.classList.add("active");
    };
    roleGrid.appendChild(div);
  });
}
renderRoles();

// ====== 存档/读档/新开局 ======
function snapshot(){ return JSON.stringify({game, player, chosenIndex}); }
function loadFrom(obj){ Object.assign(game, obj.game); Object.assign(player, obj.player); chosenIndex = obj.chosenIndex ?? null; }
function save(){ localStorage.setItem(SAVE_KEY, snapshot()); el("#saveTip").textContent = `已存档：${ymStr()}`; log("存档成功","good"); }
function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw){ log("没有找到存档","warn"); return; }
  try{
    const data = JSON.parse(raw);
    loadFrom(data);
    el("#roleSection").hidden = !!player.role;
    log("读档成功","good");
    refresh();
  }catch(e){ log("读档失败","bad"); }
}
function resetGame(){
  localStorage.removeItem(SAVE_KEY);
  Object.assign(game,{turn:1,year:1980,month:1,isOver:false,mood:0,chosenEventDone:false,diff:"normal"});
  Object.assign(player,{role:null,funds:0,contacts:0,reputation:10,health:100,assets:[],debt:[],apMax:2,ap:2,ventures:[]});
  chosenIndex = null;
  el("#roleSection").hidden = false;
  el("#saveTip").textContent = "未存档";
  log("已重置为新开局","warn");
  refresh();
}
el("#btnSave").onclick = save;
el("#btnLoad").onclick = load;
el("#btnReset").onclick = resetGame;

// ====== 开始游戏 ======
el("#btnStart").onclick = ()=>{
  if(chosenIndex==null){ log("请先选择一个身份","warn"); return; }
  const r = roles[chosenIndex];
  const diff = el("#diffSelect").value;
  player.role = r;
  player.funds = r.funds;
  player.contacts = r.contacts;
  player.assets = [...r.assets];
  player.reputation = 10;
  player.health = 100;
  player.debt = [];
  player.ventures = [];
  Object.assign(game,{turn:1,year:1980,month:1,isOver:false,mood:0,chosenEventDone:false,diff});
  player.apMax=2; player.ap=player.apMax;
  log(`你选择了【${r.name}】｜难度【${{easy:"宽信用",normal:"正常",hard:"紧信用"}[diff]}】`,"good");
  el("#roleSection").hidden = true;
  // 生成本月抉择
  generateMonthChoices();
  refresh();
};

// ====== 月度推进 ======
function stepMonth(){
  game.turn++;
  game.month++;
  if(game.month>12){ game.month=1; game.year++; }
}
function settleVentures(){
  if(player.ventures.length===0) return 0;
  let total = 0;
  player.ventures.forEach(v=>{
    if(v.paused) return; // 暂停不产出、不维护、无事故
    const income = ventureIncomePreview(v);
    if(Math.random()<v.risk){ const loss = rndi(300, 1500); total += (income - loss); log(`事业事故：${v.name} 损失 ${fmtMoney(loss)}`,"bad"); }
    else total += income;
  });
  player.funds += total;
  if(total!==0) log(`事业体结算：本月净收益 ${fmtMoney(total)}`, total>=0?"good":"bad");
  return total;
}

// 情绪影响（股市波动中枢），难度也影响
function shiftMood(){ game.mood = clamp(game.mood + rndi(-1,1), -2, 2); }

// 生成当月事件抉择（三选一）
function generateMonthChoices(){
  const candidates = [];
  // 按难度给一点“好/坏”倾向
  const bias = difficultyProfiles[game.diff]?.badEventBias || 0;
  const pools = [macroEvents, industryEvents, personalEvents];
  while(candidates.length<3){
    const pool = pick(pools);
    // 条件过滤
    let list = pool.filter(e=>!e.condition || e.condition(player));
    if(!list.length) list = pool;
    let ev = pick(list);
    // 简单避免重复描述
    if(!candidates.find(c=>c.desc===ev.desc)){
      candidates.push(ev);
    }
  }
  // 轻微打分排序（把“可能较差”的靠后）
  if(bias>0) candidates.sort((a,b)=>Math.random()+0.2-0.4); // 紧信用随机更偏坏
  const wrap = el("#choicesWrap");
  wrap.innerHTML = "";
  candidates.forEach((ev,idx)=>{
    const div = document.createElement("div");
    div.className="choice";
    div.innerHTML = `<b>选项 ${idx+1}</b>：${ev.desc}`;
    div.onclick = ()=>{
      ev.effect(player);
      log(`你选择了事件：${ev.desc}`,"warn");
      game.chosenEventDone = true;
      refresh();
    };
    wrap.appendChild(div);
  });
}

// 年代事件（自动 +1）
function triggerEraEvent(){
  const eraKey = currentEra(game.year).key;
  const eraPool = eraEventPools[eraKey];
  if(eraPool && eraPool.length){
    const e = pick(eraPool);
    e.effect(player);
    log(`【年代】${e.desc}`,"warn");
  }
}

function endOfMonth(){
  // 恢复 & 趋势
  player.health = clamp(player.health + 1, 0, 120);
  shiftMood();
  // 债务按月计息
  player.debt.forEach(d=>{
    d.amount = Math.round(d.amount*(1+d.monthly));
  });
  // 失败/胜利
  if(player.health<=0){ game.isOver=true; log("你因健康问题去世，游戏结束","bad"); }
  if(player.funds< -5000 && player.assets.length===0){ game.isOver=true; log("你资不抵债且无资产，破产 Game Over","bad"); }
  if(checkVictory()){ game.isOver=true; log("你已达成身份目标！恭喜通关《大时代》","good"); }
}

function nextTurn(){
  if(!player.role){ log("请先选择身份并开始游戏","warn"); return; }
  if(game.isOver){ log("游戏已结束，请读档或新开局","warn"); return; }
  if(!game.chosenEventDone){ log("请先从本月事件中选择 1 条","warn"); return; }

  // AP 重置
  player.ap = player.apMax;

  // 先结算事业体
  settleVentures();

  // 触发年代加成
  triggerEraEvent();

  // 进入下月
  stepMonth();

  // 本月需要重新选择事件
  game.chosenEventDone = false;
  generateMonthChoices();

  // 结束月度通用结算
  endOfMonth();

  refresh();
}
el("#btnNext").onclick = nextTurn;

// ====== 胜利条件（与之前一致）======
function checkVictory(){
  const f = player.funds, c = player.contacts, r = player.reputation;
  const has = name => player.assets.some(a=>a.includes(name));
  switch(player.role.tag){
    case "student": return r>=30 && c>=20 && (has("实验室")||f>=50000);
    case "trader":  return f>=1000000/10 || hasVenture("trade") && player.ventures.find(v=>v.id==="trade")?.level>=3;
    case "mafia":   return c>=120 && r>=25 && (hasVenture("club")||player.assets.some(a=>/夜/.test(a)));
    case "realty":  return player.assets.filter(a=>a.includes("地块")).length>=4 && f>=300000/10 || hasVenture("dev")&&player.ventures.find(v=>v.id==="dev")?.level>=3;
    case "idol":    return c>=80 && r>=60 && (hasVenture("event")||hasVenture("media"));
    case "martial": return c>=70 && r>=50;
    case "official":return r>=70 && c>=90;
    case "factory": return f>=500000/10 && (has("中型工厂")||hasVenture("factory"));
    case "lawyer":  return f>=300000/10 && r>=60 && (hasVenture("law"));
    case "scientist":return r>=75 && (f>=200000/10 || hasVenture("lab"));
    case "actor":   return r>=70 && c>=80 && (hasVenture("media")||hasVenture("event"));
    case "smuggler":return f>=500000/10 && c>=80;
  }
  return false;
}
function victoryHint(){ if(!player.role) return "—"; return checkVictory() ? "✅ 已满足" : "⏳ 尚未满足，继续努力"; }

// ====== 行动实现（按月）======
function consumeHealth(base=2){ player.health = clamp(player.health - base, 0, 120); }

// 休整
el("#btnRest").onclick = ()=>{
  if(!needAP(1)) return;
  const gain = 6 + (player.role.tag==="scientist"?1:0);
  player.health = clamp(player.health + gain, 0, 120);
  log(`休整恢复健康 +${gain}`,"good");
  refresh();
};

// 做生意（按月 ROI）
el("#btnBiz").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#bizAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("做生意投入金额非法或不足","warn"); return; }
  player.funds -= amt;
  const diff = difficultyProfiles[game.diff]||difficultyProfiles.normal;
  let roi = rnd(-0.08+diff.bizShift, 0.20+diff.bizShift) + (player.reputation*0.001 + player.contacts*0.0005);
  if(player.role.tag==="factory") roi += 0.02;
  const profit = Math.round(amt * roi);
  player.funds += amt + profit;
  player.reputation += profit>0 ? 1 : -1;
  consumeHealth(2);
  log(`做生意${profit>=0?"盈利":"亏损"}：${profit>=0?"+":""}${fmtMoney(profit)}（ROI ${(roi*100).toFixed(1)}%）`, profit>=0?"good":"bad");
  refresh();
};

// 炒股（按月波动）
el("#btnStock").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#stockAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("炒股金额非法或不足","warn"); return; }
  player.funds -= amt;
  const diff = difficultyProfiles[game.diff]||difficultyProfiles.normal;
  let base = { "-2":[-0.12,0.08], "-1":[-0.10,0.12], "0":[-0.10,0.15], "1":[-0.06,0.18], "2":[-0.04,0.20] }[String(game.mood)];
  let roi = rnd(base[0]+diff.stockShift, base[1]+diff.stockShift);
  const profit = Math.round(amt*roi);
  player.funds += amt + profit;
  player.reputation += profit>0 ? 1 : 0;
  consumeHealth(1);
  log(`炒股${profit>=0?"盈利":"亏损"}：${profit>=0?"+":""}${fmtMoney(profit)}（市场情绪 ${game.mood>=0?"+":""}${game.mood}）`, profit>=0?"good":"bad");
  refresh();
};

// 赌博
el("#btnGamble").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#gambleAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("赌注非法或不足","warn"); return; }
  let winRate = 0.45;
  if(player.role.tag==="mafia") winRate += 0.1;
  const win = Math.random()<winRate;
  const mult = win ? rnd(0.4,1.0) : -rnd(0.3,0.9);
  const delta = Math.round(amt*mult);
  player.funds += delta;
  player.reputation += win?1:-2;
  consumeHealth(3);
  log(`赌博${win?"赢了":"输了"}：${delta>=0?"+":""}${fmtMoney(delta)}（胜率≈${Math.round(winRate*100)}%）`, delta>=0?"good":"bad");
  refresh();
};

// 买地皮
el("#btnBuyLand").onclick = ()=>{
  if(!needAP(1)) return;
  const [name,priceStr] = el("#landType").value.split("|");
  const price = +priceStr;
  const final = Math.round(price * (player.role.tag==="realty"?0.85:1));
  if(player.funds<final){ log("资金不足，无法买地皮","warn"); return; }
  player.funds -= final;
  player.assets.push(name);
  player.reputation += 1;
  log(`购入资产：${name}（花费 ${fmtMoney(final)}）`,"good");
  refresh();
};

// 卖资产
el("#btnSellAsset").onclick = ()=>{
  if(!needAP(1)) return;
  if(player.assets.length===0){ log("没有可出售的资产","warn"); return; }
  const priceOf = name=>{
    if(name.includes("市区")) return rndi(14000,24000);
    if(name.includes("郊区")) return rndi(5000,12000);
    if(name.includes("中型工厂")) return rndi(16000,30000);
    if(name.includes("古董")) return rndi(2500,9000);
    return rndi(2000,7000);
  };
  const asset = player.assets.pop();
  const val = priceOf(asset);
  player.funds += val;
  log(`出售资产：${asset}，获得 ${fmtMoney(val)}`,"good");
  refresh();
};

// 进修/考试
el("#btnStudy").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 600;
  if(player.funds<cost){ log("进修需要资金不足","warn"); return; }
  player.funds -= cost;
  let repGain = 3, contGain = 1;
  if(["student","scientist","lawyer"].includes(player.role.tag)) repGain += 1;
  player.reputation += repGain;
  player.contacts += contGain;
  consumeHealth(1);
  log(`进修：声望 +${repGain}，人脉 +${contGain}（学费 ${fmtMoney(cost)}）`,"good");
  refresh();
};

// 人脉活动
el("#btnSocial").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 500;
  if(player.funds<cost){ log("请客送礼需要资金不足","warn"); return; }
  player.funds -= cost;
  let contGain = rndi(2,5);
  if(player.role.tag==="official") contGain+=2;
  player.contacts += contGain;
  player.reputation += 1;
  consumeHealth(1);
  log(`人脉：人脉 +${contGain}（花费 ${fmtMoney(cost)}）`,"good");
  refresh();
};

// 从政
el("#btnPolitics").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 800;
  if(player.funds<cost){ log("从政需要经费不足","warn"); return; }
  player.funds -= cost;
  let rep = rndi(1,4), cont = rndi(1,4);
  if(player.role.tag==="official"){ rep+=2; cont+=2; }
  player.reputation += rep; player.contacts += cont;
  consumeHealth(2);
  log(`从政：声望 +${rep}，人脉 +${cont}（费用 ${fmtMoney(cost)}）`,"good");
  refresh();
};

// 借款（按月计息）
el("#btnBorrow").onclick = ()=>{
  if(!needAP(1)) return;
  const src = el("#loanSrc").value;
  const amt = +el("#loanAmt").value||0;
  if(amt<=0){ log("借款金额需大于 0","warn"); return; }
  if(player.assets.length===0){ log("缺少抵押资产，无法借款","warn"); return; }
  const annual = src==="bank"?0.05:src==="private"?0.12:0.20;
  const monthly = (annual * (difficultyProfiles[game.diff]?.rateMul||1))/12;
  player.funds += amt;
  player.debt.push({amount:amt,annual,monthly,source:src,startY:game.year,startM:game.month,collateral:player.assets[0]});
  log(`借款成功：来源 ${src}，金额 ${fmtMoney(amt)}，月息 ${(monthly*100).toFixed(2)}%（年化${Math.round(annual*100)}%｜抵押：${player.assets[0]}）`,"warn");
  refresh();
};

// 还贷（优先最早一笔）
el("#btnRepay").onclick = ()=>{
  if(player.debt.length===0){ log("当前无负债","warn"); return; }
  const d = player.debt[0];
  const total = Math.round(d.amount);
  if(player.funds<total){ log(`资金不足以偿还首笔债务：需 ${fmtMoney(total)}`,"warn"); return; }
  player.funds -= total;
  player.debt.shift();
  log(`已归还债务 ${fmtMoney(total)}（来源 ${d.source}）`,"good");
  refresh();
};

// ====== 事业体：收益、开办、升级、暂停/恢复、转让 ======
function ventureIncomePreview(v){
  const syn = v.synergy.includes(player.role?.tag) ? (1+synergyBoost) : 1;
  const scale = 1 + 0.5*(v.level-1);
  const soft = 1 + clamp(player.contacts*0.0006 + player.reputation*0.0003, -0.15, 0.3);
  return Math.max(0, Math.round(v.baseIncome*scale*syn*soft) - v.upkeep);
}
el("#btnStartVenture").onclick = ()=>{
  if(!needAP(1)) return;
  const id = el("#ventureCatalog").value;
  const tpl = ventureCatalog.find(v=>v.id===id);
  if(!tpl) return;
  if(player.funds<tpl.cost){ log("资金不足，无法开办该事业","warn"); return; }
  if(player.ventures.some(v=>v.id===id)){ log("该事业已拥有，可考虑升级","warn"); return; }
  player.funds -= tpl.cost;
  player.ventures.push({id:tpl.id,name:tpl.name,level:1,baseIncome:tpl.baseIncome,upkeep:tpl.upkeep,risk:tpl.risk,synergy:tpl.synergy,paused:false});
  log(`开办事业：${tpl.name}（首期 ${fmtMoney(tpl.cost)}）`,"good");
  refresh();
};
el("#btnUpgradeVenture").onclick = ()=>{
  if(!needAP(1)) return;
  if(player.ventures.length===0){ log("暂无可升级事业","warn"); return; }
  const idx = +el("#ownedVenture").value;
  if(isNaN(idx) || idx<0 || idx>=player.ventures.length){ log("请选择要升级的事业","warn"); return; }
  const v = player.ventures[idx];
  const baseCost = ventureCatalog.find(t=>t.id===v.id)?.cost || 7000;
  const upgCost = Math.round(baseCost*0.45*v.level);
  if(player.funds<upgCost){ log(`资金不足，升级需要 ${fmtMoney(upgCost)}`,"warn"); return; }
  player.funds -= upgCost;
  v.level += 1;
  v.upkeep = Math.round(v.upkeep*(1+0.12));
  log(`升级事业：${v.name} → Lv.${v.level}（花费 ${fmtMoney(upgCost)}）`,"good");
  refresh();
};
el("#btnToggleVenture").onclick = ()=>{
  if(player.ventures.length===0){ log("暂无事业可操作","warn"); return; }
  const idx = +el("#ownedVenture").value;
  const v = player.ventures[idx]; if(!v){ log("请选择一个事业","warn"); return; }
  v.paused = !v.paused;
  log(`${v.paused?"暂停":"恢复"}事业：${v.name}`);
  refresh();
};
el("#btnSellVenture").onclick = ()=>{
  if(player.ventures.length===0){ log("暂无事业可转让","warn"); return; }
  const idx = +el("#ownedVenture").value;
  const v = player.ventures[idx]; if(!v){ log("请选择一个事业","warn"); return; }
  // 转让价格：最近净产出 * 8 ~ 12 + 基础回本折价
  const tpl = ventureCatalog.find(t=>t.id===v.id);
  const preview = Math.max(0, ventureIncomePreview(v));
  const price = Math.round(preview * rndi(8,12) + (tpl.cost*0.4));
  player.funds += price;
  player.ventures.splice(idx,1);
  log(`转让事业：${v.name}，获得 ${fmtMoney(price)}`,"good");
  refresh();
};

// ====== 事件抉择生成 & 入口 ======
function init(){
  refresh();
  refreshVentureUI();
}
init();

// ====== 选择区容器 & 挂载 ======
function hasCondition(ev){ return !ev.condition || ev.condition(player); }

// 下一月按钮
// （已经在上方绑定）
// 事件区在每月开始已生成，必须先选中一个才可“进入下月”
</script>
</body>
</html>
