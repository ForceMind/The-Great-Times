<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å¤§æ—¶ä»£ï½œThe Great Times</title>
<style>
  :root{--bg:#0f1220;--card:#171a2b;--muted:#8fa0ff;--text:#e6e9ff;--ok:#1bd97b;--bad:#ff5d73;--warn:#ffb547;--btn:#3040ff;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0d1020,#0b0e19);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
  header{padding:12px 16px;border-bottom:1px solid #222846;background:#0c1020;position:sticky;top:0;z-index:2;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  header h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
  header small{color:#aeb6ff;opacity:.9}
  .wrap{display:grid;grid-template-columns:380px 1fr 360px;gap:14px;padding:14px}
  .card{background:var(--card);border:1px solid #262a45;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .section{padding:14px 16px}
  .title{font-size:14px;color:#c9d1ff;letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px}
  .grid{display:grid;gap:10px}
  .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .stat{background:#12152a;border:1px solid #272c4e;border-radius:12px;padding:10px}
  .stat b{display:block;font-size:18px;margin-bottom:2px}
  .muted{color:#a7b1ff}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button,select,input{background:#131736;border:1px solid #2a3161;color:var(--text);border-radius:10px;padding:10px 12px;font-size:14px}
  button.primary{background:var(--btn);border-color:#2937e6}
  button.good{background:rgba(27,217,123,.1);border-color:#1bd97b}
  button.danger{background:rgba(255,93,115,.08);border-color:#ff5d73}
  button.warn{background:rgba(255,181,71,.1);border-color:#ffb547}
  button:disabled{opacity:.5}
  .list{display:grid;gap:8px}
  .item{padding:10px;border:1px solid #29305c;background:#10132a;border-radius:10px}
  .log{max-height:70vh;overflow:auto;padding:0;margin:0;list-style:none}
  .log li{padding:10px 12px;border-bottom:1px solid #262b52}
  .log .good{color:var(--ok)} .log .bad{color:var(--bad)} .log .warn{color:var(--warn)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1440;border:1px solid #2a326a;margin-left:6px;color:#b9c1ff;font-size:12px}
  .role-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .role{padding:10px;border:1px solid #2a3161;border-radius:12px;background:#11142a;cursor:pointer}
  .role.active{outline:2px solid var(--muted);border-color:#5564ff}
  .footnote{opacity:.7;font-size:12px;margin-top:8px}
  .hr{height:1px;background:#262b52;margin:10px 0}
  #roleSection[hidden]{display:none !important}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
</style>
</head>
<body>
  <header>
    <h1>ã€Šå¤§æ—¶ä»£ï½œThe Great Timesã€‹ <small class="pill">æ–‡å­—æ¨¡æ‹Ÿç»è¥ Â· å›åˆåˆ¶</small></h1>
    <button id="btnSave" class="good">ğŸ’¾ å­˜æ¡£</button>
    <button id="btnLoad" class="warn">ğŸ“‚ è¯»æ¡£</button>
    <button id="btnReset" class="danger">ğŸ—‘ æ–°å¼€å±€</button>
    <span id="saveTip" class="pill">æœªå­˜æ¡£</span>
  </header>

  <div class="wrap">
    <!-- å·¦ï¼šæ§åˆ¶ä¸è¡ŒåŠ¨ -->
    <div class="card">
      <div class="section">
        <div class="title">å›åˆ & è¡ŒåŠ¨</div>
        <div class="grid">
          <div class="row">
            <button id="btnNext" class="primary">â–¶ ä¸‹ä¸€å›åˆ</button>
            <button id="btnRest">ä¼‘æ•´ +æ¢å¤å¥åº·</button>
            <span id="apInfo" class="pill">AP 0/0</span>
          </div>

          <div class="title">è¡ŒåŠ¨ï¼ˆæ¶ˆè€— APï¼‰</div>
          <div class="list">
            <div class="item">
              <div class="row">
                <input id="bizAmt" type="number" min="0" step="100" placeholder="æŠ•å…¥é‡‘é¢(åšç”Ÿæ„)">
                <button id="btnBiz" class="good">åšç”Ÿæ„</button>
              </div>
              <div class="footnote">é¢„æœŸæ”¶ç›Šï¼š-20% ~ +60%ï¼Œä¸å£°æœ›ã€äººè„‰ç•¥ç›¸å…³</div>
            </div>

            <div class="item">
              <div class="row">
                <input id="stockAmt" type="number" min="0" step="100" placeholder="ä¹°å…¥é‡‘é¢(ç‚’è‚¡)">
                <button id="btnStock" class="warn">ç‚’è‚¡</button>
              </div>
              <div class="footnote">æ³¢åŠ¨ï¼š-40% ~ +80%ï¼Œå—å®è§‚æƒ…ç»ªå½±å“</div>
            </div>

            <div class="item">
              <div class="row">
                <input id="gambleAmt" type="number" min="0" step="100" placeholder="èµŒæ³¨(èµŒåš)">
                <button id="btnGamble" class="danger">èµŒåš</button>
              </div>
              <div class="footnote">èƒœç‡åŸºç¡€ 45%ï¼Œé»‘é“æœ‰åŠ æˆ</div>
            </div>

            <div class="item">
              <div class="row">
                <select id="landType">
                  <option value="éƒŠåŒºåœ°å—|8000">éƒŠåŒºåœ°å—ï¼ˆÂ¥8,000ï¼‰</option>
                  <option value="å¸‚åŒºåœ°å—|20000">å¸‚åŒºåœ°å—ï¼ˆÂ¥20,000ï¼‰</option>
                </select>
                <button id="btnBuyLand">ä¹°åœ°çš®</button>
                <button id="btnSellAsset">å–èµ„äº§</button>
              </div>
              <div class="footnote">åœ°äº§åœ¨äº‹ä»¶ä¸­å¯èƒ½æš´æ¶¨ï¼›å–å‡ºæŒ‰å½“å‰ä¼°å€¼</div>
            </div>

            <div class="item">
              <div class="row">
                <button id="btnStudy">è¿›ä¿®/è€ƒè¯•</button>
                <button id="btnSocial">äººè„‰æ´»åŠ¨</button>
                <button id="btnPolitics">ä»æ”¿åŠªåŠ›</button>
              </div>
              <div class="footnote">å­¦ç”Ÿ/å¾‹å¸ˆ/å…¬åŠ¡å‘˜/ç§‘å­¦å®¶æœ‰é¢å¤–æ”¶ç›Š</div>
            </div>

            <!-- äº‹ä¸šä½“ç³»ç»Ÿ -->
            <div class="item">
              <div class="row">
                <select id="ventureCatalog"></select>
                <button id="btnStartVenture" class="good">å¼€åŠäº‹ä¸š</button>
              </div>
              <div class="row">
                <select id="ownedVenture"></select>
                <button id="btnUpgradeVenture" class="warn">å‡çº§äº‹ä¸š</button>
              </div>
              <div class="footnote">äº‹ä¸šä½“æ¯å›åˆäº§å‡ºç°é‡‘æµï¼›æœ‰ç»´æŠ¤è´¹ä¸å°æ¦‚ç‡äº‹æ•…ï¼›èŒä¸šæœ‰ååŒåŠ æˆ</div>
            </div>

            <div class="item">
              <div class="row">
                <select id="loanSrc">
                  <option value="bank">é“¶è¡Œ(å¹´æ¯5%)</option>
                  <option value="private">æ°‘é—´(å¹´æ¯12%)</option>
                  <option value="mafia">é»‘é“(å¹´æ¯20%)</option>
                </select>
                <input id="loanAmt" type="number" min="0" step="100" placeholder="å€Ÿæ¬¾é‡‘é¢">
                <button id="btnBorrow">å€Ÿæ¬¾(éœ€æŠµæŠ¼)</button>
                <button id="btnRepay">è¿˜è´·</button>
              </div>
              <div class="footnote">æŠµæŠ¼ä¼˜å…ˆé€‰æ‹©åœ°äº§/å¤è‘£/å·¥å‚ï¼›é€¾æœŸé«˜é£é™©</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ä¸­ï¼šçŠ¶æ€é¢æ¿ -->
    <div class="card">
      <div class="section">
        <div class="title">ç©å®¶çŠ¶æ€</div>
        <div id="basic" class="grid">
          <div><b>å¹´ä»½ï¼š</b><span id="year">â€”</span>ã€€<b>å›åˆï¼š</b><span id="turn">â€”</span> <span id="era" class="pill">â€”</span></div>
          <div class="stats">
            <div class="stat"><b id="funds">Â¥0</b><span class="muted">èµ„é‡‘</span></div>
            <div class="stat"><b id="contacts">0</b><span class="muted">äººè„‰</span></div>
            <div class="stat"><b id="rep">0</b><span class="muted">å£°æœ›</span></div>
            <div class="stat"><b id="hp">0</b><span class="muted">å¥åº·</span></div>
          </div>
          <div class="hr"></div>
          <div class="grid">
            <div><b>èº«ä»½ï¼š</b><span id="roleName">â€”</span> <span id="roleSkill" class="pill">â€”</span></div>
            <div><b>ç›®æ ‡ï¼š</b><span id="roleGoal">â€”</span></div>
            <div><b>èµ„äº§ï¼š</b><span id="assetList">â€”</span></div>
            <div><b>è´Ÿå€ºï¼š</b><span id="debtList">â€”</span></div>
            <div><b>äº‹ä¸šä½“ï¼š</b><span id="ventureList" class="mono">â€”</span></div>
            <div><b>èƒœåˆ©åˆ¤å®šï¼š</b><span id="vict">â€”</span></div>
          </div>
        </div>
      </div>

      <div class="section" id="roleSection">
        <div class="title">è§’è‰²é€‰æ‹©ï¼ˆ12ï¼‰</div>
        <div class="role-grid" id="roleGrid"></div>
        <div class="row" style="margin-top:8px;">
          <button id="btnStart" class="primary">å¼€å§‹æ¸¸æˆ</button>
          <span class="footnote">æç¤ºï¼šå…ˆé€‰ä¸­ä¸€ä¸ªèº«ä»½ï¼Œå†ç‚¹å‡»å¼€å§‹</span>
        </div>
      </div>
    </div>

    <!-- å³ï¼šäº‹ä»¶æ—¥å¿— -->
    <div class="card">
      <div class="section">
        <div class="title">äº‹ä»¶æ—¥å¿—</div>
        <ul id="log" class="log"></ul>
      </div>
    </div>
  </div>

<script>
// ====== é€šç”¨å·¥å…· ======
const rnd = (min, max)=>Math.random()*(max-min)+min;
const rndi = (min,max)=>Math.floor(rnd(min,max+1));
const pick = arr => arr[rndi(0,arr.length-1)];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const sum = arr => arr.reduce((a,b)=>a+b,0);

// ====== è§’è‰²ï¼ˆ12ï¼‰======
const roles = [
  {name:"å­¦ç”Ÿ", funds:1000, contacts:10, assets:[], skill:"å­¦ä¹ æ•ˆç‡+20%", goal:"è€ƒä¸Šåæ ¡/å…¥ç§‘ç ”", tag:"student"},
  {name:"å¤–è´¸å•†äºº", funds:12000, contacts:30, assets:["è¿›å‡ºå£æ¸ é“"], skill:"è¿›å‡ºå£æˆæœ¬-10%", goal:"å¹´å‡ºå£é¢>1000ä¸‡(ç¼©æ”¾)", tag:"trader"},
  {name:"é»‘é“å¤§å“¥", funds:6000, contacts:50, assets:[], skill:"æå“æˆåŠŸç‡+30%", goal:"æ§åˆ¶å…¨åŸåœ°ä¸‹åŠ¿åŠ›", tag:"mafia"},
  {name:"åœ°äº§å•†", funds:20000, contacts:25, assets:["æ—§å‚æˆ¿"], skill:"åœŸåœ°æ”¶è´­ä»·-15%", goal:"å„æ–­å¸‚ä¸­å¿ƒå•†åœˆ", tag:"realty"},
  {name:"å”±æ­Œæ˜æ˜Ÿ", funds:9000, contacts:20, assets:["å½•éŸ³æ£š"], skill:"æ¼”å”±ä¼šæ”¶å…¥+20%", goal:"å›½å†…é”€é‡å† å†›+å‡ºæµ·å·¡æ¼”", tag:"idol"},
  {name:"æ­¦æœ¯å®¶", funds:3000, contacts:15, assets:[], skill:"æ ¼æ–—äº‹ä»¶æˆåŠŸç‡+40%", goal:"å›½é™…æ­¦é¦†è¿é”", tag:"martial"},
  {name:"å…¬åŠ¡å‘˜", funds:5000, contacts:35, assets:[], skill:"æ”¿ç­–ä¿¡æ¯æå‰è·çŸ¥", goal:"æ™‹å‡ä¸ºå¸‚é•¿", tag:"official"},
  {name:"å‚é•¿", funds:16000, contacts:30, assets:["ä¸­å‹å·¥å‚"], skill:"ç”Ÿäº§æˆæœ¬-10%", goal:"å…¨å›½æœ€å¤§å·¥ä¸šä¼ä¸š", tag:"factory"},
  {name:"å¾‹å¸ˆ", funds:8000, contacts:20, assets:["å¾‹æ‰€"], skill:"æ‰“å®˜å¸èƒœç‡+25%", goal:"å…¨å›½çŸ¥åå¤§å¾‹å¸ˆ", tag:"lawyer"},
  {name:"ç§‘å­¦å®¶", funds:4500, contacts:15, assets:["å®éªŒå®¤"], skill:"ç ”å‘é€Ÿåº¦+20%", goal:"çªç ´æ€§å‘æ˜", tag:"scientist"},
  {name:"æ¼”å‘˜", funds:6000, contacts:25, assets:["å‰§ç»„å…³ç³»"], skill:"ç‰‡é…¬+15%", goal:"å›½é™…å½±å¸/å", tag:"actor"},
  {name:"èµ°ç§å•†", funds:9000, contacts:40, assets:[], skill:"èµ°ç§æˆåŠŸç‡+20%", goal:"æ§åˆ¶æ²¿æµ·èµ°ç§", tag:"smuggler"},
];

// ====== äº‹ä¸šä½“ç›®å½• ======
/*
  å­—æ®µï¼š
  id, name, cost(é¦–æœŸ), upkeep(ç»´æŠ¤è´¹/å›åˆ), baseIncome(åŸºç¡€äº§å‡º/å›åˆ), risk(äº‹æ•…æ¦‚ç‡), synergy(èŒä¸štagåŠ æˆ), desc
  å‡çº§ï¼šlevelä»1èµ·ï¼ŒupgradeCost = cost*0.6*levelï¼Œæ”¶å…¥=(baseIncome * (1+0.5*(level-1))) * (1+synergyBoost)
*/
const ventureCatalog = [
  {id:"trade",  name:"è´¸æ˜“å…¬å¸",   cost:8000,  upkeep:500,  baseIncome:2500, risk:0.06, synergy:["trader"],   desc:"æ¥å¤–è´¸å•ï¼Œå—äººè„‰å½±å“"},
  {id:"factory",name:"å°å‹å·¥å‚",   cost:12000, upkeep:900,  baseIncome:3200, risk:0.05, synergy:["factory"],  desc:"ä»£å·¥/æ‰¿åŒ…ï¼Œç¨³å®šç°é‡‘æµ"},
  {id:"club",   name:"å¤œæ€»ä¼š",     cost:10000, upkeep:1200, baseIncome:3800, risk:0.10, synergy:["mafia"],    desc:"é«˜æ”¶ç›Šé«˜é£é™©ï¼Œæ˜“è¢«ä¸´æ£€"},
  {id:"media",  name:"åª’ä½“å·¥ä½œå®¤", cost:7000,  upkeep:400,  baseIncome:2000, risk:0.05, synergy:["actor","idol"], desc:"å¹¿å‘Š/å®£ä¼ /ç»çºª"},
  {id:"law",    name:"å¾‹æ‰€æ‰©å¼ éƒ¨", cost:9000,  upkeep:600,  baseIncome:2600, risk:0.04, synergy:["lawyer"],  desc:"æ¥æ¡ˆé‡æå‡"},
  {id:"dev",    name:"åœ°äº§å¼€å‘éƒ¨", cost:15000, upkeep:1100, baseIncome:4200, risk:0.07, synergy:["realty"],  desc:"æ»šåŠ¨æ‹¿åœ°/æ—§æ”¹"},
  {id:"lab",    name:"ç§‘ç ”å·¥ä½œå®¤", cost:6000,  upkeep:500,  baseIncome:1800, risk:0.05, synergy:["scientist","student"], desc:"æŠ€æœ¯è½¬åŒ–/ä¸“åˆ©"},
  {id:"event",  name:"æ¼”å‡ºç»çºªéƒ¨", cost:9000,  upkeep:500,  baseIncome:3000, risk:0.08, synergy:["idol","actor"], desc:"å·¡æ¼”/å•†æ¼”"},
];

const synergyBoost = 0.20;

// ====== å¹´ä»£æ®µï¼ˆå½±å“äº‹ä»¶æ± ï¼‰======
function currentEra(year){
  if(year<=1989) return {key:"80s", label:"80å¹´ä»£"};
  if(year<=1997) return {key:"90s", label:"90å¹´ä»£å‰æœŸ"};
  return {key:"late90s", label:"90å¹´ä»£åæœŸ"};
}

// ====== äº‹ä»¶æ± ï¼ˆå®è§‚/è¡Œä¸š/ä¸ªäººï¼Œå¤–åŠ å¹´ä»£äº‹ä»¶ï¼‰======
const macroEvents = [
  {desc:"å›½å®¶å®£å¸ƒå¼€æ”¾æ²¿æµ·æ¸¯å£ï¼Œå¤–è´¸æœºä¼šå¤§å¢", condition:null, effect:p=>{p.contacts+=5;}},
  {desc:"è‚¡å¸‚è¿æ¥ç¬¬ä¸€è½®ç‰›å¸‚ï¼Œè‚¡ç¥¨æ™®æ¶¨", condition:null, effect:p=>{p.funds*=1.25;}},
  {desc:"è‚¡å¸‚æš´è·Œï¼ŒæŠ•èµ„è€…æŸå¤±æƒ¨é‡", condition:null, effect:p=>{p.funds*=0.82;}},
  {desc:"äººæ°‘å¸æ±‡ç‡è°ƒæ•´ï¼Œå‡ºå£ä¼ä¸šå—ç›Š", condition:p=>p.role.tag==="trader", effect:p=>{p.funds+=6000;}},
  {desc:"æˆ¿åœ°äº§è¯•ç‚¹æ‹å–å¯åŠ¨", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("å¸‚åŒºåœ°å—");}},
  {desc:"åŸºå»ºæŠ•èµ„åŠ ç ï¼Œæ‰¿åŒ…å•†è®¢å•æ¶Œå…¥", condition:p=>p.role.tag==="factory", effect:p=>{p.funds+=6000;}},
  {desc:"æ³•å¾‹åˆ¶åº¦æ”¹é©ï¼Œå¾‹å¸ˆéœ€æ±‚æ¿€å¢", condition:p=>p.role.tag==="lawyer", effect:p=>{p.funds+=5000;}},
  {desc:"ç§‘ç ”ç»è´¹æé«˜ï¼Œé‡ç‚¹é¡¹ç›®ç«‹é¡¹", condition:p=>["scientist","student"].includes(p.role.tag), effect:p=>{p.funds+=3000;}},
  {desc:"ä¸¥æ‰“é»‘ç¤¾ä¼šï¼Œå¤œåœºå·¡æŸ¥é¢‘ç¹", condition:p=>p.role.tag==="mafia", effect:p=>{p.contacts-=10;p.funds-=3000;p.reputation-=5;}},
  {desc:"ç”µå½±å¸‚åœºå¤è‹ï¼Œæ–‡å¨±å›æš–", condition:p=>["actor","idol"].includes(p.role.tag), effect:p=>{p.funds+=3500;}},
  {desc:"æ¸¯æ¾³èµ„æœ¬æ¶Œå…¥ï¼Œç¤¾ä¼šèèµ„æ›´æ˜“", condition:null, effect:p=>{p.contacts+=3;}},
  {desc:"å›½é™…æ²¹ä»·å¤§æ¶¨ï¼Œè¿è¾“æˆæœ¬ä¸Šå‡", condition:null, effect:p=>{p.funds-=1800;}},
  {desc:"å›½é™…é‡‘ä»·æš´æ¶¨ï¼Œé¿é™©æƒ…ç»ªå‡æ¸©", condition:null, effect:p=>{p.funds+=2500;}},
  {desc:"åŸå¸‚æ›´æ–°è¯•ç‚¹ï¼Œæ—§æ”¹æœºä¼šå‡ºç°", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("æ—§åŸåŒºæ”¹é€ æŒ‡æ ‡");}},
  {desc:"æ•™è‚²æ‰©æ‹›è¯•ç‚¹ï¼Œé«˜æ ¡åé¢å¢åŠ ", condition:p=>p.role.tag==="student", effect:p=>{p.reputation+=5;}},
  {desc:"è´¸æ˜“ä¼™ä¼´åŠ å¾å…³ç¨ï¼Œå¤–è´¸æ‰¿å‹", condition:p=>p.role.tag==="trader", effect:p=>{p.funds-=4000;}},
  {desc:"æ–‡åŒ–å®¡æŸ¥è¶‹ä¸¥ï¼Œæ¼”å‡ºå®¡æ‰¹æ”¾ç¼“", condition:p=>p.role.tag==="idol", effect:p=>{p.funds-=2000;}},
  {desc:"ç§‘æŠ€ä¸‹ä¹¡ï¼Œç§‘ç ”è½¬åŒ–æ”¿ç­–æ¨å‡º", condition:p=>p.role.tag==="scientist", effect:p=>{p.contacts+=5;p.reputation+=4;}},
  {desc:"åœ°æ–¹æ‹›å•†å¼•èµ„ï¼Œæ°‘ä¼ç¨æ”¶ä¼˜æƒ ", condition:null, effect:p=>{p.funds+=1500;p.contacts+=2;}},
  {desc:"æ²»å®‰æ¶åŒ–ï¼Œå¤œé—´ç»è¥é£é™©å¢", condition:null, effect:p=>{p.funds-=1000;}},
  {desc:"å†œæ‘åŒ…äº§åˆ°æˆ·æ·±åŒ–ï¼Œä¸ªä½“ç»æµæ´»è·ƒ", condition:null, effect:p=>{p.funds+=1200;}},
  {desc:"åŸå¸‚æˆ·ç±è¯•ç‚¹æ”¹é©ï¼Œäººæ‰æµåŠ¨æ€§æé«˜", condition:null, effect:p=>{p.contacts+=2;}},
  {desc:"çŸ¥è¯†åˆ†å­åœ°ä½æå‡ï¼Œåª’ä½“æ­£å‘å®£ä¼ ", condition:p=>["scientist","student","lawyer"].includes(p.role.tag), effect:p=>{p.reputation+=6;}},
  {desc:"å¤–æ±‡ç®¡åˆ¶è°ƒæ•´ï¼Œç»“æ±‡æ›´ä¾¿åˆ©", condition:p=>p.role.tag==="trader", effect:p=>{p.contacts+=3;}},
  {desc:"æ¸¯å£æ•´æ²»ï¼Œèµ°ç§é€šé“è¢«ä¸¥æŸ¥", condition:p=>p.role.tag==="smuggler", effect:p=>{p.funds-=5000;p.reputation-=4;}},
];

const industryEvents = [
  {desc:"ä½ çš„å·¥å‚è·æ¸¯å•†æŠ•èµ„", condition:p=>p.role.tag==="factory"||p.assets.includes("ä¸­å‹å·¥å‚"), effect:p=>{p.funds+=12000;p.contacts+=5;}},
  {desc:"ä¸€æ‰¹è¿›å£è´§è¢«æµ·å…³æ‰£æŠ¼", condition:p=>p.role.tag==="trader", effect:p=>{p.funds-=5000;}},
  {desc:"å¤–è´¸è®¢å•æš´å¢ï¼Œè¿å¤œèµ¶å·¥", condition:p=>p.role.tag==="trader", effect:p=>{p.funds+=9000;p.health-=8;}},
  {desc:"æ‰¿åŒ…å·¥ç¨‹è´¨é‡è¿‡ç¡¬ï¼Œè¿½åŠ åˆåŒ", condition:p=>p.assets.includes("ä¸­å‹å·¥å‚"), effect:p=>{p.funds+=7000;p.reputation+=3;}},
  {desc:"æ¼”å”±ä¼šçˆ†æ»¡ï¼Œç¥¨æˆ¿ç ´çºªå½•", condition:p=>p.role.tag==="idol", effect:p=>{p.funds+=12000;p.reputation+=6;}},
  {desc:"æ‹æ‘„çš„ç”µå½±è·å¥–ï¼Œç‰‡é…¬ä¸Šè°ƒ", condition:p=>p.role.tag==="actor", effect:p=>{p.funds+=8000;p.reputation+=5;}},
  {desc:"å½±ç‰‡ç¥¨æˆ¿æƒ¨è´¥ï¼ŒæŠ•èµ„äºæŸ", condition:p=>p.role.tag==="actor", effect:p=>{p.funds-=6000;p.reputation-=3;}},
  {desc:"å¤œæ€»ä¼šé­ä¸´æ£€ï¼Œæ”¶å…¥é”å‡", condition:p=>p.role.tag==="mafia"||hasVenture("club"), effect:p=>{p.funds-=4000;}},
  {desc:"ç å¤´å…³ç³»ç–é€šï¼Œèµ°ç§é¡ºåˆ©", condition:p=>p.role.tag==="smuggler", effect:p=>{p.funds+=10000;}},
  {desc:"æ²¿è¡—é—¨é¢æ¶¨ç§Ÿï¼Œæˆæœ¬ä¸Šå‡", condition:null, effect:p=>{p.funds-=1500;}},
  {desc:"å¸‚åŒºåœ°å—å‘¨è¾¹é€šåœ°é“ï¼Œåœ°ä»·ä¸Šæ‰¬", condition:p=>p.assets.some(a=>a.includes("å¸‚åŒºåœ°å—")), effect:p=>{p.funds+=7000;}},
  {desc:"éƒŠåŒºåœ°å—è¢«å¾æ”¶ï¼Œè¡¥å¿åˆ°è´¦", condition:p=>p.assets.some(a=>a.includes("éƒŠåŒºåœ°å—")), effect:p=>{p.funds+=6000;}},
  {desc:"æ‹åˆ°ä¸€å®—ä¼˜è´¨æ—§æ”¹æŒ‡æ ‡", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("æ—§æ”¹é¡¹ç›®æŒ‡æ ‡");}},
  {desc:"å¾‹æ‰€æ‰“èµ¢å¤§æ¡ˆï¼Œå£ç¢‘çˆ†å‡", condition:p=>p.role.tag==="lawyer"||hasVenture("law"), effect:p=>{p.funds+=11000;p.reputation+=8;}},
  {desc:"å®˜å¸å¤±åˆ©ï¼Œå®¢æˆ·è§£çº¦", condition:p=>p.role.tag==="lawyer"||hasVenture("law"), effect:p=>{p.funds-=5000;p.reputation-=4;}},
  {desc:"ç§‘ç ”æˆæœè·å›½é™…ä¸“åˆ©", condition:p=>p.role.tag==="scientist"||hasVenture("lab"), effect:p=>{p.funds+=16000;p.reputation+=8;}},
  {desc:"å®éªŒå¤±è´¥ï¼Œè®¾å¤‡æŠ¥åºŸ", condition:p=>p.role.tag==="scientist"||hasVenture("lab"), effect:p=>{p.funds-=7000;}},
  {desc:"å­¦æœ¯ä¼šè®®æŠ¥å‘ŠæˆåŠŸï¼Œç»“è¯†åˆä½œæ–¹", condition:p=>["scientist","student"].includes(p.role.tag), effect:p=>{p.contacts+=8;}},
  {desc:"æ”¿åŠ¡è€ƒæ ¸ä¼˜ç§€ï¼Œè°ƒä»»è¦èŒ", condition:p=>p.role.tag==="official", effect:p=>{p.contacts+=10;p.reputation+=6;}},
  {desc:"åŒåƒšå†…æ–—ï¼Œè¢«è¾¹ç¼˜åŒ–", condition:p=>p.role.tag==="official", effect:p=>{p.contacts-=6;p.reputation-=4;}},
  {desc:"å·¥å‚æœºå™¨æ•…éšœï¼Œç»´ä¿®æ˜‚è´µ", condition:p=>p.assets.includes("ä¸­å‹å·¥å‚")||hasVenture("factory"), effect:p=>{p.funds-=4000;}},
  {desc:"è´­å…¥çš„åœ°å—è¢«æ›çº çº·ï¼Œé™·å…¥è¯‰è®¼", condition:p=>p.role.tag==="realty", effect:p=>{p.funds-=5000;p.reputation-=3;}},
  {desc:"æ­Œæ‰‹å•†ä¸šä»£è¨€åˆ°æ‰‹", condition:p=>p.role.tag==="idol"||hasVenture("event"), effect:p=>{p.funds+=6000;p.contacts+=3;}},
  {desc:"æ¼”å‡ºé»„ç‰›æ‰°ä¹±ç§©åºï¼Œè¢«ç½šæ•´æ”¹", condition:p=>p.role.tag==="idol"||hasVenture("event"), effect:p=>{p.funds-=2000;}},
  {desc:"å¤œåœºçº çº·å‡çº§ï¼Œé»‘ç™½ä¸¤é“éƒ½æ¥é—®è¯", condition:p=>p.role.tag==="mafia"||hasVenture("club"), effect:p=>{p.reputation-=6;}},
];

const personalEvents = [
  {desc:"äº²æˆšæ±‚åŠ©ï¼Œéœ€è¦ä¸€ç¬”é’±", condition:null, effect:p=>{p.funds-=2000;}},
  {desc:"æ‹¾é‡‘ä¸æ˜§è¢«æŠ¥é“ï¼Œäººç¼˜ä¸Šå‡", condition:null, effect:p=>{p.contacts+=5;p.reputation+=3;}},
  {desc:"æ„å¤–å—ä¼¤ï¼Œè¡ŒåŠ¨åŠ›ä¸‹é™", condition:null, effect:p=>{p.health-=15;}},
  {desc:"æœ‹å‹ä»‹ç»ä½ è®¤è¯†ä¸€ä½å®˜å‘˜", condition:null, effect:p=>{p.contacts+=5;}},
  {desc:"å­©å­å‡ºç”Ÿï¼Œç”Ÿæ´»å¼€é”€å¢åŠ ", condition:null, effect:p=>{p.funds-=1200;}},
  {desc:"è·å¾—ä¸€ç¬”é—äº§", condition:null, effect:p=>{p.funds+=6000;}},
  {desc:"å®¶ä¸­å¤±çªƒ", condition:null, effect:p=>{p.funds-=2000;}},
  {desc:"è¢«å°å·å·èµ°é’±åŒ…", condition:null, effect:p=>{p.funds-=800;}},
  {desc:"é‡æ„Ÿå†’ï¼Œéœ€è¦ä¼‘æ¯", condition:null, effect:p=>{p.health-=10;}},
  {desc:"ä¸­äº†ç¦åˆ©å½©ç¥¨", condition:null, effect:p=>{p.funds+=4000;}},
  {desc:"æŠ•èµ„æœ‹å‹é¡¹ç›®å¤±è´¥", condition:null, effect:p=>{p.funds-=4500;}},
  {desc:"æœ‹å‹å½’è¿˜æ—§æ¬ æ¬¾", condition:null, effect:p=>{p.funds+=2500;}},
  {desc:"è¡—å¤´æ•‘äººå†ä¸Šæ–°é—»", condition:null, effect:p=>{p.contacts+=3;p.reputation+=5;}},
  {desc:"é†‰é…’é—¹äº‹è¢«æŠ“", condition:null, effect:p=>{p.funds-=1500;p.reputation-=5;}},
  {desc:"èµŒåœºæ‰‹æ°”ä¸é”™", condition:null, effect:p=>{p.funds+=2500;}},
  {desc:"èµŒåœºæ‰‹æ°”å¾ˆå·®", condition:null, effect:p=>{p.funds-=2500;}},
  {desc:"æ·˜åˆ°å¤è‘£ï¼Œå¯èƒ½å‡å€¼", condition:null, effect:p=>{p.assets.push("å¤è‘£");}},
  {desc:"è¯¯ä¹°èµå“ï¼ŒäºæŸæƒ¨é‡", condition:null, effect:p=>{p.funds-=1800;}},
  {desc:"ä½“æ£€å‘ç°æ—§ç–¾ï¼Œé•¿æœŸè°ƒå…»", condition:null, effect:p=>{p.health-=8;p.reputation+=1;}},
  {desc:"å¿—æ„¿æ´»åŠ¨è·å¥½è¯„ï¼Œç»“è¯†ç¤¾ä¼šè´¤è¾¾", condition:null, effect:p=>{p.contacts+=4;p.reputation+=4;}},
  {desc:"è¢«åŒè¡Œè¯¬å‘Šï¼Œæ¸…ç™½ç»ˆè¿˜ä½†è€—è´¹å¿ƒåŠ›", condition:null, effect:p=>{p.funds-=1200;p.health-=5;p.reputation+=2;}},
  {desc:"é‚»é‡ŒçŸ›ç›¾è°ƒè§£æˆåŠŸ", condition:null, effect:p=>{p.reputation+=3;}},
  {desc:"è¢«å·å…¥æ°‘é—´å€Ÿè´·æ‹…ä¿ï¼Œå‹åŠ›å±±å¤§", condition:null, effect:p=>{p.funds-=2000;p.reputation-=2;}},
  {desc:"ä¸€å¤œæš´å¯Œçš„ä¼ è¨€è®©ä½ è¢«å›´å µå€Ÿé’±", condition:null, effect:p=>{p.contacts-=3;p.reputation-=2;}},
  {desc:"è€å‹å›åŸï¼Œå¸¦æ¥å•†æœºçº¿ç´¢", condition:null, effect:p=>{p.contacts+=6;}},
];

// å¹´ä»£äº‹ä»¶
const eraEventPools = {
  "80s":[
    {desc:"ä¹¡é•‡ä¼ä¸šæ½®å…´èµ·ï¼Œä»£å·¥æœºä¼šæ¶Œç°", effect:p=>{p.funds+=2000;}},
    {desc:"ä¸ªä½“æˆ·ç‰Œç…§æ›´æ˜“ç”³è¯·", effect:p=>{p.contacts+=2;}},
    {desc:"ç”µè§†æœºæ™®åŠï¼Œå¹¿å‘Šè¡Œä¸šèµ·æ­¥", effect:p=>{if(hasVenture("media")) p.funds+=1500;}},
  ],
  "90s":[
    {desc:"è‚¡ä»½åˆ¶æ”¹é©è®¨è®ºçƒ­çƒˆï¼Œå¸‚åœºé¢„æœŸè†¨èƒ€", effect:p=>{p.funds+=2500;}},
    {desc:"å—æ–¹ç‰¹åŒºå¸å¼•åŠ›ä¸Šå‡ï¼Œè¿ç§»æˆæœ¬ä¸‹é™", effect:p=>{p.contacts+=3;}},
    {desc:"æˆ¿åœ°äº§å¼€å‘çƒ­åº¦å‡æ¸©", effect:p=>{if(hasVenture("dev")) p.funds+=3000;}},
  ],
  "late90s":[
    {desc:"äº’è”ç½‘æ¦‚å¿µæŠ¬å¤´ï¼Œåª’ä½“æµé‡çˆ†å‘", effect:p=>{if(hasVenture("media")) p.funds+=4000;p.reputation+=2;}},
    {desc:"æ¼”å‡ºå¸‚åœºå•†ä¸šåŒ–ï¼Œç¥¨åŠ¡ä½“ç³»æˆå‹", effect:p=>{if(hasVenture("event")) p.funds+=3500;}},
    {desc:"ç›‘ç®¡è¶‹ä¸¥ï¼Œå¤œåœºç»è¥é—¨æ§›æé«˜", effect:p=>{if(hasVenture("club")) p.funds-=2000;}},
  ]
};

// ====== æ¸¸æˆçŠ¶æ€ ======
const SAVE_KEY="tgt_save_v1";
const game = {turn:1, year:1980, isOver:false, mood:0};
const player = {role:null,funds:0,contacts:0,reputation:10,health:100,assets:[],debt:[],apMax:2,ap:2, ventures:[]};

// ====== DOM & UI ======
const el = sel => document.querySelector(sel);
const logBox = el("#log");
function log(text, cls=""){ const li=document.createElement("li"); li.innerHTML=text; if(cls) li.classList.add(cls); logBox.prepend(li); const children = logBox.querySelectorAll("li"); if(children.length>20) children[children.length-1].remove(); }
function fmtMoney(v){ return "Â¥"+Math.round(v).toLocaleString(); }

function refreshVentureUI(){
  // äº‹ä¸šç›®å½•
  const cat = el("#ventureCatalog");
  cat.innerHTML = ventureCatalog.map(v=>`<option value="${v.id}">${v.name}ï¼ˆé¦–æœŸ${fmtMoney(v.cost)}ï½œç»´æŠ¤${fmtMoney(v.upkeep)}ï½œåŸºäº§${fmtMoney(v.baseIncome)}ï¼‰</option>`).join("");
  // å·²æœ‰äº‹ä¸š
  const own = el("#ownedVenture");
  if(player.ventures.length===0){ own.innerHTML = `<option value="">æ— å¯å‡çº§çš„äº‹ä¸š</option>`; }
  else{
    own.innerHTML = player.ventures.map((v,i)=>`<option value="${i}">${v.name} Lv.${v.level}ï¼ˆç»´æŠ¤${fmtMoney(v.upkeep)}ï¼‰</option>`).join("");
  }
}

function refresh(){
  const eraObj = currentEra(game.year);
  el("#year").textContent = game.year;
  el("#turn").textContent = game.turn;
  el("#era").textContent = eraObj.label;
  el("#funds").textContent = fmtMoney(player.funds);
  el("#contacts").textContent = Math.round(player.contacts);
  el("#rep").textContent = Math.round(player.reputation);
  el("#hp").textContent = Math.round(player.health);
  el("#roleName").textContent = player.role?player.role.name:"â€”";
  el("#roleSkill").textContent = player.role?player.role.skill:"â€”";
  el("#roleGoal").textContent = player.role?player.role.goal:"â€”";
  el("#assetList").textContent = player.assets.length?player.assets.join("ï¼Œ"):"â€”";
  el("#debtList").textContent = player.debt.length?player.debt.map((d,i)=>`${i+1}.${d.source}@${Math.round(d.interest*100)}%:${fmtMoney(d.amount)}(å›åˆ${d.turn})`).join("ï¼›"):"â€”";
  el("#apInfo").textContent = `AP ${player.ap}/${player.apMax}`;
  el("#ventureList").textContent = player.ventures.length
    ? player.ventures.map(v=>`${v.name} Lv.${v.level} â†‘${fmtMoney(ventureIncomePreview(v))}/å›`).join("ï¼› ")
    : "â€”";
  el("#vict").textContent = victoryHint();
  el("#btnNext").disabled = !player.role || game.isOver;
  refreshVentureUI();
}
function needAP(n=1){ if(player.ap<n){ log("è¡ŒåŠ¨åŠ›ä¸è¶³ï¼Œæœ¬å›åˆæ— æ³•å†è¡ŒåŠ¨","warn"); return false;} player.ap-=n; refresh(); return true;}

function hasVenture(id){ return player.ventures.some(v=>v.id===id); }

// ====== åˆå§‹è§’è‰² UI ======
const roleGrid = el("#roleGrid");
let chosenIndex = null;
function renderRoles(){
  roleGrid.innerHTML = "";
  roles.forEach((r,idx)=>{
    const div = document.createElement("div");
    div.className="role";
    div.innerHTML = `<b>${r.name}</b><div class="footnote">${r.skill}</div><div class="footnote">ç›®æ ‡ï¼š${r.goal}</div>`;
    div.onclick = ()=>{
      chosenIndex = idx;
      [...roleGrid.children].forEach(c=>c.classList.remove("active"));
      div.classList.add("active");
    };
    roleGrid.appendChild(div);
  });
}
renderRoles();

// ====== å­˜æ¡£/è¯»æ¡£/æ–°å¼€å±€ ======
function snapshot(){
  return JSON.stringify({game, player, chosenIndex});
}
function loadFrom(obj){
  Object.assign(game, obj.game);
  Object.assign(player, obj.player);
  chosenIndex = obj.chosenIndex ?? null;
}
function save(){
  localStorage.setItem(SAVE_KEY, snapshot());
  el("#saveTip").textContent = `å·²å­˜æ¡£ï¼šå›åˆ${game.turn}`;
  log("å­˜æ¡£æˆåŠŸ","good");
}
function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw){ log("æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£","warn"); return; }
  try{
    const data = JSON.parse(raw);
    loadFrom(data);
    el("#roleSection").hidden = !!player.role; // è‹¥å·²åœ¨æ¸¸æˆä¸­ï¼Œä¿æŒéšè—
    log("è¯»æ¡£æˆåŠŸ","good");
    refresh();
  }catch(e){ log("è¯»æ¡£å¤±è´¥","bad"); }
}
function resetGame(){
  localStorage.removeItem(SAVE_KEY);
  // è½¯é‡ç½®åˆ°é€‰è§’
  Object.assign(game,{turn:1,year:1980,isOver:false,mood:0});
  Object.assign(player,{role:null,funds:0,contacts:0,reputation:10,health:100,assets:[],debt:[],apMax:2,ap:2,ventures:[]});
  chosenIndex = null;
  el("#roleSection").hidden = false;
  el("#saveTip").textContent = "æœªå­˜æ¡£";
  log("å·²é‡ç½®ä¸ºæ–°å¼€å±€","warn");
  refresh();
}
el("#btnSave").onclick = save;
el("#btnLoad").onclick = load;
el("#btnReset").onclick = resetGame;

// ====== å¼€å§‹æ¸¸æˆï¼ˆé€‰å®Œèº«ä»½é¢æ¿æ¶ˆå¤±ï¼‰======
el("#btnStart").onclick = ()=>{
  if(chosenIndex==null){ log("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèº«ä»½","warn"); return; }
  const r = roles[chosenIndex];
  player.role = r;
  player.funds = r.funds;
  player.contacts = r.contacts;
  player.assets = [...r.assets];
  player.reputation = 10;
  player.health = 100;
  player.debt = [];
  player.ventures = [];
  game.turn = 1; game.year = 1980; game.isOver=false; player.apMax=2; player.ap=player.apMax; game.mood=0;
  log(`ä½ é€‰æ‹©äº†ã€${r.name}ã€‘ã€‚æŠ€èƒ½ï¼š${r.skill}ï¼Œç›®æ ‡ï¼š${r.goal}`,"good");
  el("#roleSection").hidden = true;
  refresh();
};

// ====== å›åˆæ¨è¿› ======
function ventureIncomePreview(v){
  const syn = v.synergy.includes(player.role?.tag) ? (1+synergyBoost) : 1;
  const scale = 1 + 0.5*(v.level-1);
  // äººè„‰/å£°æœ›çš„å°å¹…å½±å“
  const soft = 1 + clamp(player.contacts*0.001 + player.reputation*0.0005, -0.2, 0.4);
  return Math.max(0, Math.round(v.baseIncome*scale*syn*soft) - v.upkeep);
}

function settleVentures(){
  if(player.ventures.length===0) return 0;
  let total = 0;
  player.ventures.forEach(v=>{
    // åŸºç¡€äº§å‡º
    const income = ventureIncomePreview(v);
    // äº‹æ•…åˆ¤å®š
    if(Math.random()<v.risk){
      const loss = rndi(800, 4000);
      total += (income - loss);
      log(`äº‹ä¸šäº‹æ•…ï¼š${v.name} é­é‡çªå‘æƒ…å†µï¼ŒæŸå¤± ${fmtMoney(loss)}`,"bad");
    }else{
      total += income;
    }
  });
  player.funds += total;
  if(total!==0) log(`äº‹ä¸šä½“ç»“ç®—ï¼šæœ¬å›åˆå‡€æ”¶ç›Š ${fmtMoney(total)}`, total>=0?"good":"bad");
  return total;
}

function triggerEvents(){
  const pools = [macroEvents, industryEvents, personalEvents];
  pools.forEach(pool=>{
    let candidates = pool.filter(e=>!e.condition || e.condition(player));
    if(candidates.length===0) candidates = pool;
    const ev = pick(candidates);
    ev.effect(player);
    log(`äº‹ä»¶ï¼š${ev.desc}`);
  });
  // å¹´ä»£äº‹ä»¶é¢å¤–+1
  const eraKey = currentEra(game.year).key;
  const eraPool = eraEventPools[eraKey];
  if(eraPool && eraPool.length){
    const e = pick(eraPool);
    e.effect(player);
    log(`ã€å¹´ä»£ã€‘${e.desc}`,"warn");
  }
  // æƒ…ç»ªï¼ˆå½±å“è‚¡å¸‚æ³¢åŠ¨ä¸­æ¢ï¼‰
  game.mood = clamp(game.mood + rndi(-1,1), -2, 2);
}

function endTurnCheck(){
  player.health = clamp(player.health, 0, 120);
  if(player.health<=0){ game.isOver=true; log("ä½ å› å¥åº·é—®é¢˜å»ä¸–ï¼Œæ¸¸æˆç»“æŸ","bad"); }
  if(player.funds< -5000 && player.assets.length===0){ game.isOver=true; log("ä½ èµ„ä¸æŠµå€ºä¸”æ— èµ„äº§ï¼Œç ´äº§ Game Over","bad"); }
  // å€ºåŠ¡åˆ©æ¯ï¼ˆæ¯å›åˆè®¡æ¯ä¸€æ¬¡ï¼‰
  player.debt.forEach(d=>{ const age = game.turn - d.turn; if(age>=1){ d.amount = Math.round(d.amount*(1+d.interest)); d.turn=game.turn; }});
  if(checkVictory()){ game.isOver=true; log("ä½ å·²è¾¾æˆèº«ä»½ç›®æ ‡ï¼æ­å–œé€šå…³ã€Šå¤§æ—¶ä»£ã€‹","good"); }
}

function nextTurn(){
  if(!player.role){ log("è¯·å…ˆé€‰æ‹©èº«ä»½å¹¶å¼€å§‹æ¸¸æˆ","warn"); return; }
  if(game.isOver){ log("æ¸¸æˆå·²ç»“æŸï¼Œè¯·åˆ·æ–°/æ–°å¼€å±€","warn"); return; }
  game.turn++; game.year++;
  player.ap = player.apMax; // æ¢å¤è¡ŒåŠ¨ç‚¹
  // å…ˆç»“ç®—äº‹ä¸šä½“
  settleVentures();
  // å›åˆéšæœºäº‹ä»¶
  triggerEvents();
  // è‡ªç„¶æ¢å¤
  player.health = clamp(player.health + 3 + (player.role.tag==="scientist"?1:0), 0, 120);
  endTurnCheck();
  refresh();
}
el("#btnNext").onclick = nextTurn;

// ====== èƒœåˆ©æ¡ä»¶ï¼ˆç®€åŒ–ç‰ˆï¼‰======
function checkVictory(){
  const f = player.funds, c = player.contacts, r = player.reputation;
  const has = name => player.assets.some(a=>a.includes(name));
  switch(player.role.tag){
    case "student": return r>=30 && c>=20 && (has("å®éªŒå®¤")||f>=50000);
    case "trader":  return f>=1000000/10 || hasVenture("trade") && player.ventures.find(v=>v.id==="trade")?.level>=3;
    case "mafia":   return c>=120 && r>=25 && (hasVenture("club")||player.assets.some(a=>/å¤œ/.test(a)));
    case "realty":  return player.assets.filter(a=>a.includes("åœ°å—")).length>=4 && f>=300000/10 || hasVenture("dev")&&player.ventures.find(v=>v.id==="dev")?.level>=3;
    case "idol":    return c>=80 && r>=60 && (hasVenture("event")||hasVenture("media"));
    case "martial": return c>=70 && r>=50;
    case "official":return r>=70 && c>=90;
    case "factory": return f>=500000/10 && (has("ä¸­å‹å·¥å‚")||hasVenture("factory"));
    case "lawyer":  return f>=300000/10 && r>=60 && (hasVenture("law"));
    case "scientist":return r>=75 && (f>=200000/10 || hasVenture("lab"));
    case "actor":   return r>=70 && c>=80 && (hasVenture("media")||hasVenture("event"));
    case "smuggler":return f>=500000/10 && c>=80;
  }
  return false;
}
function victoryHint(){
  if(!player.role) return "â€”";
  return checkVictory() ? "âœ… å·²æ»¡è¶³" : "â³ å°šæœªæ»¡è¶³ï¼Œç»§ç»­åŠªåŠ›";
}

// ====== è¡ŒåŠ¨å®ç° ======
function consumeHealth(base=2){ player.health = clamp(player.health - base, 0, 120); }

el("#btnRest").onclick = ()=>{
  if(!needAP(1)) return;
  const gain = 10 + (player.role.tag==="scientist"?2:0);
  player.health = clamp(player.health + gain, 0, 120);
  log(`ä¼‘æ•´æ¢å¤å¥åº· +${gain}`,"good");
  refresh();
};

// åšç”Ÿæ„
el("#btnBiz").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#bizAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("åšç”Ÿæ„æŠ•å…¥é‡‘é¢éæ³•æˆ–ä¸è¶³","warn"); return; }
  player.funds -= amt;
  const boost = (player.reputation*0.002 + player.contacts*0.001);
  let roi = rnd(-0.2, 0.6 + boost);
  if(player.role.tag==="factory") roi += 0.05;
  const profit = Math.round(amt * roi);
  player.funds += amt + profit;
  player.reputation += profit>0 ? 2 : -1;
  consumeHealth(3);
  log(`åšç”Ÿæ„${profit>=0?"ç›ˆåˆ©":"äºæŸ"}ï¼š${profit>=0?"+":""}${fmtMoney(profit)}ï¼ˆROI ${(roi*100).toFixed(1)}%ï¼‰`, profit>=0?"good":"bad");
  refresh();
};

// ç‚’è‚¡
el("#btnStock").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#stockAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("ç‚’è‚¡é‡‘é¢éæ³•æˆ–ä¸è¶³","warn"); return; }
  player.funds -= amt;
  let base = { "-2":[-0.5,0.3], "-1":[-0.45,0.5], "0":[-0.4,0.6], "1":[-0.3,0.7], "2":[-0.2,0.8] }[String(game.mood)];
  let roi = rnd(base[0], base[1]);
  const profit = Math.round(amt*roi);
  player.funds += amt + profit;
  player.reputation += profit>0 ? 1 : 0;
  consumeHealth(2);
  log(`ç‚’è‚¡${profit>=0?"ç›ˆåˆ©":"äºæŸ"}ï¼š${profit>=0?"+":""}${fmtMoney(profit)}ï¼ˆå¸‚åœºæƒ…ç»ª ${game.mood>=0?"+":""}${game.mood}ï¼‰`, profit>=0?"good":"bad");
  refresh();
};

// èµŒåš
el("#btnGamble").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#gambleAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("èµŒæ³¨éæ³•æˆ–ä¸è¶³","warn"); return; }
  let winRate = 0.45;
  if(player.role.tag==="mafia") winRate += 0.1;
  const win = Math.random()<winRate;
  const mult = win ? rnd(0.5,1.5) : -rnd(0.3,1.0);
  const delta = Math.round(amt*mult);
  player.funds += delta;
  player.reputation += win?1:-2;
  consumeHealth(4);
  log(`èµŒåš${win?"èµ¢äº†":"è¾“äº†"}ï¼š${delta>=0?"+":""}${fmtMoney(delta)}ï¼ˆèƒœç‡â‰ˆ${Math.round(winRate*100)}%ï¼‰`, delta>=0?"good":"bad");
  refresh();
};

// ä¹°åœ°çš®
el("#btnBuyLand").onclick = ()=>{
  if(!needAP(1)) return;
  const [name,priceStr] = el("#landType").value.split("|");
  const price = +priceStr;
  const final = Math.round(price * (player.role.tag==="realty"?0.85:1));
  if(player.funds<final){ log("èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•ä¹°åœ°çš®","warn"); return; }
  player.funds -= final;
  player.assets.push(name);
  player.reputation += 1;
  log(`è´­å…¥èµ„äº§ï¼š${name}ï¼ˆèŠ±è´¹ ${fmtMoney(final)}ï¼‰`,"good");
  refresh();
};

// å–èµ„äº§
el("#btnSellAsset").onclick = ()=>{
  if(!needAP(1)) return;
  if(player.assets.length===0){ log("æ²¡æœ‰å¯å‡ºå”®çš„èµ„äº§","warn"); return; }
  const priceOf = name=>{
    if(name.includes("å¸‚åŒºåœ°å—")) return rndi(18000,30000);
    if(name.includes("éƒŠåŒºåœ°å—")) return rndi(6000,15000);
    if(name.includes("ä¸­å‹å·¥å‚")) return rndi(20000,40000);
    if(name.includes("å¤è‘£")) return rndi(3000,12000);
    return rndi(2000,8000);
  };
  const asset = player.assets.pop();
  const val = priceOf(asset);
  player.funds += val;
  log(`å‡ºå”®èµ„äº§ï¼š${asset}ï¼Œè·å¾— ${fmtMoney(val)}`,"good");
  refresh();
};

// è¿›ä¿®/è€ƒè¯•
el("#btnStudy").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 800;
  if(player.funds<cost){ log("è¿›ä¿®éœ€è¦èµ„é‡‘ä¸è¶³","warn"); return; }
  player.funds -= cost;
  let repGain = 4, contGain = 2;
  if(["student","scientist","lawyer"].includes(player.role.tag)) repGain += 2;
  player.reputation += repGain;
  player.contacts += contGain;
  consumeHealth(2);
  log(`è¿›ä¿®/è€ƒè¯•ï¼šå£°æœ› +${repGain}ï¼Œäººè„‰ +${contGain}ï¼ˆå­¦è´¹ ${fmtMoney(cost)}ï¼‰`,"good");
  refresh();
};

// äººè„‰æ´»åŠ¨
el("#btnSocial").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 600;
  if(player.funds<cost){ log("è¯·å®¢é€ç¤¼éœ€è¦èµ„é‡‘ä¸è¶³","warn"); return; }
  player.funds -= cost;
  let contGain = rndi(3,8);
  if(player.role.tag==="official") contGain+=3;
  player.contacts += contGain;
  player.reputation += 1;
  consumeHealth(2);
  log(`äººè„‰æ´»åŠ¨ï¼šäººè„‰ +${contGain}ï¼ˆèŠ±è´¹ ${fmtMoney(cost)}ï¼‰`,"good");
  refresh();
};

// ä»æ”¿
el("#btnPolitics").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 1000;
  if(player.funds<cost){ log("ä»æ”¿éœ€è¦ç»è´¹ä¸è¶³","warn"); return; }
  player.funds -= cost;
  let rep = rndi(2,6), cont = rndi(2,6);
  if(player.role.tag==="official"){ rep+=3; cont+=3; }
  player.reputation += rep; player.contacts += cont;
  consumeHealth(3);
  log(`ä»æ”¿åŠªåŠ›ï¼šå£°æœ› +${rep}ï¼Œäººè„‰ +${cont}ï¼ˆè´¹ç”¨ ${fmtMoney(cost)}ï¼‰`,"good");
  refresh();
};

// å€Ÿæ¬¾ï¼ˆéœ€æŠµæŠ¼ï¼‰
el("#btnBorrow").onclick = ()=>{
  if(!needAP(1)) return;
  const src = el("#loanSrc").value;
  const amt = +el("#loanAmt").value||0;
  if(amt<=0){ log("å€Ÿæ¬¾é‡‘é¢éœ€å¤§äº 0","warn"); return; }
  if(player.assets.length===0){ log("ç¼ºå°‘æŠµæŠ¼èµ„äº§ï¼Œæ— æ³•å€Ÿæ¬¾","warn"); return; }
  const rate = src==="bank"?0.05:src==="private"?0.12:0.20;
  player.funds += amt;
  player.debt.push({amount:amt,interest:rate,source:src,turn:game.turn,collateral:player.assets[0]});
  log(`å€Ÿæ¬¾æˆåŠŸï¼šæ¥æº ${src}ï¼Œé‡‘é¢ ${fmtMoney(amt)}ï¼Œå¹´æ¯ ${Math.round(rate*100)}%ï¼ˆæŠµæŠ¼ï¼š${player.assets[0]}ï¼‰`,"warn");
  refresh();
};

// è¿˜è´·ï¼ˆä¼˜å…ˆæœ€æ—©ä¸€ç¬”ï¼‰
el("#btnRepay").onclick = ()=>{
  if(player.debt.length===0){ log("å½“å‰æ— è´Ÿå€º","warn"); return; }
  const d = player.debt[0];
  const total = Math.round(d.amount*(1));
  if(player.funds<total){ log(`èµ„é‡‘ä¸è¶³ä»¥å¿è¿˜é¦–ç¬”å€ºåŠ¡ï¼šéœ€ ${fmtMoney(total)}`,"warn"); return; }
  player.funds -= total;
  player.debt.shift();
  log(`å·²å½’è¿˜å€ºåŠ¡ ${fmtMoney(total)}ï¼ˆæ¥æº ${d.source}ï¼‰`,"good");
  refresh();
};

// ====== äº‹ä¸šä½“ï¼šå¼€åŠä¸å‡çº§ ======
el("#btnStartVenture").onclick = ()=>{
  if(!needAP(1)) return;
  const id = el("#ventureCatalog").value;
  const tpl = ventureCatalog.find(v=>v.id===id);
  if(!tpl) return;
  if(player.funds<tpl.cost){ log("èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•å¼€åŠè¯¥äº‹ä¸š","warn"); return; }
  if(player.ventures.some(v=>v.id===id)){ log("è¯¥äº‹ä¸šå·²æ‹¥æœ‰ï¼Œå¯è€ƒè™‘å‡çº§","warn"); return; }
  player.funds -= tpl.cost;
  player.ventures.push({id:tpl.id,name:tpl.name,level:1,baseIncome:tpl.baseIncome,upkeep:tpl.upkeep,risk:tpl.risk,synergy:tpl.synergy});
  log(`å¼€åŠäº‹ä¸šï¼š${tpl.name}ï¼ˆé¦–æœŸ ${fmtMoney(tpl.cost)}ï¼‰`,"good");
  refresh();
};

el("#btnUpgradeVenture").onclick = ()=>{
  if(!needAP(1)) return;
  if(player.ventures.length===0){ log("æš‚æ— å¯å‡çº§äº‹ä¸š","warn"); return; }
  const idx = +el("#ownedVenture").value;
  if(isNaN(idx) || idx<0 || idx>=player.ventures.length){ log("è¯·é€‰æ‹©è¦å‡çº§çš„äº‹ä¸š","warn"); return; }
  const v = player.ventures[idx];
  const baseCost = ventureCatalog.find(t=>t.id===v.id)?.cost || 8000;
  const upgCost = Math.round(baseCost*0.6*v.level);
  if(player.funds<upgCost){ log(`èµ„é‡‘ä¸è¶³ï¼Œå‡çº§éœ€è¦ ${fmtMoney(upgCost)}`,"warn"); return; }
  player.funds -= upgCost;
  v.level += 1;
  // å‡çº§åŒæ—¶ç•¥å¢ç»´æŠ¤è´¹
  v.upkeep = Math.round(v.upkeep*(1+0.15));
  log(`å‡çº§äº‹ä¸šï¼š${v.name} â†’ Lv.${v.level}ï¼ˆèŠ±è´¹ ${fmtMoney(upgCost)}ï¼‰`,"good");
  refresh();
};

// ====== åˆå§‹åŒ– ======
function init(){
  refresh();
  refreshVentureUI();
}
init();
</script>
</body>
</html>
