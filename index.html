<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å¤§æ—¶ä»£ï½œThe Great Times</title>
<style>
  :root{--bg:#0f1220;--card:#171a2b;--muted:#8fa0ff;--text:#e6e9ff;--ok:#1bd97b;--bad:#ff5d73;--warn:#ffb547;--btn:#3040ff;}
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0d1020,#0b0e19);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
  header{padding:12px 16px;border-bottom:1px solid #222846;background:#0c1020;position:sticky;top:0;z-index:2;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  header h1{margin:0;font-size:18px;display:flex;gap:8px;align-items:center}
  header small{color:#aeb6ff;opacity:.9}
  .wrap{display:grid;grid-template-columns:430px 1fr 380px;gap:14px;padding:14px}
  .card{background:var(--card);border:1px solid #262a45;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .section{padding:14px 16px}
  .title{font-size:14px;color:#c9d1ff;letter-spacing:.5px;text-transform:uppercase;margin-bottom:8px}
  .grid{display:grid;gap:10px}
  .stats{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .stat{background:#12152a;border:1px solid #272c4e;border-radius:12px;padding:10px}
  .stat b{display:block;font-size:18px;margin-bottom:2px}
  .muted{color:#a7b1ff}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button,select,input{background:#131736;border:1px solid #2a3161;color:var(--text);border-radius:10px;padding:10px 12px;font-size:14px}
  button.primary{background:var(--btn);border-color:#2937e6}
  button.good{background:rgba(27,217,123,.1);border-color:#1bd97b}
  button.danger{background:rgba(255,93,115,.08);border-color:#ff5d73}
  button.warn{background:rgba(255,181,71,.1);border-color:#ffb547}
  button:disabled{opacity:.5}
  .list{display:grid;gap:8px}
  .item{padding:10px;border:1px solid #29305c;background:#10132a;border-radius:10px}
  .log{max-height:70vh;overflow:auto;padding:0;margin:0;list-style:none}
  .log li{padding:10px 12px;border-bottom:1px solid #262b52}
  .log .good{color:var(--ok)} .log .bad{color:var(--bad)} .log .warn{color:var(--warn)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1440;border:1px solid #2a326a;margin-left:6px;color:#b9c1ff;font-size:12px}
  .role-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .role{padding:10px;border:1px solid #2a3161;border-radius:12px;background:#11142a;cursor:pointer}
  .role.active{outline:2px solid var(--muted);border-color:#5564ff}
  .footnote{opacity:.7;font-size:12px;margin-top:8px}
  .hr{height:1px;background:#262b52;margin:10px 0}
  #roleSection[hidden]{display:none !important}
  #eventChoices{display:none}
  #eventChoices.active{display:block}
  .choice{border:1px dashed #3a4284;border-radius:12px;padding:10px;cursor:pointer;background:#0f1230}
  .choice:hover{border-color:#6a75ff}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;}
  .tag{font-size:12px;opacity:.9;margin-left:6px}
</style>
</head>
<body>
  <header>
    <h1>ã€Šå¤§æ—¶ä»£ï½œThe Great Timesã€‹ <small class="pill">æ–‡å­—æ¨¡æ‹Ÿç»è¥ Â· æœˆåº¦å›åˆ</small></h1>
    <button id="btnSave" class="good">ğŸ’¾ å­˜æ¡£</button>
    <button id="btnLoad" class="warn">ğŸ“‚ è¯»æ¡£</button>
    <button id="btnReset" class="danger">ğŸ—‘ æ–°å¼€å±€</button>
    <span id="saveTip" class="pill">æœªå­˜æ¡£</span>
  </header>

  <div class="wrap">
    <!-- å·¦ï¼šæ§åˆ¶ä¸è¡ŒåŠ¨ -->
    <div class="card">
      <div class="section">
        <div class="title">å›åˆ & è¡ŒåŠ¨</div>
        <div class="grid">
          <div class="row">
            <button id="btnNext" class="primary">â–¶ è¿›å…¥ä¸‹æœˆ</button>
            <button id="btnRest">ä¼‘æ•´ +æ¢å¤å¥åº·</button>
            <span id="apInfo" class="pill">AP 0/0</span>
          </div>

          <div class="title">è¡ŒåŠ¨ï¼ˆæ¶ˆè€— APï¼‰</div>
          <div class="list">
            <div class="item">
              <div class="row">
                <input id="bizAmt" type="number" min="0" step="100" placeholder="æŠ•å…¥é‡‘é¢(åšç”Ÿæ„)">
                <button id="btnBiz" class="good">åšç”Ÿæ„</button>
              </div>
              <div class="footnote">æœˆåº¦æ”¶ç›Šï¼šçº¦ -8% ~ +20%ï¼Œä¸å£°æœ›ã€äººè„‰ç•¥ç›¸å…³</div>
            </div>

            <div class="item">
              <div class="row">
                <input id="stockAmt" type="number" min="0" step="100" placeholder="ä¹°å…¥é‡‘é¢(ç‚’è‚¡)">
                <button id="btnStock" class="warn">ç‚’è‚¡</button>
              </div>
              <div class="footnote">æœˆåº¦æ³¢åŠ¨ï¼šçº¦ -10% ~ +15%ï¼Œå—å¸‚åœºæƒ…ç»ªå½±å“</div>
            </div>

            <div class="item">
              <div class="row">
                <input id="gambleAmt" type="number" min="0" step="100" placeholder="èµŒæ³¨(èµŒåš)">
                <button id="btnGamble" class="danger">èµŒåš</button>
              </div>
              <div class="footnote">èƒœç‡åŸºç¡€ 45%ï¼Œé»‘é“æœ‰åŠ æˆ</div>
            </div>

            <div class="item">
              <div class="row">
                <select id="landType">
                  <option value="éƒŠåŒºåœ°å—|6000">éƒŠåŒºåœ°å—ï¼ˆÂ¥6,000ï¼‰</option>
                  <option value="å¸‚åŒºåœ°å—|15000">å¸‚åŒºåœ°å—ï¼ˆÂ¥15,000ï¼‰</option>
                </select>
                <button id="btnBuyLand">ä¹°åœ°çš®</button>
                <button id="btnSellAsset">å–èµ„äº§</button>
              </div>
              <div class="footnote">æŒ‰æœˆåº¦å°ºåº¦ä¼°å€¼ï¼›äº‹ä»¶/å¹´ä»£ä¼šå½±å“åœ°ä»·</div>
            </div>

            <div class="item">
              <div class="row">
                <button id="btnStudy">è¿›ä¿®/è€ƒè¯•</button>
                <button id="btnSocial">äººè„‰æ´»åŠ¨</button>
                <button id="btnPolitics">ä»æ”¿åŠªåŠ›</button>
              </div>
              <div class="footnote">å­¦ç”Ÿ/å¾‹å¸ˆ/å…¬åŠ¡å‘˜/ç§‘å­¦å®¶èŒä¸šååŒæ›´å¼º</div>
            </div>

            <!-- äº‹ä¸šä½“ç³»ç»Ÿ -->
            <div class="item">
              <div class="row">
                <select id="ventureCatalog"></select>
                <button id="btnStartVenture" class="good">å¼€åŠäº‹ä¸š</button>
              </div>
              <div class="row">
                <select id="ownedVenture"></select>
                <button id="btnUpgradeVenture" class="warn">å‡çº§</button>
                <button id="btnToggleVenture">æš‚åœ/æ¢å¤</button>
                <button id="btnSellVenture" class="danger">è½¬è®©</button>
              </div>
              <div class="footnote">äº‹ä¸šä½“æ¯æœˆç»“ç®—ï¼›å¯æš‚åœ(ä¸äº§å‡ºä¹Ÿä¸ç»´æŠ¤)ï¼Œå¯ä¸€æ¬¡æ€§è½¬è®©å›æ¬¾</div>
            </div>

            <div class="item">
              <div class="row">
                <select id="loanSrc">
                  <option value="bank">é“¶è¡Œ(å¹´æ¯5%)</option>
                  <option value="private">æ°‘é—´(å¹´æ¯12%)</option>
                  <option value="mafia">é»‘é“(å¹´æ¯20%)</option>
                </select>
                <input id="loanAmt" type="number" min="0" step="100" placeholder="å€Ÿæ¬¾é‡‘é¢">
                <button id="btnBorrow">å€Ÿæ¬¾(éœ€æŠµæŠ¼)</button>
                <button id="btnRepay">è¿˜è´·</button>
              </div>
              <div class="footnote">æŒ‰æœˆè®¡æ¯ï¼šå¹´åŒ–/12ï¼›æŠµæŠ¼ä¼˜å…ˆåœ°äº§/å¤è‘£/å·¥å‚</div>
            </div>
          </div>
        </div>
      </div>

      <!-- æœˆåº¦äº‹ä»¶æŠ‰æ‹© -->
      <div class="section" id="eventChoices">
        <div class="title">æœ¬æœˆæƒ…å¢ƒï¼ˆä» 3 é€‰ 1ï¼‰</div>
        <div id="choicesWrap" class="grid"></div>
        <div class="footnote">é€‰ä¸­å³ç»“ç®—ï¼›æ¯æœˆä»…ä¸€æ¬¡</div>
      </div>
    </div>

    <!-- ä¸­ï¼šçŠ¶æ€é¢æ¿ -->
    <div class="card">
      <div class="section">
        <div class="title">ç©å®¶çŠ¶æ€</div>
        <div id="basic" class="grid">
          <div>
            <b>æ—¶é—´ï¼š</b><span id="ym">â€”</span>
            <span id="era" class="pill">â€”</span>
            <span id="difficulty" class="pill">â€”</span>
          </div>
          <div class="stats">
            <div class="stat"><b id="funds">Â¥0</b><span class="muted">èµ„é‡‘</span></div>
            <div class="stat"><b id="contacts">0</b><span class="muted">äººè„‰</span></div>
            <div class="stat"><b id="rep">0</b><span class="muted">å£°æœ›</span></div>
            <div class="stat"><b id="hp">0</b><span class="muted">å¥åº·</span></div>
          </div>
          <div class="hr"></div>
          <div class="grid">
            <div><b>èº«ä»½ï¼š</b><span id="roleName">â€”</span> <span id="roleSkill" class="pill">â€”</span></div>
            <div><b>ç›®æ ‡ï¼š</b><span id="roleGoal">â€”</span></div>
            <div><b>èµ„äº§ï¼š</b><span id="assetList">â€”</span></div>
            <div><b>è´Ÿå€ºï¼š</b><span id="debtList">â€”</span></div>
            <div><b>äº‹ä¸šä½“ï¼š</b><span id="ventureList" class="mono">â€”</span></div>
            <div><b>èƒœåˆ©åˆ¤å®šï¼š</b><span id="vict">â€”</span></div>
          </div>
        </div>
      </div>

      <div class="section" id="roleSection">
        <div class="title">å¼€å±€è®¾ç½®</div>
        <div class="grid">
          <div>
            <b>éš¾åº¦ï¼š</b>
            <select id="diffSelect">
              <option value="easy">å®½ä¿¡ç”¨ï¼ˆä½åˆ©ç‡ã€å¸‚åœºæ›´å‹å¥½ï¼‰</option>
              <option value="normal" selected>æ­£å¸¸</option>
              <option value="hard">ç´§ä¿¡ç”¨ï¼ˆé«˜åˆ©ç‡ã€å¸‚åœºæ›´å†·ï¼‰</option>
            </select>
          </div>
        </div>
        <div class="hr"></div>
        <div class="title">è§’è‰²é€‰æ‹©ï¼ˆ12ï¼‰</div>
        <div class="role-grid" id="roleGrid"></div>
        <div class="row" style="margin-top:8px;">
          <button id="btnStart" class="primary">å¼€å§‹æ¸¸æˆ</button>
          <span class="footnote">æç¤ºï¼šé€‰æ‹©èº«ä»½ + éš¾åº¦ï¼Œå†å¼€å§‹</span>
        </div>
      </div>
    </div>

    <!-- å³ï¼šäº‹ä»¶æ—¥å¿— -->
    <div class="card">
      <div class="section">
        <div class="title">äº‹ä»¶æ—¥å¿—</div>
        <ul id="log" class="log"></ul>
      </div>
    </div>
  </div>

<script>
// ====== å·¥å…· ======
const rnd = (min, max)=>Math.random()*(max-min)+min;
const rndi = (min,max)=>Math.floor(rnd(min,max+1));
const pick = arr => arr[rndi(0,arr.length-1)];
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const sum = arr => arr.reduce((a,b)=>a+b,0);

// ====== è§’è‰²ï¼ˆ12ï¼‰======
const roles = [
  {name:"å­¦ç”Ÿ", funds:1200, contacts:10, assets:[], skill:"å­¦ä¹ æ•ˆç‡+20%", goal:"è€ƒä¸Šåæ ¡/å…¥ç§‘ç ”", tag:"student"},
  {name:"å¤–è´¸å•†äºº", funds:14000, contacts:30, assets:["è¿›å‡ºå£æ¸ é“"], skill:"è¿›å‡ºå£æˆæœ¬-10%", goal:"å¹´å‡ºå£é¢>1000ä¸‡(ç¼©æ”¾)", tag:"trader"},
  {name:"é»‘é“å¤§å“¥", funds:7000, contacts:50, assets:[], skill:"æå“æˆåŠŸç‡+30%", goal:"æ§åˆ¶å…¨åŸåœ°ä¸‹åŠ¿åŠ›", tag:"mafia"},
  {name:"åœ°äº§å•†", funds:22000, contacts:25, assets:["æ—§å‚æˆ¿"], skill:"åœŸåœ°æ”¶è´­ä»·-15%", goal:"å„æ–­å¸‚ä¸­å¿ƒå•†åœˆ", tag:"realty"},
  {name:"å”±æ­Œæ˜æ˜Ÿ", funds:10000, contacts:20, assets:["å½•éŸ³æ£š"], skill:"æ¼”å”±ä¼šæ”¶å…¥+20%", goal:"å›½å†…é”€é‡å† å†›+å‡ºæµ·å·¡æ¼”", tag:"idol"},
  {name:"æ­¦æœ¯å®¶", funds:3500, contacts:15, assets:[], skill:"æ ¼æ–—äº‹ä»¶æˆåŠŸç‡+40%", goal:"å›½é™…æ­¦é¦†è¿é”", tag:"martial"},
  {name:"å…¬åŠ¡å‘˜", funds:6000, contacts:35, assets:[], skill:"æ”¿ç­–ä¿¡æ¯æå‰è·çŸ¥", goal:"æ™‹å‡ä¸ºå¸‚é•¿", tag:"official"},
  {name:"å‚é•¿", funds:17000, contacts:30, assets:["ä¸­å‹å·¥å‚"], skill:"ç”Ÿäº§æˆæœ¬-10%", goal:"å…¨å›½æœ€å¤§å·¥ä¸šä¼ä¸š", tag:"factory"},
  {name:"å¾‹å¸ˆ", funds:9000, contacts:20, assets:["å¾‹æ‰€"], skill:"æ‰“å®˜å¸èƒœç‡+25%", goal:"å…¨å›½çŸ¥åå¤§å¾‹å¸ˆ", tag:"lawyer"},
  {name:"ç§‘å­¦å®¶", funds:5000, contacts:15, assets:["å®éªŒå®¤"], skill:"ç ”å‘é€Ÿåº¦+20%", goal:"çªç ´æ€§å‘æ˜", tag:"scientist"},
  {name:"æ¼”å‘˜", funds:7000, contacts:25, assets:["å‰§ç»„å…³ç³»"], skill:"ç‰‡é…¬+15%", goal:"å›½é™…å½±å¸/å", tag:"actor"},
  {name:"èµ°ç§å•†", funds:10000, contacts:40, assets:[], skill:"èµ°ç§æˆåŠŸç‡+20%", goal:"æ§åˆ¶æ²¿æµ·èµ°ç§", tag:"smuggler"},
];

// ====== éš¾åº¦ï¼ˆå½±å“åˆ©ç‡/å¸‚åœº/äº‹ä»¶ï¼‰======
const difficultyProfiles = {
  easy:   { stockShift:+0.02, bizShift:+0.02, rateMul:0.8, badEventBias:-0.05 },
  normal: { stockShift:+0.00, bizShift:+0.00, rateMul:1.0, badEventBias:+0.00 },
  hard:   { stockShift:-0.02, bizShift:-0.02, rateMul:1.25, badEventBias:+0.06 },
};

// ====== äº‹ä¸šä½“ç›®å½•ï¼ˆæŒ‰æœˆï¼‰======
const ventureCatalog = [
  {id:"trade",  name:"è´¸æ˜“å…¬å¸",   cost:7000,  upkeep:450,  baseIncome:1100, risk:0.05, synergy:["trader"],   desc:"æ¥å¤–è´¸å•ï¼Œå—äººè„‰å½±å“"},
  {id:"factory",name:"å°å‹å·¥å‚",   cost:11000, upkeep:800,  baseIncome:1400, risk:0.045, synergy:["factory"],  desc:"ä»£å·¥/æ‰¿åŒ…ï¼Œç¨³å®šç°é‡‘æµ"},
  {id:"club",   name:"å¤œæ€»ä¼š",     cost:9000,  upkeep:1000, baseIncome:1700, risk:0.09, synergy:["mafia"],    desc:"é«˜æ”¶ç›Šé«˜é£é™©ï¼Œæ˜“è¢«ä¸´æ£€"},
  {id:"media",  name:"åª’ä½“å·¥ä½œå®¤", cost:6500,  upkeep:380,  baseIncome:900,  risk:0.05, synergy:["actor","idol"], desc:"å¹¿å‘Š/å®£ä¼ /ç»çºª"},
  {id:"law",    name:"å¾‹æ‰€æ‰©å¼ éƒ¨", cost:8000,  upkeep:520,  baseIncome:1200, risk:0.04, synergy:["lawyer"],  desc:"æ¥æ¡ˆé‡æå‡"},
  {id:"dev",    name:"åœ°äº§å¼€å‘éƒ¨", cost:13000, upkeep:1000, baseIncome:1800, risk:0.06, synergy:["realty"],  desc:"æ»šåŠ¨æ‹¿åœ°/æ—§æ”¹"},
  {id:"lab",    name:"ç§‘ç ”å·¥ä½œå®¤", cost:5500,  upkeep:420,  baseIncome:800,  risk:0.045, synergy:["scientist","student"], desc:"æŠ€æœ¯è½¬åŒ–/ä¸“åˆ©"},
  {id:"event",  name:"æ¼”å‡ºç»çºªéƒ¨", cost:8000,  upkeep:450,  baseIncome:1300, risk:0.07, synergy:["idol","actor"], desc:"å·¡æ¼”/å•†æ¼”"},
];
const synergyBoost = 0.20;

// ====== å¹´ä»£æ®µï¼ˆæŒ‰å¹´åˆ¤æ–­ï¼‰======
function currentEra(year){
  if(year<=1989) return {key:"80s", label:"80å¹´ä»£"};
  if(year<=1997) return {key:"90s", label:"90å¹´ä»£å‰æœŸ"};
  return {key:"late90s", label:"90å¹´ä»£åæœŸ"};
}

// ====== äº‹ä»¶æ± ï¼ˆæ”¹ä¸ºæœˆåº¦å°ºåº¦ï¼Œé‡‘é¢ç¼©å°ï¼‰======
const macroEvents = [
  {desc:"æ²¿æµ·æ¸¯å£å¼€æ”¾çº¢åˆ©ç»§ç»­é‡Šæ”¾", condition:null, effect:p=>{p.contacts+=2;}},
  {desc:"è‚¡å¸‚äººæ°”å›æš–", condition:null, effect:p=>{p.funds*=1.03;}},
  {desc:"è‚¡å¸‚æƒ…ç»ªä½è¿·", condition:null, effect:p=>{p.funds*=0.98;}},
  {desc:"æ±‡ç‡è°ƒæ•´åˆ©å¥½å‡ºå£", condition:p=>p.role.tag==="trader", effect:p=>{p.funds+=1200;}},
  {desc:"æˆ¿åœ°äº§è¯•ç‚¹æ¨è¿›", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("åŸåŒºå°åœ°å—");}},
  {desc:"åŸºå»ºå°å¹…åŠ ç ", condition:p=>p.role.tag==="factory", effect:p=>{p.funds+=1000;}},
  {desc:"æ³•å¾‹æœåŠ¡éœ€æ±‚æå‡", condition:p=>p.role.tag==="lawyer", effect:p=>{p.funds+=1200;}},
  {desc:"ç§‘ç ”ç»è´¹å¾®å¢", condition:p=>["scientist","student"].includes(p.role.tag), effect:p=>{p.funds+=800;}},
  {desc:"ä¸¥æ‰“é£å£°è¶‹ç´§", condition:p=>p.role.tag==="mafia", effect:p=>{p.contacts-=3;p.funds-=800;p.reputation-=2;}},
  {desc:"æ–‡å¨±å¸‚åœºå°æ—ºå­£", condition:p=>["actor","idol"].includes(p.role.tag), effect:p=>{p.funds+=1200;}},
  {desc:"èµ„é‡‘é¢åæ¾", condition:null, effect:p=>{p.contacts+=1;}},
  {desc:"æ²¹ä»·ä¸Šæ¶¨ä¼ å¯¼", condition:null, effect:p=>{p.funds-=600;}},
  {desc:"é‡‘ä»·èµ°å¼º", condition:null, effect:p=>{p.funds+=700;}},
  {desc:"æ—§æ”¹çª—å£å¼€å¯", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("æ—§æ”¹æŒ‡æ ‡(å°)");}},
  {desc:"é«˜æ ¡æ‰©æ‹›è¯•ç‚¹", condition:p=>p.role.tag==="student", effect:p=>{p.reputation+=2;}},
  {desc:"è´¸æ˜“æ‘©æ“¦å‡æ¸©", condition:p=>p.role.tag==="trader", effect:p=>{p.funds-=1000;}},
  {desc:"æ¼”å‡ºå®¡æ‰¹è¶‹ä¸¥", condition:p=>p.role.tag==="idol", effect:p=>{p.funds-=700;}},
  {desc:"ç§‘æŠ€ä¸‹ä¹¡è¯•ç‚¹", condition:p=>p.role.tag==="scientist", effect:p=>{p.contacts+=2;p.reputation+=2;}},
  {desc:"ç¨æ”¶ä¼˜æƒ è¯•ç‚¹", condition:null, effect:p=>{p.funds+=600;p.contacts+=1;}},
  {desc:"å¤œé—´æ²»å®‰ä¸ç¨³", condition:null, effect:p=>{p.funds-=500;}},
  {desc:"ä¸ªä½“ç»æµæ´»è·ƒ", condition:null, effect:p=>{p.funds+=500;}},
  {desc:"äººå£æµåŠ¨æ€§æå‡", condition:null, effect:p=>{p.contacts+=1;}},
  {desc:"çŸ¥è¯†åˆ†å­å—é‡è§†", condition:p=>["scientist","student","lawyer"].includes(p.role.tag), effect:p=>{p.reputation+=2;}},
  {desc:"ç»“æ±‡ä¾¿åˆ©åº¦æå‡", condition:p=>p.role.tag==="trader", effect:p=>{p.contacts+=1;}},
  {desc:"æ¸¯å£æ•´æ²»è¶‹ä¸¥", condition:p=>p.role.tag==="smuggler", effect:p=>{p.funds-=1200;p.reputation-=2;}},
];

const industryEvents = [
  {desc:"å·¥å‚è·å°é¢å¤–æ¥æŠ•èµ„", condition:p=>p.role.tag==="factory"||p.assets.includes("ä¸­å‹å·¥å‚"), effect:p=>{p.funds+=2500;p.contacts+=2;}},
  {desc:"è¿›å£è´§ä¸´æ£€å»¶è¯¯", condition:p=>p.role.tag==="trader", effect:p=>{p.funds-=1200;}},
  {desc:"å¤–è´¸è®¢å•å¢é•¿", condition:p=>p.role.tag==="trader", effect:p=>{p.funds+=2200;p.health-=3;}},
  {desc:"å·¥ç¨‹è´¨é‡è¿‡ç¡¬è·è¿½å•", condition:p=>p.assets.includes("ä¸­å‹å·¥å‚"), effect:p=>{p.funds+=1800;p.reputation+=1;}},
  {desc:"æ¼”å”±ä¼šçˆ†æ»¡", condition:p=>p.role.tag==="idol", effect:p=>{p.funds+=3000;p.reputation+=3;}},
  {desc:"ç”µå½±è·å¥–æ¶¨ç‰‡é…¬", condition:p=>p.role.tag==="actor", effect:p=>{p.funds+=2200;p.reputation+=2;}},
  {desc:"å½±ç‰‡æ‰‘è¡—", condition:p=>p.role.tag==="actor", effect:p=>{p.funds-=1800;p.reputation-=1;}},
  {desc:"å¤œåœºä¸´æ£€", condition:p=>p.role.tag==="mafia"||hasVenture("club"), effect:p=>{p.funds-=1500;}},
  {desc:"èµ°ç§é€šé“é¡ºç•…", condition:p=>p.role.tag==="smuggler", effect:p=>{p.funds+=2500;}},
  {desc:"é—¨é¢æ¶¨ç§Ÿ", condition:null, effect:p=>{p.funds-=600;}},
  {desc:"åœ°é“è§„åˆ’åˆ©å¥½å¸‚åŒºåœ°å—", condition:p=>p.assets.some(a=>a.includes("å¸‚åŒº")), effect:p=>{p.funds+=2000;}},
  {desc:"éƒŠåŒºåœ°å—è¢«å¾æ”¶è¡¥å¿", condition:p=>p.assets.some(a=>a.includes("éƒŠåŒº")), effect:p=>{p.funds+=1800;}},
  {desc:"æ‹¿ä¸‹å°æ—§æ”¹æŒ‡æ ‡", condition:p=>p.role.tag==="realty", effect:p=>{p.assets.push("æ—§æ”¹æŒ‡æ ‡(å°)");}},
  {desc:"å¾‹æ‰€å¤§æ¡ˆèµ¢é¢", condition:p=>p.role.tag==="lawyer"||hasVenture("law"), effect:p=>{p.funds+=2700;p.reputation+=3;}},
  {desc:"å®˜å¸å¤±åˆ©", condition:p=>p.role.tag==="lawyer"||hasVenture("law"), effect:p=>{p.funds-=1800;p.reputation-=2;}},
  {desc:"ä¸“åˆ©æˆæƒè½åœ°", condition:p=>p.role.tag==="scientist"||hasVenture("lab"), effect:p=>{p.funds+=3200;p.reputation+=3;}},
  {desc:"å®éªŒè®¾å¤‡æŸå", condition:p=>p.role.tag==="scientist"||hasVenture("lab"), effect:p=>{p.funds-=2200;}},
  {desc:"å­¦æœ¯ä¼šè®®æ‹“å±•åˆä½œ", condition:p=>["scientist","student"].includes(p.role.tag), effect:p=>{p.contacts+=3;}},
  {desc:"æ”¿åŠ¡è€ƒæ ¸ä¼˜ç§€", condition:p=>p.role.tag==="official", effect:p=>{p.contacts+=4;p.reputation+=3;}},
  {desc:"åŒåƒšå†…æ–—å—æŒ¤å‹", condition:p=>p.role.tag==="official", effect:p=>{p.contacts-=2;p.reputation-=2;}},
  {desc:"æœºå™¨æ•…éšœ", condition:p=>p.assets.includes("ä¸­å‹å·¥å‚")||hasVenture("factory"), effect:p=>{p.funds-=1500;}},
  {desc:"åœ°å—çº çº·è¯‰è®¼", condition:p=>p.role.tag==="realty", effect:p=>{p.funds-=1800;p.reputation-=1;}},
  {desc:"å•†ä¸šä»£è¨€åˆ°æ‰‹", condition:p=>p.role.tag==="idol"||hasVenture("event"), effect:p=>{p.funds+=1600;p.contacts+=1;}},
  {desc:"æ¼”å‡ºç§©åºå—æ‰°", condition:p=>p.role.tag==="idol"||hasVenture("event"), effect:p=>{p.funds-=900;}},
  {desc:"å¤œåœºçº çº·å‘é…µ", condition:p=>p.role.tag==="mafia"||hasVenture("club"), effect:p=>{p.reputation-=2;}},
];

const personalEvents = [
  {desc:"äº²æˆšå€Ÿæ¬¾", condition:null, effect:p=>{p.funds-=600;}},
  {desc:"æ‹¾é‡‘ä¸æ˜§ä¸ŠæŠ¥", condition:null, effect:p=>{p.contacts+=1;p.reputation+=1;}},
  {desc:"æ„å¤–å—ä¼¤", condition:null, effect:p=>{p.health-=5;}},
  {desc:"ä»‹ç»è®¤è¯†å®˜å‘˜", condition:null, effect:p=>{p.contacts+=2;}},
  {desc:"æ·»ç½®å©´å„¿ç”¨å“", condition:null, effect:p=>{p.funds-=500;}},
  {desc:"å°é¢é—äº§åˆ°è´¦", condition:null, effect:p=>{p.funds+=1000;}},
  {desc:"å®¶ä¸­å¤±çªƒ", condition:null, effect:p=>{p.funds-=800;}},
  {desc:"è¢«å·é’±åŒ…", condition:null, effect:p=>{p.funds-=300;}},
  {desc:"é‡æ„Ÿå†’", condition:null, effect:p=>{p.health-=3;}},
  {desc:"å°å¥–å½©ç¥¨", condition:null, effect:p=>{p.funds+=900;}},
  {desc:"æœ‹å‹é¡¹ç›®å¤±åˆ©", condition:null, effect:p=>{p.funds-=900;}},
  {desc:"æœ‹å‹è¿˜é’±", condition:null, effect:p=>{p.funds+=700;}},
  {desc:"è¡—å¤´æ•‘äºº", condition:null, effect:p=>{p.contacts+=1;p.reputation+=2;}},
  {desc:"é†‰é…’é£æ³¢", condition:null, effect:p=>{p.funds-=500;p.reputation-=2;}},
  {desc:"èµŒåœºå°èµ¢", condition:null, effect:p=>{p.funds+=700;}},
  {desc:"èµŒåœºå°è¾“", condition:null, effect:p=>{p.funds-=700;}},
  {desc:"æ·˜åˆ°å¤è‘£", condition:null, effect:p=>{p.assets.push("å¤è‘£");}},
  {desc:"è¯¯ä¹°èµå“", condition:null, effect:p=>{p.funds-=700;}},
  {desc:"æ—§ç–¾å¤å‘", condition:null, effect:p=>{p.health-=3;}},
  {desc:"å¿—æ„¿æ´»åŠ¨", condition:null, effect:p=>{p.contacts+=1;p.reputation+=2;}},
  {desc:"è¢«è¯¬å‘Šç»ˆæ¾„æ¸…", condition:null, effect:p=>{p.funds-=400;p.health-=2;p.reputation+=1;}},
  {desc:"é‚»é‡Œè°ƒè§£", condition:null, effect:p=>{p.reputation+=1;}},
  {desc:"ä¸ºä»–äººæ‹…ä¿", condition:null, effect:p=>{p.funds-=800;p.reputation-=1;}},
  {desc:"å¯Œè´µä¼ è¨€ç¼ èº«", condition:null, effect:p=>{p.contacts-=1;p.reputation-=1;}},
  {desc:"è€å‹å¸¦æ¥å•†æœº", condition:null, effect:p=>{p.contacts+=2;}},
];

// å¹´ä»£äº‹ä»¶
const eraEventPools = {
  "80s":[
    {desc:"ä¹¡é•‡ä¼ä¸šçƒ­æ½®å‡æ¸©", effect:p=>{p.funds+=600;}},
    {desc:"ä¸ªä½“æˆ·ç‰Œç…§æ›´æ˜“", effect:p=>{p.contacts+=1;}},
    {desc:"ç”µè§†å¹¿å‘Šèµ·æ­¥", effect:p=>{if(hasVenture("media")) p.funds+=500;}},
  ],
  "90s":[
    {desc:"è‚¡ä»½åˆ¶æ”¹é©è®¨è®ºå‡æ¸©", effect:p=>{p.funds+=700;}},
    {desc:"ç‰¹åŒºå¸å¼•åŠ›ä¸Šå‡", effect:p=>{p.contacts+=2;}},
    {desc:"åœ°äº§å¼€å‘å‡æ¸©", effect:p=>{if(hasVenture("dev")) p.funds+=900;}},
  ],
  "late90s":[
    {desc:"äº’è”ç½‘æ¦‚å¿µå†’å¤´", effect:p=>{if(hasVenture("media")) p.funds+=1000;p.reputation+=1;}},
    {desc:"æ¼”å‡ºå¸‚åœºå•†ä¸šåŒ–", effect:p=>{if(hasVenture("event")) p.funds+=900;}},
    {desc:"å¤œåœºé—¨æ§›æé«˜", effect:p=>{if(hasVenture("club")) p.funds-=600;}},
  ]
};

// ====== æ¸¸æˆçŠ¶æ€ ======
const SAVE_KEY="tgt_save_v2_monthly";
const game = {turn:1, year:1980, month:1, isOver:false, mood:0, chosenEventDone:false, diff:"normal"};
const player = {role:null,funds:0,contacts:0,reputation:10,health:100,assets:[],debt:[],apMax:2,ap:2, ventures:[]};

// ====== DOM & UI ======
const el = sel => document.querySelector(sel);
const logBox = el("#log");
function log(text, cls=""){ const li=document.createElement("li"); li.innerHTML=text; if(cls) li.classList.add(cls); logBox.prepend(li); const children = logBox.querySelectorAll("li"); if(children.length>30) children[children.length-1].remove(); }
function fmtMoney(v){ return "Â¥"+Math.round(v).toLocaleString(); }
function ymStr(){ return `${game.year}-${String(game.month).padStart(2,'0')}`; }

function refreshVentureUI(){
  const cat = el("#ventureCatalog");
  cat.innerHTML = ventureCatalog.map(v=>`<option value="${v.id}">${v.name}ï¼ˆé¦–æœŸ${fmtMoney(v.cost)}ï½œç»´æŠ¤${fmtMoney(v.upkeep)}ï½œåŸºäº§${fmtMoney(v.baseIncome)}ï¼‰</option>`).join("");
  const own = el("#ownedVenture");
  if(player.ventures.length===0){ own.innerHTML = `<option value="">æ— äº‹ä¸š</option>`; }
  else{
    own.innerHTML = player.ventures.map((v,i)=>`<option value="${i}">${v.name} Lv.${v.level}${v.paused?"ï¼ˆæš‚åœï¼‰":""}</option>`).join("");
  }
}
function refresh(){
  const eraObj = currentEra(game.year);
  const diffName = {easy:"å®½ä¿¡ç”¨",normal:"æ­£å¸¸",hard:"ç´§ä¿¡ç”¨"}[game.diff];
  el("#ym").textContent = ymStr();
  el("#era").textContent = eraObj.label;
  el("#difficulty").textContent = `éš¾åº¦ï¼š${diffName}`;
  el("#funds").textContent = fmtMoney(player.funds);
  el("#contacts").textContent = Math.round(player.contacts);
  el("#rep").textContent = Math.round(player.reputation);
  el("#hp").textContent = Math.round(player.health);
  el("#roleName").textContent = player.role?player.role.name:"â€”";
  el("#roleSkill").textContent = player.role?player.role.skill:"â€”";
  el("#roleGoal").textContent = player.role?player.role.goal:"â€”";
  el("#assetList").textContent = player.assets.length?player.assets.join("ï¼Œ"):"â€”";
  el("#debtList").textContent = player.debt.length?player.debt.map((d,i)=>`${i+1}.${d.source}@${Math.round(d.annual*100)}%å¹´åŒ–:${fmtMoney(d.amount)}(èµ·${d.startY}-${String(d.startM).padStart(2,'0')})`).join("ï¼›"):"â€”";
  el("#apInfo").textContent = `AP ${player.ap}/${player.apMax}`;
  el("#ventureList").textContent = player.ventures.length
    ? player.ventures.map(v=>`${v.name} Lv.${v.level}${v.paused?"(åœ)":""} â†‘${fmtMoney(ventureIncomePreview(v))}/æœˆ`).join("ï¼› ")
    : "â€”";
  el("#vict").textContent = victoryHint();
  el("#btnNext").disabled = !player.role || game.isOver || !game.chosenEventDone;
  refreshVentureUI();
  // äº‹ä»¶æŠ‰æ‹©åŒºå¯è§æ€§
  el("#eventChoices").classList.toggle("active", !game.chosenEventDone && !!player.role && !game.isOver);
}
function needAP(n=1){ if(player.ap<n){ log("è¡ŒåŠ¨åŠ›ä¸è¶³ï¼Œæœ¬æœˆæ— æ³•å†è¡ŒåŠ¨","warn"); return false;} player.ap-=n; refresh(); return true;}
function hasVenture(id){ return player.ventures.some(v=>v.id===id); }

// ====== åˆå§‹è§’è‰² UI ======
const roleGrid = el("#roleGrid");
let chosenIndex = null;
function renderRoles(){
  roleGrid.innerHTML = "";
  roles.forEach((r,idx)=>{
    const div = document.createElement("div");
    div.className="role";
    div.innerHTML = `<b>${r.name}</b><span class="tag pill">${r.tag}</span><div class="footnote">${r.skill}</div><div class="footnote">ç›®æ ‡ï¼š${r.goal}</div>`;
    div.onclick = ()=>{
      chosenIndex = idx;
      [...roleGrid.children].forEach(c=>c.classList.remove("active"));
      div.classList.add("active");
    };
    roleGrid.appendChild(div);
  });
}
renderRoles();

// ====== å­˜æ¡£/è¯»æ¡£/æ–°å¼€å±€ ======
function snapshot(){ return JSON.stringify({game, player, chosenIndex}); }
function loadFrom(obj){ Object.assign(game, obj.game); Object.assign(player, obj.player); chosenIndex = obj.chosenIndex ?? null; }
function save(){ localStorage.setItem(SAVE_KEY, snapshot()); el("#saveTip").textContent = `å·²å­˜æ¡£ï¼š${ymStr()}`; log("å­˜æ¡£æˆåŠŸ","good"); }
function load(){
  const raw = localStorage.getItem(SAVE_KEY);
  if(!raw){ log("æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£","warn"); return; }
  try{
    const data = JSON.parse(raw);
    loadFrom(data);
    el("#roleSection").hidden = !!player.role;
    log("è¯»æ¡£æˆåŠŸ","good");
    refresh();
  }catch(e){ log("è¯»æ¡£å¤±è´¥","bad"); }
}
function resetGame(){
  localStorage.removeItem(SAVE_KEY);
  Object.assign(game,{turn:1,year:1980,month:1,isOver:false,mood:0,chosenEventDone:false,diff:"normal"});
  Object.assign(player,{role:null,funds:0,contacts:0,reputation:10,health:100,assets:[],debt:[],apMax:2,ap:2,ventures:[]});
  chosenIndex = null;
  el("#roleSection").hidden = false;
  el("#saveTip").textContent = "æœªå­˜æ¡£";
  log("å·²é‡ç½®ä¸ºæ–°å¼€å±€","warn");
  refresh();
}
el("#btnSave").onclick = save;
el("#btnLoad").onclick = load;
el("#btnReset").onclick = resetGame;

// ====== å¼€å§‹æ¸¸æˆ ======
el("#btnStart").onclick = ()=>{
  if(chosenIndex==null){ log("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèº«ä»½","warn"); return; }
  const r = roles[chosenIndex];
  const diff = el("#diffSelect").value;
  player.role = r;
  player.funds = r.funds;
  player.contacts = r.contacts;
  player.assets = [...r.assets];
  player.reputation = 10;
  player.health = 100;
  player.debt = [];
  player.ventures = [];
  Object.assign(game,{turn:1,year:1980,month:1,isOver:false,mood:0,chosenEventDone:false,diff});
  player.apMax=2; player.ap=player.apMax;
  log(`ä½ é€‰æ‹©äº†ã€${r.name}ã€‘ï½œéš¾åº¦ã€${{easy:"å®½ä¿¡ç”¨",normal:"æ­£å¸¸",hard:"ç´§ä¿¡ç”¨"}[diff]}ã€‘`,"good");
  el("#roleSection").hidden = true;
  // ç”Ÿæˆæœ¬æœˆæŠ‰æ‹©
  generateMonthChoices();
  refresh();
};

// ====== æœˆåº¦æ¨è¿› ======
function stepMonth(){
  game.turn++;
  game.month++;
  if(game.month>12){ game.month=1; game.year++; }
}
function settleVentures(){
  if(player.ventures.length===0) return 0;
  let total = 0;
  player.ventures.forEach(v=>{
    if(v.paused) return; // æš‚åœä¸äº§å‡ºã€ä¸ç»´æŠ¤ã€æ— äº‹æ•…
    const income = ventureIncomePreview(v);
    if(Math.random()<v.risk){ const loss = rndi(300, 1500); total += (income - loss); log(`äº‹ä¸šäº‹æ•…ï¼š${v.name} æŸå¤± ${fmtMoney(loss)}`,"bad"); }
    else total += income;
  });
  player.funds += total;
  if(total!==0) log(`äº‹ä¸šä½“ç»“ç®—ï¼šæœ¬æœˆå‡€æ”¶ç›Š ${fmtMoney(total)}`, total>=0?"good":"bad");
  return total;
}

// æƒ…ç»ªå½±å“ï¼ˆè‚¡å¸‚æ³¢åŠ¨ä¸­æ¢ï¼‰ï¼Œéš¾åº¦ä¹Ÿå½±å“
function shiftMood(){ game.mood = clamp(game.mood + rndi(-1,1), -2, 2); }

// ç”Ÿæˆå½“æœˆäº‹ä»¶æŠ‰æ‹©ï¼ˆä¸‰é€‰ä¸€ï¼‰
function generateMonthChoices(){
  const candidates = [];
  // æŒ‰éš¾åº¦ç»™ä¸€ç‚¹â€œå¥½/åâ€å€¾å‘
  const bias = difficultyProfiles[game.diff]?.badEventBias || 0;
  const pools = [macroEvents, industryEvents, personalEvents];
  while(candidates.length<3){
    const pool = pick(pools);
    // æ¡ä»¶è¿‡æ»¤
    let list = pool.filter(e=>!e.condition || e.condition(player));
    if(!list.length) list = pool;
    let ev = pick(list);
    // ç®€å•é¿å…é‡å¤æè¿°
    if(!candidates.find(c=>c.desc===ev.desc)){
      candidates.push(ev);
    }
  }
  // è½»å¾®æ‰“åˆ†æ’åºï¼ˆæŠŠâ€œå¯èƒ½è¾ƒå·®â€çš„é åï¼‰
  if(bias>0) candidates.sort((a,b)=>Math.random()+0.2-0.4); // ç´§ä¿¡ç”¨éšæœºæ›´åå
  const wrap = el("#choicesWrap");
  wrap.innerHTML = "";
  candidates.forEach((ev,idx)=>{
    const div = document.createElement("div");
    div.className="choice";
    div.innerHTML = `<b>é€‰é¡¹ ${idx+1}</b>ï¼š${ev.desc}`;
    div.onclick = ()=>{
      ev.effect(player);
      log(`ä½ é€‰æ‹©äº†äº‹ä»¶ï¼š${ev.desc}`,"warn");
      game.chosenEventDone = true;
      refresh();
    };
    wrap.appendChild(div);
  });
}

// å¹´ä»£äº‹ä»¶ï¼ˆè‡ªåŠ¨ +1ï¼‰
function triggerEraEvent(){
  const eraKey = currentEra(game.year).key;
  const eraPool = eraEventPools[eraKey];
  if(eraPool && eraPool.length){
    const e = pick(eraPool);
    e.effect(player);
    log(`ã€å¹´ä»£ã€‘${e.desc}`,"warn");
  }
}

function endOfMonth(){
  // æ¢å¤ & è¶‹åŠ¿
  player.health = clamp(player.health + 1, 0, 120);
  shiftMood();
  // å€ºåŠ¡æŒ‰æœˆè®¡æ¯
  player.debt.forEach(d=>{
    d.amount = Math.round(d.amount*(1+d.monthly));
  });
  // å¤±è´¥/èƒœåˆ©
  if(player.health<=0){ game.isOver=true; log("ä½ å› å¥åº·é—®é¢˜å»ä¸–ï¼Œæ¸¸æˆç»“æŸ","bad"); }
  if(player.funds< -5000 && player.assets.length===0){ game.isOver=true; log("ä½ èµ„ä¸æŠµå€ºä¸”æ— èµ„äº§ï¼Œç ´äº§ Game Over","bad"); }
  if(checkVictory()){ game.isOver=true; log("ä½ å·²è¾¾æˆèº«ä»½ç›®æ ‡ï¼æ­å–œé€šå…³ã€Šå¤§æ—¶ä»£ã€‹","good"); }
}

function nextTurn(){
  if(!player.role){ log("è¯·å…ˆé€‰æ‹©èº«ä»½å¹¶å¼€å§‹æ¸¸æˆ","warn"); return; }
  if(game.isOver){ log("æ¸¸æˆå·²ç»“æŸï¼Œè¯·è¯»æ¡£æˆ–æ–°å¼€å±€","warn"); return; }
  if(!game.chosenEventDone){ log("è¯·å…ˆä»æœ¬æœˆäº‹ä»¶ä¸­é€‰æ‹© 1 æ¡","warn"); return; }

  // AP é‡ç½®
  player.ap = player.apMax;

  // å…ˆç»“ç®—äº‹ä¸šä½“
  settleVentures();

  // è§¦å‘å¹´ä»£åŠ æˆ
  triggerEraEvent();

  // è¿›å…¥ä¸‹æœˆ
  stepMonth();

  // æœ¬æœˆéœ€è¦é‡æ–°é€‰æ‹©äº‹ä»¶
  game.chosenEventDone = false;
  generateMonthChoices();

  // ç»“æŸæœˆåº¦é€šç”¨ç»“ç®—
  endOfMonth();

  refresh();
}
el("#btnNext").onclick = nextTurn;

// ====== èƒœåˆ©æ¡ä»¶ï¼ˆä¸ä¹‹å‰ä¸€è‡´ï¼‰======
function checkVictory(){
  const f = player.funds, c = player.contacts, r = player.reputation;
  const has = name => player.assets.some(a=>a.includes(name));
  switch(player.role.tag){
    case "student": return r>=30 && c>=20 && (has("å®éªŒå®¤")||f>=50000);
    case "trader":  return f>=1000000/10 || hasVenture("trade") && player.ventures.find(v=>v.id==="trade")?.level>=3;
    case "mafia":   return c>=120 && r>=25 && (hasVenture("club")||player.assets.some(a=>/å¤œ/.test(a)));
    case "realty":  return player.assets.filter(a=>a.includes("åœ°å—")).length>=4 && f>=300000/10 || hasVenture("dev")&&player.ventures.find(v=>v.id==="dev")?.level>=3;
    case "idol":    return c>=80 && r>=60 && (hasVenture("event")||hasVenture("media"));
    case "martial": return c>=70 && r>=50;
    case "official":return r>=70 && c>=90;
    case "factory": return f>=500000/10 && (has("ä¸­å‹å·¥å‚")||hasVenture("factory"));
    case "lawyer":  return f>=300000/10 && r>=60 && (hasVenture("law"));
    case "scientist":return r>=75 && (f>=200000/10 || hasVenture("lab"));
    case "actor":   return r>=70 && c>=80 && (hasVenture("media")||hasVenture("event"));
    case "smuggler":return f>=500000/10 && c>=80;
  }
  return false;
}
function victoryHint(){ if(!player.role) return "â€”"; return checkVictory() ? "âœ… å·²æ»¡è¶³" : "â³ å°šæœªæ»¡è¶³ï¼Œç»§ç»­åŠªåŠ›"; }

// ====== è¡ŒåŠ¨å®ç°ï¼ˆæŒ‰æœˆï¼‰======
function consumeHealth(base=2){ player.health = clamp(player.health - base, 0, 120); }

// ä¼‘æ•´
el("#btnRest").onclick = ()=>{
  if(!needAP(1)) return;
  const gain = 6 + (player.role.tag==="scientist"?1:0);
  player.health = clamp(player.health + gain, 0, 120);
  log(`ä¼‘æ•´æ¢å¤å¥åº· +${gain}`,"good");
  refresh();
};

// åšç”Ÿæ„ï¼ˆæŒ‰æœˆ ROIï¼‰
el("#btnBiz").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#bizAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("åšç”Ÿæ„æŠ•å…¥é‡‘é¢éæ³•æˆ–ä¸è¶³","warn"); return; }
  player.funds -= amt;
  const diff = difficultyProfiles[game.diff]||difficultyProfiles.normal;
  let roi = rnd(-0.08+diff.bizShift, 0.20+diff.bizShift) + (player.reputation*0.001 + player.contacts*0.0005);
  if(player.role.tag==="factory") roi += 0.02;
  const profit = Math.round(amt * roi);
  player.funds += amt + profit;
  player.reputation += profit>0 ? 1 : -1;
  consumeHealth(2);
  log(`åšç”Ÿæ„${profit>=0?"ç›ˆåˆ©":"äºæŸ"}ï¼š${profit>=0?"+":""}${fmtMoney(profit)}ï¼ˆROI ${(roi*100).toFixed(1)}%ï¼‰`, profit>=0?"good":"bad");
  refresh();
};

// ç‚’è‚¡ï¼ˆæŒ‰æœˆæ³¢åŠ¨ï¼‰
el("#btnStock").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#stockAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("ç‚’è‚¡é‡‘é¢éæ³•æˆ–ä¸è¶³","warn"); return; }
  player.funds -= amt;
  const diff = difficultyProfiles[game.diff]||difficultyProfiles.normal;
  let base = { "-2":[-0.12,0.08], "-1":[-0.10,0.12], "0":[-0.10,0.15], "1":[-0.06,0.18], "2":[-0.04,0.20] }[String(game.mood)];
  let roi = rnd(base[0]+diff.stockShift, base[1]+diff.stockShift);
  const profit = Math.round(amt*roi);
  player.funds += amt + profit;
  player.reputation += profit>0 ? 1 : 0;
  consumeHealth(1);
  log(`ç‚’è‚¡${profit>=0?"ç›ˆåˆ©":"äºæŸ"}ï¼š${profit>=0?"+":""}${fmtMoney(profit)}ï¼ˆå¸‚åœºæƒ…ç»ª ${game.mood>=0?"+":""}${game.mood}ï¼‰`, profit>=0?"good":"bad");
  refresh();
};

// èµŒåš
el("#btnGamble").onclick = ()=>{
  if(!needAP(1)) return;
  const amt = +el("#gambleAmt").value||0;
  if(amt<=0 || amt>player.funds){ log("èµŒæ³¨éæ³•æˆ–ä¸è¶³","warn"); return; }
  let winRate = 0.45;
  if(player.role.tag==="mafia") winRate += 0.1;
  const win = Math.random()<winRate;
  const mult = win ? rnd(0.4,1.0) : -rnd(0.3,0.9);
  const delta = Math.round(amt*mult);
  player.funds += delta;
  player.reputation += win?1:-2;
  consumeHealth(3);
  log(`èµŒåš${win?"èµ¢äº†":"è¾“äº†"}ï¼š${delta>=0?"+":""}${fmtMoney(delta)}ï¼ˆèƒœç‡â‰ˆ${Math.round(winRate*100)}%ï¼‰`, delta>=0?"good":"bad");
  refresh();
};

// ä¹°åœ°çš®
el("#btnBuyLand").onclick = ()=>{
  if(!needAP(1)) return;
  const [name,priceStr] = el("#landType").value.split("|");
  const price = +priceStr;
  const final = Math.round(price * (player.role.tag==="realty"?0.85:1));
  if(player.funds<final){ log("èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•ä¹°åœ°çš®","warn"); return; }
  player.funds -= final;
  player.assets.push(name);
  player.reputation += 1;
  log(`è´­å…¥èµ„äº§ï¼š${name}ï¼ˆèŠ±è´¹ ${fmtMoney(final)}ï¼‰`,"good");
  refresh();
};

// å–èµ„äº§
el("#btnSellAsset").onclick = ()=>{
  if(!needAP(1)) return;
  if(player.assets.length===0){ log("æ²¡æœ‰å¯å‡ºå”®çš„èµ„äº§","warn"); return; }
  const priceOf = name=>{
    if(name.includes("å¸‚åŒº")) return rndi(14000,24000);
    if(name.includes("éƒŠåŒº")) return rndi(5000,12000);
    if(name.includes("ä¸­å‹å·¥å‚")) return rndi(16000,30000);
    if(name.includes("å¤è‘£")) return rndi(2500,9000);
    return rndi(2000,7000);
  };
  const asset = player.assets.pop();
  const val = priceOf(asset);
  player.funds += val;
  log(`å‡ºå”®èµ„äº§ï¼š${asset}ï¼Œè·å¾— ${fmtMoney(val)}`,"good");
  refresh();
};

// è¿›ä¿®/è€ƒè¯•
el("#btnStudy").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 600;
  if(player.funds<cost){ log("è¿›ä¿®éœ€è¦èµ„é‡‘ä¸è¶³","warn"); return; }
  player.funds -= cost;
  let repGain = 3, contGain = 1;
  if(["student","scientist","lawyer"].includes(player.role.tag)) repGain += 1;
  player.reputation += repGain;
  player.contacts += contGain;
  consumeHealth(1);
  log(`è¿›ä¿®ï¼šå£°æœ› +${repGain}ï¼Œäººè„‰ +${contGain}ï¼ˆå­¦è´¹ ${fmtMoney(cost)}ï¼‰`,"good");
  refresh();
};

// äººè„‰æ´»åŠ¨
el("#btnSocial").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 500;
  if(player.funds<cost){ log("è¯·å®¢é€ç¤¼éœ€è¦èµ„é‡‘ä¸è¶³","warn"); return; }
  player.funds -= cost;
  let contGain = rndi(2,5);
  if(player.role.tag==="official") contGain+=2;
  player.contacts += contGain;
  player.reputation += 1;
  consumeHealth(1);
  log(`äººè„‰ï¼šäººè„‰ +${contGain}ï¼ˆèŠ±è´¹ ${fmtMoney(cost)}ï¼‰`,"good");
  refresh();
};

// ä»æ”¿
el("#btnPolitics").onclick = ()=>{
  if(!needAP(1)) return;
  const cost = 800;
  if(player.funds<cost){ log("ä»æ”¿éœ€è¦ç»è´¹ä¸è¶³","warn"); return; }
  player.funds -= cost;
  let rep = rndi(1,4), cont = rndi(1,4);
  if(player.role.tag==="official"){ rep+=2; cont+=2; }
  player.reputation += rep; player.contacts += cont;
  consumeHealth(2);
  log(`ä»æ”¿ï¼šå£°æœ› +${rep}ï¼Œäººè„‰ +${cont}ï¼ˆè´¹ç”¨ ${fmtMoney(cost)}ï¼‰`,"good");
  refresh();
};

// å€Ÿæ¬¾ï¼ˆæŒ‰æœˆè®¡æ¯ï¼‰
el("#btnBorrow").onclick = ()=>{
  if(!needAP(1)) return;
  const src = el("#loanSrc").value;
  const amt = +el("#loanAmt").value||0;
  if(amt<=0){ log("å€Ÿæ¬¾é‡‘é¢éœ€å¤§äº 0","warn"); return; }
  if(player.assets.length===0){ log("ç¼ºå°‘æŠµæŠ¼èµ„äº§ï¼Œæ— æ³•å€Ÿæ¬¾","warn"); return; }
  const annual = src==="bank"?0.05:src==="private"?0.12:0.20;
  const monthly = (annual * (difficultyProfiles[game.diff]?.rateMul||1))/12;
  player.funds += amt;
  player.debt.push({amount:amt,annual,monthly,source:src,startY:game.year,startM:game.month,collateral:player.assets[0]});
  log(`å€Ÿæ¬¾æˆåŠŸï¼šæ¥æº ${src}ï¼Œé‡‘é¢ ${fmtMoney(amt)}ï¼Œæœˆæ¯ ${(monthly*100).toFixed(2)}%ï¼ˆå¹´åŒ–${Math.round(annual*100)}%ï½œæŠµæŠ¼ï¼š${player.assets[0]}ï¼‰`,"warn");
  refresh();
};

// è¿˜è´·ï¼ˆä¼˜å…ˆæœ€æ—©ä¸€ç¬”ï¼‰
el("#btnRepay").onclick = ()=>{
  if(player.debt.length===0){ log("å½“å‰æ— è´Ÿå€º","warn"); return; }
  const d = player.debt[0];
  const total = Math.round(d.amount);
  if(player.funds<total){ log(`èµ„é‡‘ä¸è¶³ä»¥å¿è¿˜é¦–ç¬”å€ºåŠ¡ï¼šéœ€ ${fmtMoney(total)}`,"warn"); return; }
  player.funds -= total;
  player.debt.shift();
  log(`å·²å½’è¿˜å€ºåŠ¡ ${fmtMoney(total)}ï¼ˆæ¥æº ${d.source}ï¼‰`,"good");
  refresh();
};

// ====== äº‹ä¸šä½“ï¼šæ”¶ç›Šã€å¼€åŠã€å‡çº§ã€æš‚åœ/æ¢å¤ã€è½¬è®© ======
function ventureIncomePreview(v){
  const syn = v.synergy.includes(player.role?.tag) ? (1+synergyBoost) : 1;
  const scale = 1 + 0.5*(v.level-1);
  const soft = 1 + clamp(player.contacts*0.0006 + player.reputation*0.0003, -0.15, 0.3);
  return Math.max(0, Math.round(v.baseIncome*scale*syn*soft) - v.upkeep);
}
el("#btnStartVenture").onclick = ()=>{
  if(!needAP(1)) return;
  const id = el("#ventureCatalog").value;
  const tpl = ventureCatalog.find(v=>v.id===id);
  if(!tpl) return;
  if(player.funds<tpl.cost){ log("èµ„é‡‘ä¸è¶³ï¼Œæ— æ³•å¼€åŠè¯¥äº‹ä¸š","warn"); return; }
  if(player.ventures.some(v=>v.id===id)){ log("è¯¥äº‹ä¸šå·²æ‹¥æœ‰ï¼Œå¯è€ƒè™‘å‡çº§","warn"); return; }
  player.funds -= tpl.cost;
  player.ventures.push({id:tpl.id,name:tpl.name,level:1,baseIncome:tpl.baseIncome,upkeep:tpl.upkeep,risk:tpl.risk,synergy:tpl.synergy,paused:false});
  log(`å¼€åŠäº‹ä¸šï¼š${tpl.name}ï¼ˆé¦–æœŸ ${fmtMoney(tpl.cost)}ï¼‰`,"good");
  refresh();
};
el("#btnUpgradeVenture").onclick = ()=>{
  if(!needAP(1)) return;
  if(player.ventures.length===0){ log("æš‚æ— å¯å‡çº§äº‹ä¸š","warn"); return; }
  const idx = +el("#ownedVenture").value;
  if(isNaN(idx) || idx<0 || idx>=player.ventures.length){ log("è¯·é€‰æ‹©è¦å‡çº§çš„äº‹ä¸š","warn"); return; }
  const v = player.ventures[idx];
  const baseCost = ventureCatalog.find(t=>t.id===v.id)?.cost || 7000;
  const upgCost = Math.round(baseCost*0.45*v.level);
  if(player.funds<upgCost){ log(`èµ„é‡‘ä¸è¶³ï¼Œå‡çº§éœ€è¦ ${fmtMoney(upgCost)}`,"warn"); return; }
  player.funds -= upgCost;
  v.level += 1;
  v.upkeep = Math.round(v.upkeep*(1+0.12));
  log(`å‡çº§äº‹ä¸šï¼š${v.name} â†’ Lv.${v.level}ï¼ˆèŠ±è´¹ ${fmtMoney(upgCost)}ï¼‰`,"good");
  refresh();
};
el("#btnToggleVenture").onclick = ()=>{
  if(player.ventures.length===0){ log("æš‚æ— äº‹ä¸šå¯æ“ä½œ","warn"); return; }
  const idx = +el("#ownedVenture").value;
  const v = player.ventures[idx]; if(!v){ log("è¯·é€‰æ‹©ä¸€ä¸ªäº‹ä¸š","warn"); return; }
  v.paused = !v.paused;
  log(`${v.paused?"æš‚åœ":"æ¢å¤"}äº‹ä¸šï¼š${v.name}`);
  refresh();
};
el("#btnSellVenture").onclick = ()=>{
  if(player.ventures.length===0){ log("æš‚æ— äº‹ä¸šå¯è½¬è®©","warn"); return; }
  const idx = +el("#ownedVenture").value;
  const v = player.ventures[idx]; if(!v){ log("è¯·é€‰æ‹©ä¸€ä¸ªäº‹ä¸š","warn"); return; }
  // è½¬è®©ä»·æ ¼ï¼šæœ€è¿‘å‡€äº§å‡º * 8 ~ 12 + åŸºç¡€å›æœ¬æŠ˜ä»·
  const tpl = ventureCatalog.find(t=>t.id===v.id);
  const preview = Math.max(0, ventureIncomePreview(v));
  const price = Math.round(preview * rndi(8,12) + (tpl.cost*0.4));
  player.funds += price;
  player.ventures.splice(idx,1);
  log(`è½¬è®©äº‹ä¸šï¼š${v.name}ï¼Œè·å¾— ${fmtMoney(price)}`,"good");
  refresh();
};

// ====== äº‹ä»¶æŠ‰æ‹©ç”Ÿæˆ & å…¥å£ ======
function init(){
  refresh();
  refreshVentureUI();
}
init();

// ====== é€‰æ‹©åŒºå®¹å™¨ & æŒ‚è½½ ======
function hasCondition(ev){ return !ev.condition || ev.condition(player); }

// ä¸‹ä¸€æœˆæŒ‰é’®
// ï¼ˆå·²ç»åœ¨ä¸Šæ–¹ç»‘å®šï¼‰
// äº‹ä»¶åŒºåœ¨æ¯æœˆå¼€å§‹å·²ç”Ÿæˆï¼Œå¿…é¡»å…ˆé€‰ä¸­ä¸€ä¸ªæ‰å¯â€œè¿›å…¥ä¸‹æœˆâ€
</script>
</body>
</html>
